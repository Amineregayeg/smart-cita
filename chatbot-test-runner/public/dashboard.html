<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaserOstop - Test Dashboard</title>
  <style>
    :root {
      --primary: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 20px;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1::before {
      content: 'üî¨';
    }

    .status-bar {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .status-dot.running {
      background: var(--warning);
      animation: pulse 1s infinite;
    }

    .status-dot.error {
      background: var(--error);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 0.875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }

    .metric {
      font-size: 2.5rem;
      font-weight: 700;
    }

    .metric.success { color: var(--success); }
    .metric.warning { color: var(--warning); }
    .metric.error { color: var(--error); }

    .metric-label {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .progress-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    button.primary {
      background: var(--primary);
      color: white;
    }

    button.primary:hover {
      background: #1d4ed8;
    }

    button.secondary {
      background: var(--border);
      color: var(--text);
    }

    button.secondary:hover {
      background: #cbd5e1;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
    }

    .results-table th,
    .results-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .results-table th {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge.pass { background: #d1fae5; color: #065f46; }
    .badge.fail { background: #fee2e2; color: #991b1b; }
    .badge.error { background: #fef3c7; color: #92400e; }

    .chart-container {
      height: 200px;
      margin-top: 20px;
    }

    .alerts-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .alert-item {
      padding: 12px;
      border-left: 4px solid var(--error);
      background: #fef2f2;
      margin-bottom: 10px;
      border-radius: 0 8px 8px 0;
    }

    .alert-item .time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .suite-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }

    .suite-card {
      padding: 15px;
      background: var(--bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .suite-card h3 {
      font-size: 0.875rem;
      margin-bottom: 8px;
    }

    .suite-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
    }

    .refresh-info {
      text-align: center;
      padding: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>LaserOstop Chatbot Test Dashboard</h1>
      <div class="status-bar">
        <span class="status-indicator">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Conectando...</span>
        </span>
        <span id="lastUpdate">√öltima actualizaci√≥n: --</span>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Key Metrics -->
    <div class="grid">
      <div class="card">
        <h2>Tasa de √âxito</h2>
        <div class="metric" id="passRate">--</div>
        <div class="metric-label">√öltimo test run</div>
        <div class="progress-bar">
          <div class="progress-fill" id="passRateBar" style="width: 0%"></div>
        </div>
      </div>

      <div class="card">
        <h2>Tests Ejecutados</h2>
        <div class="metric" id="totalTests">--</div>
        <div class="metric-label">
          <span id="passedCount">--</span> pasados /
          <span id="failedCount">--</span> fallidos
        </div>
      </div>

      <div class="card">
        <h2>Tiempo Promedio</h2>
        <div class="metric" id="avgTime">--</div>
        <div class="metric-label">milisegundos por test</div>
      </div>

      <div class="card">
        <h2>√öltimo Run</h2>
        <div class="metric" id="lastRunTime" style="font-size: 1.5rem;">--</div>
        <div class="metric-label" id="lastRunType">--</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card" style="margin-bottom: 20px;">
      <h2>Acciones</h2>
      <div class="actions">
        <button class="primary" id="runFullBtn" onclick="runTests('full')">
          ‚ñ∂Ô∏è Ejecutar Todos los Tests
        </button>
        <button class="secondary" id="runSmokeBtn" onclick="runTests('smoke')">
          ‚ö° Smoke Tests
        </button>
        <button class="secondary" id="runCriticalBtn" onclick="runTests('critical')">
          üî• Tests Cr√≠ticos
        </button>
        <button class="secondary" onclick="runCleanup()">
          üßπ Limpiar Datos de Test
        </button>
      </div>
      <div id="runProgress" class="hidden" style="margin-top: 15px;">
        <div class="progress-bar">
          <div class="progress-fill" id="runProgressBar" style="width: 0%"></div>
        </div>
        <div class="metric-label" style="margin-top: 5px;">
          Ejecutando: <span id="currentSuite">--</span>
        </div>
      </div>
    </div>

    <!-- Suite Results -->
    <div class="card" style="margin-bottom: 20px;">
      <h2>Resultados por Suite</h2>
      <div class="suite-grid" id="suiteGrid">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Alerts -->
    <div class="card" style="margin-bottom: 20px;">
      <h2>
        Alertas
        <button class="secondary" style="float: right; padding: 5px 10px;" onclick="clearAlerts()">
          Limpiar
        </button>
      </h2>
      <div class="alerts-list" id="alertsList">
        <p style="color: var(--text-muted); text-align: center; padding: 20px;">
          No hay alertas pendientes
        </p>
      </div>
    </div>

    <!-- Test Details -->
    <div class="card">
      <h2>Detalle de Tests</h2>
      <table class="results-table" id="resultsTable">
        <thead>
          <tr>
            <th>Test ID</th>
            <th>Estado</th>
            <th>Duraci√≥n</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
          <tr>
            <td colspan="4" style="text-align: center; color: var(--text-muted);">
              Cargando resultados...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="refresh-info">
      Auto-actualizaci√≥n cada 30 segundos
    </div>
  </div>

  <script>
    // State
    let isRunning = false;

    // Update dashboard data
    async function updateDashboard() {
      try {
        // Get status
        const statusRes = await fetch('/api/status');
        const status = await statusRes.json();
        updateStatus(status);

        // Get results
        const resultsRes = await fetch('/api/results/latest');
        const { summary, results } = await resultsRes.json();
        updateResults(summary, results);

        // Get alerts
        const alertsRes = await fetch('/api/alerts');
        const { alerts } = await alertsRes.json();
        updateAlerts(alerts);

        document.getElementById('lastUpdate').textContent =
          '√öltima actualizaci√≥n: ' + new Date().toLocaleTimeString('es-ES');

      } catch (error) {
        console.error('Error updating dashboard:', error);
        document.getElementById('statusText').textContent = 'Error de conexi√≥n';
        document.getElementById('statusDot').className = 'status-dot error';
      }
    }

    function updateStatus(status) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');

      isRunning = status.status === 'running';

      if (isRunning) {
        dot.className = 'status-dot running';
        text.textContent = `Ejecutando: ${status.currentSuite || '...'} (${status.progress}%)`;
        document.getElementById('runProgress').classList.remove('hidden');
        document.getElementById('runProgressBar').style.width = status.progress + '%';
        document.getElementById('currentSuite').textContent = status.currentSuite || '--';
      } else {
        dot.className = 'status-dot';
        text.textContent = status.status === 'completed' ? 'Completado' : 'Listo';
        document.getElementById('runProgress').classList.add('hidden');
      }

      // Update button states
      document.getElementById('runFullBtn').disabled = isRunning;
      document.getElementById('runSmokeBtn').disabled = isRunning;
      document.getElementById('runCriticalBtn').disabled = isRunning;
    }

    function updateResults(summary, results) {
      if (!summary) return;

      // Update metrics
      const passRate = summary.passRate || 0;
      document.getElementById('passRate').textContent = passRate + '%';
      document.getElementById('passRate').className = 'metric ' +
        (passRate >= 90 ? 'success' : passRate >= 70 ? 'warning' : 'error');
      document.getElementById('passRateBar').style.width = passRate + '%';
      document.getElementById('passRateBar').style.background =
        passRate >= 90 ? '#10b981' : passRate >= 70 ? '#f59e0b' : '#ef4444';

      document.getElementById('totalTests').textContent = summary.totalTests || '--';
      document.getElementById('passedCount').textContent = summary.passedCount || 0;
      document.getElementById('failedCount').textContent = summary.failedCount || 0;
      document.getElementById('avgTime').textContent =
        Math.round(summary.avgResponseTime || 0) + 'ms';

      if (summary.timestamp) {
        const time = new Date(summary.timestamp);
        document.getElementById('lastRunTime').textContent =
          time.toLocaleTimeString('es-ES');
        document.getElementById('lastRunType').textContent =
          summary.runType || 'scheduled';
      }

      // Update suite grid
      if (summary.suites) {
        const grid = document.getElementById('suiteGrid');
        grid.innerHTML = summary.suites.map(suite => `
          <div class="suite-card">
            <h3>${suite.suiteName}</h3>
            <div class="suite-stats">
              <span class="${suite.passRate >= 90 ? 'success' : suite.passRate >= 70 ? 'warning' : 'error'}">
                ${suite.passRate || 0}%
              </span>
              <span>${suite.passedCount || 0}/${suite.totalTests || 0}</span>
            </div>
          </div>
        `).join('');
      }

      // Update results table
      if (results) {
        const tbody = document.getElementById('resultsBody');
        const rows = Object.values(results)
          .sort((a, b) => {
            if (a.status === 'PASS' && b.status !== 'PASS') return 1;
            if (a.status !== 'PASS' && b.status === 'PASS') return -1;
            return 0;
          })
          .map(r => `
            <tr>
              <td>${r.testId}</td>
              <td><span class="badge ${r.status.toLowerCase()}">${r.status}</span></td>
              <td>${r.duration}ms</td>
              <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                ${r.error || '-'}
              </td>
            </tr>
          `).join('');
        tbody.innerHTML = rows || '<tr><td colspan="4">No hay resultados</td></tr>';
      }
    }

    function updateAlerts(alerts) {
      const list = document.getElementById('alertsList');

      if (!alerts || alerts.length === 0) {
        list.innerHTML = `
          <p style="color: var(--text-muted); text-align: center; padding: 20px;">
            No hay alertas pendientes
          </p>`;
        return;
      }

      list.innerHTML = alerts.map(alert => `
        <div class="alert-item">
          <strong>${alert.type}</strong>: Suite "${alert.suite}" - ${alert.passRate}% pass rate
          <div class="time">${new Date(alert.timestamp).toLocaleString('es-ES')}</div>
          <div>Tests fallidos: ${alert.failedTests?.join(', ') || '-'}</div>
        </div>
      `).join('');
    }

    // Actions
    async function runTests(type) {
      if (isRunning) return;

      try {
        const endpoint = type === 'smoke' ? '/api/run/smoke' :
                        type === 'critical' ? '/api/run/critical' : '/api/run';

        await fetch(endpoint, { method: 'POST' });
        updateDashboard();
      } catch (error) {
        console.error('Error starting tests:', error);
        alert('Error al iniciar tests');
      }
    }

    async function runCleanup() {
      if (!confirm('¬øLimpiar todos los datos de test?')) return;

      try {
        const res = await fetch('/api/testdata/cleanup', { method: 'POST' });
        const data = await res.json();
        alert(`Limpieza completada: ${data.result?.cleaned || 0} eliminados`);
      } catch (error) {
        console.error('Error running cleanup:', error);
        alert('Error en limpieza');
      }
    }

    async function clearAlerts() {
      try {
        await fetch('/api/alerts/clear', { method: 'POST' });
        updateDashboard();
      } catch (error) {
        console.error('Error clearing alerts:', error);
      }
    }

    // Initial load and auto-refresh
    updateDashboard();
    setInterval(updateDashboard, 30000);

    // More frequent updates when running
    setInterval(() => {
      if (isRunning) {
        updateDashboard();
      }
    }, 5000);
  </script>
</body>
</html>
