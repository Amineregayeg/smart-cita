<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaserOstop - Test Dashboard</title>
  <style>
    :root {
      --primary: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
      color: white;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1::before {
      content: 'üî¨';
    }

    .status-bar {
      display: flex;
      gap: 20px;
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .status-dot.running {
      background: var(--warning);
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
      animation: pulse 1s infinite;
    }

    .status-dot.error {
      background: var(--error);
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card h2 {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .metric {
      font-size: 3rem;
      font-weight: 700;
      line-height: 1;
    }

    .metric.success { color: var(--success); }
    .metric.warning { color: var(--warning); }
    .metric.error { color: var(--error); }

    .metric-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .progress-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 12px;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.5s ease;
      border-radius: 4px;
    }

    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: var(--primary);
      color: white;
    }

    button.primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    button.secondary {
      background: var(--border);
      color: var(--text);
    }

    button.secondary:hover {
      background: #cbd5e1;
    }

    button.danger {
      background: #fee2e2;
      color: #991b1b;
    }

    button.danger:hover {
      background: #fecaca;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
    }

    .results-table th,
    .results-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .results-table th {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: 0.05em;
      background: var(--bg);
    }

    .results-table tr:hover {
      background: var(--bg);
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge.pass { background: #d1fae5; color: #065f46; }
    .badge.fail { background: #fee2e2; color: #991b1b; }
    .badge.error { background: #fef3c7; color: #92400e; }

    .alerts-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .alert-item {
      padding: 16px;
      border-left: 4px solid var(--error);
      background: #fef2f2;
      margin-bottom: 12px;
      border-radius: 0 8px 8px 0;
    }

    .alert-item .time {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .suite-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }

    .suite-card {
      padding: 16px;
      background: var(--bg);
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .suite-card:hover {
      border-color: var(--primary);
    }

    .suite-card h3 {
      font-size: 0.8rem;
      margin-bottom: 8px;
      color: var(--text);
    }

    .suite-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .suite-stats .rate {
      font-size: 1.25rem;
    }

    .refresh-info {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .hidden { display: none; }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .loading::before {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fef2f2;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }

    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .table-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .connection-status {
      font-size: 0.75rem;
      padding: 4px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div>
        <h1>Chatbot Test Dashboard</h1>
        <div class="status-bar">
          <span class="status-indicator">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connecting...</span>
          </span>
        </div>
      </div>
      <div class="connection-status" id="lastUpdate">--</div>
    </div>
  </header>

  <div class="container">
    <!-- Key Metrics -->
    <div class="grid">
      <div class="card">
        <h2>üìä Pass Rate</h2>
        <div class="metric" id="passRate">--</div>
        <div class="metric-label">Last test run</div>
        <div class="progress-bar">
          <div class="progress-fill" id="passRateBar" style="width: 0%"></div>
        </div>
      </div>

      <div class="card">
        <h2>üß™ Tests Executed</h2>
        <div class="metric" id="totalTests">--</div>
        <div class="metric-label">
          ‚úÖ <span id="passedCount">--</span> passed &nbsp;|&nbsp;
          ‚ùå <span id="failedCount">--</span> failed
        </div>
      </div>

      <div class="card">
        <h2>‚ö° Avg Response Time</h2>
        <div class="metric" id="avgTime">--</div>
        <div class="metric-label">milliseconds per test</div>
      </div>

      <div class="card">
        <h2>üïê Last Run</h2>
        <div class="metric" id="lastRunTime" style="font-size: 1.75rem;">--</div>
        <div class="metric-label" id="lastRunType">--</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card" style="margin-bottom: 20px;">
      <h2>‚öôÔ∏è Actions</h2>
      <div class="actions">
        <button class="primary" id="runFullBtn" onclick="runTests('full')">
          ‚ñ∂Ô∏è Run All Tests
        </button>
        <button class="secondary" id="runSmokeBtn" onclick="runTests('smoke')">
          ‚ö° Smoke Tests
        </button>
        <button class="secondary" id="runCriticalBtn" onclick="runTests('critical')">
          üî• Critical Tests
        </button>
        <button class="danger" onclick="runCleanup()">
          üßπ Cleanup Test Data
        </button>
      </div>
      <div id="runProgress" class="hidden" style="margin-top: 15px;">
        <div class="progress-bar">
          <div class="progress-fill" id="runProgressBar" style="width: 0%; background: var(--warning);"></div>
        </div>
        <div class="metric-label" style="margin-top: 8px;">
          üîÑ Running: <strong id="currentSuite">--</strong>
        </div>
      </div>
    </div>

    <!-- Suite Results -->
    <div class="card" style="margin-bottom: 20px;">
      <h2>üìã Results by Suite</h2>
      <div class="suite-grid" id="suiteGrid">
        <div class="loading">Loading results...</div>
      </div>
    </div>

    <!-- Alerts -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="section-title">
        <h2>üö® Alerts</h2>
        <button class="secondary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="clearAlerts()">
          Clear Alerts
        </button>
      </div>
      <div class="alerts-list" id="alertsList">
        <p style="color: var(--text-muted); text-align: center; padding: 20px;">
          ‚úÖ No pending alerts
        </p>
      </div>
    </div>

    <!-- Test Details -->
    <div class="card">
      <h2>üìù Test Details</h2>
      <div class="table-container">
        <table class="results-table" id="resultsTable">
          <thead>
            <tr>
              <th>Test ID</th>
              <th>Status</th>
              <th>Duration</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <tr>
              <td colspan="4" class="loading">Loading results...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="refresh-info">
      üîÑ Auto-refresh every 30 seconds &nbsp;|&nbsp;
      Backend: <a href="https://chatbot-test-runner.onrender.com/health" target="_blank">chatbot-test-runner.onrender.com</a>
    </div>
  </div>

  <script>
    // API Base URL - Render backend
    const API_BASE = 'https://chatbot-test-runner.onrender.com';

    // State
    let isRunning = false;

    // Update dashboard data
    async function updateDashboard() {
      try {
        // Get status
        const statusRes = await fetch(`${API_BASE}/api/status`);
        if (!statusRes.ok) throw new Error('Status API failed');
        const status = await statusRes.json();
        updateStatus(status);

        // Get results
        const resultsRes = await fetch(`${API_BASE}/api/results/latest`);
        if (!resultsRes.ok) throw new Error('Results API failed');
        const { summary, results } = await resultsRes.json();
        updateResults(summary, results);

        // Get alerts
        const alertsRes = await fetch(`${API_BASE}/api/alerts`);
        if (!alertsRes.ok) throw new Error('Alerts API failed');
        const { alerts } = await alertsRes.json();
        updateAlerts(alerts);

        document.getElementById('lastUpdate').textContent =
          '‚úÖ Connected ¬∑ ' + new Date().toLocaleTimeString('en-US');

      } catch (error) {
        console.error('Error updating dashboard:', error);
        document.getElementById('statusText').textContent = 'Connection error';
        document.getElementById('statusDot').className = 'status-dot error';
        document.getElementById('lastUpdate').textContent = '‚ùå Disconnected';
      }
    }

    function updateStatus(status) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');

      isRunning = status.status === 'running';

      if (isRunning) {
        dot.className = 'status-dot running';
        text.textContent = `Running: ${status.currentSuite || '...'} (${status.progress}%)`;
        document.getElementById('runProgress').classList.remove('hidden');
        document.getElementById('runProgressBar').style.width = status.progress + '%';
        document.getElementById('currentSuite').textContent = status.currentSuite || '--';
      } else {
        dot.className = 'status-dot';
        text.textContent = status.status === 'completed' ? '‚úÖ Completed' : 'üü¢ Ready';
        document.getElementById('runProgress').classList.add('hidden');
      }

      // Update button states
      document.getElementById('runFullBtn').disabled = isRunning;
      document.getElementById('runSmokeBtn').disabled = isRunning;
      document.getElementById('runCriticalBtn').disabled = isRunning;
    }

    function updateResults(summary, results) {
      if (!summary) {
        document.getElementById('suiteGrid').innerHTML =
          '<p style="color: var(--text-muted); text-align: center; padding: 20px; grid-column: 1/-1;">No results yet. Run the tests.</p>';
        return;
      }

      // Update metrics
      const passRate = summary.passRate || 0;
      document.getElementById('passRate').textContent = passRate + '%';
      document.getElementById('passRate').className = 'metric ' +
        (passRate >= 90 ? 'success' : passRate >= 70 ? 'warning' : 'error');
      document.getElementById('passRateBar').style.width = passRate + '%';
      document.getElementById('passRateBar').style.background =
        passRate >= 90 ? '#10b981' : passRate >= 70 ? '#f59e0b' : '#ef4444';

      document.getElementById('totalTests').textContent = summary.totalTests || '--';
      document.getElementById('passedCount').textContent = summary.passedCount || 0;
      document.getElementById('failedCount').textContent = summary.failedCount || 0;
      document.getElementById('avgTime').textContent =
        Math.round(summary.avgResponseTime || 0) + 'ms';

      if (summary.timestamp) {
        const time = new Date(summary.timestamp);
        document.getElementById('lastRunTime').textContent =
          time.toLocaleString('en-US', {
            day: '2-digit',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
          });
        document.getElementById('lastRunType').textContent =
          'Type: ' + (summary.runType || 'scheduled');
      }

      // Update suite grid
      if (summary.suites && summary.suites.length > 0) {
        const grid = document.getElementById('suiteGrid');
        grid.innerHTML = summary.suites.map(suite => {
          const rate = suite.passRate || 0;
          const rateClass = rate >= 90 ? 'success' : rate >= 70 ? 'warning' : 'error';
          return `
            <div class="suite-card">
              <h3>${suite.suiteName}</h3>
              <div class="suite-stats">
                <span class="rate ${rateClass}">${rate}%</span>
                <span>${suite.passedCount || 0}/${suite.totalTests || 0}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Update results table
      if (results && Object.keys(results).length > 0) {
        const tbody = document.getElementById('resultsBody');
        const rows = Object.values(results)
          .sort((a, b) => {
            if (a.status === 'PASS' && b.status !== 'PASS') return 1;
            if (a.status !== 'PASS' && b.status === 'PASS') return -1;
            return 0;
          })
          .map(r => `
            <tr>
              <td><code>${r.testId}</code></td>
              <td><span class="badge ${r.status.toLowerCase()}">${r.status}</span></td>
              <td>${r.duration}ms</td>
              <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; font-size: 0.8rem; color: var(--text-muted);">
                ${r.error || '‚Äî'}
              </td>
            </tr>
          `).join('');
        tbody.innerHTML = rows;
      }
    }

    function updateAlerts(alerts) {
      const list = document.getElementById('alertsList');

      if (!alerts || alerts.length === 0) {
        list.innerHTML = `
          <p style="color: var(--text-muted); text-align: center; padding: 20px;">
            ‚úÖ No pending alerts
          </p>`;
        return;
      }

      list.innerHTML = alerts.map(alert => `
        <div class="alert-item">
          <strong>‚ö†Ô∏è ${alert.type}</strong>: Suite "${alert.suite}" - ${alert.passRate}% pass rate
          <div class="time">${new Date(alert.timestamp).toLocaleString('en-US')}</div>
          <div style="font-size: 0.8rem; margin-top: 4px;">Failed tests: ${alert.failedTests?.join(', ') || '‚Äî'}</div>
        </div>
      `).join('');
    }

    // Actions
    async function runTests(type) {
      if (isRunning) return;

      try {
        const endpoint = type === 'smoke' ? '/api/run/smoke' :
                        type === 'critical' ? '/api/run/critical' : '/api/run';

        const res = await fetch(`${API_BASE}${endpoint}`, { method: 'POST' });
        if (!res.ok) throw new Error('Failed to start tests');

        alert('‚úÖ Tests started. Refresh in a few seconds to see progress.');
        setTimeout(updateDashboard, 2000);
      } catch (error) {
        console.error('Error starting tests:', error);
        alert('‚ùå Error starting tests: ' + error.message);
      }
    }

    async function runCleanup() {
      if (!confirm('‚ö†Ô∏è Clean up all test data?\n\nThis will delete test bookings created by the system.')) return;

      try {
        const res = await fetch(`${API_BASE}/api/testdata/cleanup`, { method: 'POST' });
        if (!res.ok) throw new Error('Cleanup failed');
        const data = await res.json();
        alert(`‚úÖ Cleanup completed:\n- ${data.result?.cleaned || 0} deleted\n- ${data.result?.skipped || 0} skipped (real data)`);
      } catch (error) {
        console.error('Error running cleanup:', error);
        alert('‚ùå Cleanup error: ' + error.message);
      }
    }

    async function clearAlerts() {
      try {
        await fetch(`${API_BASE}/api/alerts/clear`, { method: 'POST' });
        updateDashboard();
      } catch (error) {
        console.error('Error clearing alerts:', error);
      }
    }

    // Initial load and auto-refresh
    updateDashboard();
    setInterval(updateDashboard, 30000);

    // More frequent updates when running
    setInterval(() => {
      if (isRunning) {
        updateDashboard();
      }
    }, 5000);
  </script>
</body>
</html>
