<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>LaserOstop Espa√±a - Reserve su cita</title>
<link rel="stylesheet" href="tailwind-generated.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    .material-icons {
      vertical-align: middle;
    }

    /* Map container */
    #spain-map-container {
      position: relative;
      width: 100%;
      height: 600px;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    #spain-map {
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* Custom marker styles */
    .custom-marker {
      background-color: #22A9AF;
      width: 30px;
      height: 30px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 3px solid white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .custom-marker::after {
      content: '';
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: white;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* Leaflet popup customization */
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .leaflet-popup-content {
      margin: 16px;
      font-family: 'Poppins', sans-serif;
    }

    .leaflet-popup-content h3 {
      color: #22A9AF;
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* Reviews Carousel Animations */
    @keyframes scroll-left {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-50%);
      }
    }

    @keyframes scroll-right {
      0% {
        transform: translateX(-50%);
      }
      100% {
        transform: translateX(0);
      }
    }

    .carousel-track {
      display: flex;
      gap: 1.5rem;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    .carousel-row-1 .carousel-track {
      animation: scroll-left 40s linear infinite;
    }

    .carousel-row-2 .carousel-track {
      animation: scroll-right 40s linear infinite;
    }

    /* Faster animation on mobile devices */
    @media (max-width: 768px) {
      .carousel-row-1 .carousel-track {
        animation: scroll-left 20s linear infinite;
      }

      .carousel-row-2 .carousel-track {
        animation: scroll-right 20s linear infinite;
      }
    }

    .carousel-container:hover .carousel-track {
      animation-play-state: paused;
    }

    .review-card-carousel {
      flex: 0 0 350px;
      min-width: 350px;
    }

    /* City-grouped dropdown styling */
    #center-select optgroup {
      font-weight: 700;
      font-size: 0.95em;
      color: #22A9AF;
      font-style: normal;
      padding: 8px 0 4px 0;
    }

    #center-select option {
      padding-left: 8px;
      font-weight: 400;
      color: #374151;
    }

    /* Dark mode support for dropdown */
    @media (prefers-color-scheme: dark) {
      #center-select optgroup {
        color: #22A9AF;
      }
      #center-select option {
        color: #D1D5DB;
      }
    }
  </style>

  <!-- Cookie Consent & Hotjar/Contentsquare Tracking Code -->
  <script>
    // Cookie Consent Management
    window.CookieConsent = {
      init: function() {
        const consent = localStorage.getItem('analyticsConsent');
        if (consent === 'accepted') {
          this.loadHotjar();
        } else if (consent === null) {
          // First visit - show banner
          this.showBanner();
        }
        // If 'rejected', do nothing
      },

      showBanner: function() {
        const banner = document.getElementById('cookie-consent-banner');
        if (banner) {
          banner.classList.remove('hidden');
          banner.classList.add('animate-slide-up');
        }
      },

      accept: function() {
        localStorage.setItem('analyticsConsent', 'accepted');
        this.hideBanner();
        this.loadHotjar();
      },

      reject: function() {
        localStorage.setItem('analyticsConsent', 'rejected');
        this.hideBanner();
      },

      hideBanner: function() {
        const banner = document.getElementById('cookie-consent-banner');
        if (banner) {
          banner.classList.add('opacity-0');
          setTimeout(() => banner.remove(), 300);
        }
      },

      loadHotjar: function() {
        if (window.hj) return; // Already loaded

        // Mask sensitive form fields before loading Hotjar
        this.maskSensitiveFields();

        (function (c, s, q, u, a, r, e) {
            c.hj=c.hj||function(){(c.hj.q=c.hj.q||[]).push(arguments)};
            c._hjSettings = { hjid: a };
            r = s.getElementsByTagName('head')[0];
            e = s.createElement('script');
            e.async = true;
            e.src = q + c._hjSettings.hjid + u;
            r.appendChild(e);
        })(window, document, 'https://static.hj.contentsquare.net/c/csq-', '.js', 6574639);

        console.log('‚úÖ Hotjar loaded with user consent');
      },

      maskSensitiveFields: function() {
        // Add data-hj-suppress attribute to sensitive fields
        // This prevents Hotjar from recording their values
        const sensitiveSelectors = [
          'input[type="email"]',
          'input[type="tel"]',
          'input[name*="email"]',
          'input[name*="phone"]',
          'input[name*="telefono"]',
          'input[id*="email"]',
          'input[id*="phone"]',
          'input[id*="telefono"]',
          '#contact-name',
          '#contact-email',
          '#contact-phone'
        ];

        sensitiveSelectors.forEach(selector => {
          document.querySelectorAll(selector).forEach(field => {
            field.setAttribute('data-hj-suppress', '');
            field.setAttribute('data-cs-mask', ''); // Contentsquare masking
          });
        });

        console.log('üîí Sensitive fields masked for privacy');
      }
    };

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => window.CookieConsent.init());
    } else {
      window.CookieConsent.init();
    }
  </script>

  <style>
    @keyframes slide-up {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .animate-slide-up {
      animation: slide-up 0.4s ease-out;
    }
    #cookie-consent-banner {
      transition: opacity 0.3s ease-out;
    }
  </style>

</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">

<!-- Cookie Consent Banner -->
<div id="cookie-consent-banner" class="hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 shadow-2xl border-t-4 border-primary z-[9999]">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <!-- Content -->
      <div class="flex items-start gap-4 flex-1">
        <div class="flex-shrink-0 mt-1">
          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="font-semibold text-text-light dark:text-text-dark mb-2">
            üç™ Uso de Cookies
          </h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
            Utilizamos cookies y herramientas de an√°lisis (Hotjar/Contentsquare) para mejorar su experiencia, analizar el uso del sitio web y optimizar nuestros servicios.
            <span class="font-medium">No compartimos datos personales con terceros.</span>
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">
            Al aceptar, nos ayuda a entender c√≥mo mejorar nuestro servicio de reservas.
          </p>
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
        <button
          onclick="window.CookieConsent.reject()"
          class="px-6 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 whitespace-nowrap">
          Rechazar
        </button>
        <button
          onclick="window.CookieConsent.accept()"
          class="px-6 py-3 text-sm font-medium text-white bg-primary hover:bg-[#1d9199] rounded-full transition-colors duration-200 shadow-md hover:shadow-lg whitespace-nowrap">
          Aceptar Cookies
        </button>
      </div>
    </div>
  </div>
</div>

<div class="min-h-screen flex flex-col">

<!-- Modern Navigation Bar -->
<nav class="bg-white dark:bg-gray-900 shadow-md sticky top-0 z-50 transition-all duration-300" id="navbar">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-20">
<!-- Logo -->
<div class="flex-shrink-0">
<a href="#hero" class="smooth-scroll">
<img src="assets/logolaserostop-bleu.svg" alt="LaserOstop Espa√±a" class="h-12 sm:h-14 w-auto transition-all duration-300"/>
</a>
</div>

<!-- Desktop Navigation Links -->
<div class="hidden md:flex items-center space-x-8">
<a href="#hero" class="smooth-scroll text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors duration-200 font-medium">Inicio</a>
<a href="#about" class="smooth-scroll text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors duration-200 font-medium">Sobre Nosotros</a>
<a href="#testimonials" class="smooth-scroll text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors duration-200 font-medium">Testimonios</a>
</div>

<!-- Reservation CTA Button (Desktop) -->
<div class="hidden md:flex items-center">
<a href="#booking" class="smooth-scroll inline-flex items-center gap-2 bg-primary hover:bg-primary/90 text-white font-semibold px-6 py-3 rounded-full shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300">
<span class="material-icons text-lg">event_available</span>
<span>Reservar Cita</span>
</a>
</div>

<!-- Mobile Menu Button -->
<div class="md:hidden">
<button id="mobile-menu-button" class="text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary focus:outline-none">
<span class="material-icons text-3xl">menu</span>
</button>
</div>
</div>

<!-- Mobile Navigation Menu -->
<div id="mobile-menu" class="hidden md:hidden pb-4 pt-2">
<div class="flex flex-col space-y-3">
<a href="#hero" class="smooth-scroll mobile-link text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors duration-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">Inicio</a>
<a href="#about" class="smooth-scroll mobile-link text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors duration-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">Sobre Nosotros</a>
<a href="#testimonials" class="smooth-scroll mobile-link text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors duration-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">Testimonios</a>
<a href="#booking" class="smooth-scroll mobile-link inline-flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-white font-semibold px-6 py-3 rounded-full shadow-md transition-all duration-300 mt-2">
<span class="material-icons text-lg">event_available</span>
<span>Reservar Cita</span>
</a>
</div>
</div>
</div>
</nav>

<main class="flex-grow">
<section id="hero" class="relative py-20 sm:py-32 bg-cover bg-center" style="background-image: url('assets/cigarettes.png');">
<div class="absolute inset-0 bg-black opacity-40"></div>
<div class="container mx-auto px-4 sm:px-6 lg:px-8 relative text-center">
<h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-white leading-tight mb-8">Reserve su cita hoy mismo <br class="hidden sm:block"/> para dejar de fumar suavemente</h1>
<button id="hero-cta-btn" class="inline-flex items-center gap-2 bg-primary hover:bg-primary/90 text-white font-semibold text-lg px-8 py-4 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
<span class="material-icons">event_available</span>
<span>Reservar mi cita</span>
</button>
</div>
</section>

<section class="bg-gray-50 dark:bg-gray-800 py-6">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex flex-wrap justify-center items-center gap-x-8 gap-y-4 text-center">
<div class="flex items-center text-primary">
<span class="material-icons mr-2">check_circle</span>
<span class="font-medium text-text-light dark:text-text-dark">Indoloro y sin peligro</span>
</div>
<div class="flex items-center text-primary">
<span class="material-icons mr-2">check_circle</span>
<span class="font-medium text-text-light dark:text-text-dark">Sin aumento de peso</span>
</div>
<div class="flex items-center text-primary">
<span class="material-icons mr-2">check_circle</span>
<span class="font-medium text-text-light dark:text-text-dark">Sin efectos secundarios</span>
</div>
</div>
</div>
</section>
<section class="py-16 sm:py-24" id="booking">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<div class="max-w-4xl mx-auto bg-background-light dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden" style="border: 3px solid #22A9AF;">
<div class="p-8 sm:p-12">
<div id="booking-form">
<!-- CTA Banner -->
<div class="mb-8 bg-gradient-to-r from-primary/10 via-primary/5 to-transparent rounded-lg p-6" style="border-left: 4px solid #22A9AF;">
  <div class="flex items-start gap-4">
    <div class="flex-shrink-0">
      <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(34, 169, 175, 0.2);">
        <span class="material-icons text-2xl" style="color: #22A9AF;">campaign</span>
      </div>
    </div>
    <div class="flex-1">
      <h3 class="text-lg font-bold text-text-light dark:text-text-dark mb-2">
        ¬°Reserve su cita hoy y deje de fumar en una sola sesi√≥n!
      </h3>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        M√°s de 500,000 personas han dejado de fumar con LaserOstop.
        <span class="font-semibold" style="color: #22A9AF;">Plazas limitadas disponibles</span> - Reserve ahora.
      </p>
    </div>
  </div>
</div>

<div class="mb-8" id="step-1">
<h2 class="text-2xl font-semibold mb-4 text-text-light dark:text-text-dark"><span class="text-primary mr-3">1.</span>Elija su centro</h2>
<div class="relative">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">place</span>
<select id="center-select" class="w-full pl-12 pr-4 py-3 border border-border-light dark:border-border-dark rounded-full bg-transparent focus:ring-primary focus:border-primary transition">
<option value="">Seleccione un centro...</option>
<!-- Centers are dynamically loaded from Smart Agenda API -->
<!-- Only 8 centers available: Barcelona Sants, Madrid Atocha, Madrid Chamart√≠n, Majadahonda, San Sebasti√°n, Sevilla, Torrej√≥n, Valencia -->
</select>
</div>
</div>
<div class="mb-8 hidden" id="step-1b">
<h2 class="text-2xl font-semibold mb-4 text-text-light dark:text-text-dark"><span class="text-primary mr-3">2.</span>Tipo de sesi√≥n</h2>
<div class="relative">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">healing</span>
<select id="booking-type-select" class="w-full pl-12 pr-4 py-3 border border-border-light dark:border-border-dark rounded-full bg-transparent focus:ring-primary focus:border-primary transition">
<option value="">Seleccione el tipo de sesi√≥n...</option>
</select>
</div>
<!-- Info box for selected type -->
<div id="booking-type-info" class="hidden mt-4 p-4 bg-primary/10 border border-primary/30 rounded-lg">
<div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
<div class="flex items-center">
<span class="material-icons text-primary mr-2 text-lg">schedule</span>
<div>
<p class="text-gray-500 dark:text-gray-400 text-xs">Duraci√≥n</p>
<p id="type-duration" class="font-semibold text-text-light dark:text-text-dark">-</p>
</div>
</div>
<div class="flex items-center">
<span class="material-icons text-primary mr-2 text-lg">euro</span>
<div>
<p class="text-gray-500 dark:text-gray-400 text-xs">Precio</p>
<p id="type-price" class="font-semibold text-text-light dark:text-text-dark">-</p>
</div>
</div>
<div class="flex items-center">
<span class="material-icons text-primary mr-2 text-lg">info</span>
<div>
<p class="text-gray-500 dark:text-gray-400 text-xs">Descripci√≥n</p>
<p id="type-description" class="font-semibold text-text-light dark:text-text-dark text-xs">-</p>
</div>
</div>
</div>
</div>
</div>
<div class="mb-8 hidden" id="step-2">
<h2 class="text-2xl font-semibold mb-4 text-text-light dark:text-text-dark"><span class="text-primary mr-3">3.</span>Elija una fecha y una hora</h2>
<div class="bg-gray-50 dark:bg-gray-700/50 p-6 rounded-lg">
<div class="flex justify-between items-center mb-4">
<button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition"><span class="material-icons">chevron_left</span></button>
<h3 id="current-month" class="text-lg font-semibold"></h3>
<button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition"><span class="material-icons">chevron_right</span></button>
</div>
<div class="grid grid-cols-7 gap-2 text-center mb-2">
<div class="text-gray-500 text-sm font-medium">Lu</div>
<div class="text-gray-500 text-sm font-medium">Ma</div>
<div class="text-gray-500 text-sm font-medium">Mi</div>
<div class="text-gray-500 text-sm font-medium">Ju</div>
<div class="text-gray-500 text-sm font-medium">Vi</div>
<div class="text-gray-500 text-sm font-medium">Sa</div>
<div class="text-gray-500 text-sm font-medium">Do</div>
</div>
<div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center">
<!-- Calendar days will be generated here -->
</div>
<div class="mt-6" id="time-slots-section">
<h4 class="font-semibold mb-3 text-text-light dark:text-text-dark">Horarios disponibles</h4>
<div id="selected-date-info" class="text-sm text-gray-600 dark:text-gray-400 mb-3"></div>
<div id="time-slots" class="grid grid-cols-3 sm:grid-cols-4 gap-2">
<!-- Time slots will be generated here -->
</div>
</div>
</div>
</div>
<div class="mb-8 hidden" id="step-3">
<h2 class="text-2xl font-semibold mb-4 text-text-light dark:text-text-dark"><span class="text-primary mr-3">4.</span>Sus datos</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="relative">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">person</span>
<input id="full-name" class="w-full pl-12 pr-4 py-3 border border-border-light dark:border-border-dark rounded-full bg-transparent focus:ring-primary focus:border-primary transition" placeholder="Nombre completo *" type="text" required/>
</div>
<div class="relative">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">email</span>
<input id="email" class="w-full pl-12 pr-4 py-3 border border-border-light dark:border-border-dark rounded-full bg-transparent focus:ring-primary focus:border-primary transition" placeholder="Correo electr√≥nico *" type="email" required/>
</div>
<div class="relative md:col-span-2">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">phone</span>
<input id="phone" class="w-full pl-12 pr-4 py-3 border border-border-light dark:border-border-dark rounded-full bg-transparent focus:ring-primary focus:border-primary transition" placeholder="N√∫mero de tel√©fono *" type="tel" required/>
</div>
</div>
</div>
<div id="step-4" class="hidden">
<button type="button" class="w-full bg-primary text-white py-4 px-8 rounded-full font-semibold text-lg hover:bg-opacity-90 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" onclick="showConfirmation(event)">
<span class="material-icons mr-2">event_available</span> Confirmar la cita
                  </button>
</div>
</div>
<div class="hidden flex items-center justify-center text-center" id="confirmation-message">
<div class="py-12">
<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
<span class="material-icons text-4xl text-green-500">check</span>
</div>
<h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">¬°Cita confirmada!</h2>
<p class="text-lg text-gray-600 dark:text-gray-300 mb-2">Se ha enviado un correo de confirmaci√≥n a su direcci√≥n.</p>
<p class="text-gray-500 dark:text-gray-400">Estaremos encantados de recibirle en el centro <strong>LaserOstop Valencia</strong> el <strong>15 de Octubre de 2025 a las 11:30</strong>.</p>
</div>
</div>

<!-- Promotional Popup (Modal) -->
<div id="promo-popup" class="hidden fixed inset-0 bg-white/40 dark:bg-black/40 backdrop-blur-md flex items-center justify-center z-[60] p-4 animate-fadeIn">
<div class="relative bg-white dark:bg-gray-900 rounded-lg shadow-2xl overflow-hidden transform transition-all animate-scaleIn" style="border: 3px solid #22A9AF; width: 420px; height: 550px;">
<!-- Close Button (X in corner) - MUST BE FIRST for absolute positioning -->
<button
onclick="closePromoPopup()"
class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center hover:opacity-70 transition-opacity z-10"
aria-label="Cerrar"
style="z-index: 20;">
<span class="material-icons text-gray-600 dark:text-gray-300 text-lg">close</span>
</button>

<!-- Centered Content Wrapper -->
<div class="flex flex-col items-center justify-center" style="height: 100%;">
<!-- Logo at Top -->
<div class="flex justify-center bg-white dark:bg-gray-900" style="padding-bottom: 12px;">
<img src="assets/logolaserostop-bleu.svg" alt="LaserOstop" style="height: 40px;">
</div>

<!-- Content -->
<div style="padding-left: 24px; padding-right: 24px;">
<!-- Big Discount Section -->
<div class="text-center" style="margin-bottom: 24px;">
<p class="text-sm font-medium text-gray-600 dark:text-gray-400" style="margin-bottom: 8px;">OFERTA ESPECIAL</p>
<div class="relative inline-block">
<div class="text-7xl leading-none" style="color: #22A9AF; font-weight: 900;">
30%
</div>
<div class="absolute bg-red-500 text-white text-xs font-bold rounded transform rotate-12" style="top: -8px; right: -48px; padding: 4px 8px;">
AHORRO
</div>
</div>
<p class="text-lg font-semibold text-gray-800 dark:text-white" style="margin-top: 8px;">DE DESCUENTO</p>
</div>

<!-- Sales Highlights -->
<div class="bg-gradient-to-br from-[#22A9AF]/10 via-[#22A9AF]/5 to-transparent rounded-lg border-l-4 border-[#22A9AF]" style="padding: 16px; margin-bottom: 20px;">
<div style="display: flex; flex-direction: column; gap: 8px;">
<div style="display: flex; align-items: center; justify-content: space-between;">
<span class="text-sm font-medium text-gray-700 dark:text-gray-300">Precio normal</span>
<span class="text-sm font-bold line-through" style="color: #EF4444;">hasta 280‚Ç¨</span>
</div>
<div style="display: flex; align-items: center; justify-content: space-between;">
<span class="text-sm font-medium text-gray-700 dark:text-gray-300">Precio con descuento</span>
<span class="text-lg font-bold" style="color: #22A9AF;">desde 200‚Ç¨</span>
</div>
</div>
</div>

<!-- Payment Option Highlight -->
<div class="bg-[#22A9AF]/5 rounded-lg text-center border border-[#22A9AF]/20" style="padding: 16px;">
<p class="text-xs font-semibold text-[#22A9AF] uppercase tracking-wide" style="margin-bottom: 4px;">Facilidades de pago</p>
<p class="text-2xl font-bold text-gray-800 dark:text-white">3 cuotas sin intereses</p>
<p class="text-xs text-gray-600 dark:text-gray-400" style="margin-top: 4px;">Sin comisiones adicionales</p>
</div>

<!-- CTA Button -->
<div class="text-center" style="margin-top: 24px;">
<button onclick="closePromoAndScroll()" class="inline-flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-white font-semibold px-8 py-3 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300" style="width: 100%;">
<span class="material-icons">event_available</span>
<span>Reservar mi cita</span>
</button>
</div>
</div>
</div>
</div>
</div>

<!-- Payment Options Popup (Modal) -->
<div id="payment-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
<div class="p-6 sm:p-8">
<!-- Header -->
<div class="text-center mb-6">
<div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
<span class="material-icons text-4xl text-primary">credit_card</span>
</div>
<h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">¬øSab√≠as que puedes obtener un descuento?</h3>
<p class="text-gray-600 dark:text-gray-300">Elige c√≥mo prefieres pagar tu sesi√≥n</p>
</div>

<!-- Payment Options -->
<div class="space-y-4">
<!-- Option 1: Pay at Center (Default - Already Selected) -->
<div class="border-2 border-primary bg-primary/5 rounded-xl p-6 relative cursor-pointer hover:bg-primary/10 transition-all" onclick="selectPaymentOption(1)">
<div class="absolute top-4 right-4">
<span class="bg-primary text-white text-xs font-bold px-3 py-1 rounded-full">SELECCIONADO</span>
</div>
<div class="flex items-start">
<span class="material-icons text-primary text-3xl mr-4">store</span>
<div class="flex-1">
<h4 class="font-bold text-lg text-gray-800 dark:text-white mb-1">Pagar en el centro</h4>
<p class="text-gray-600 dark:text-gray-300 text-sm mb-2">Paga el d√≠a de tu cita</p>
<div class="flex items-baseline">
<span id="popup-center-price" class="text-3xl font-bold text-primary">‚Ç¨190</span>
<span id="popup-center-old" class="text-red-500 line-through ml-2 text-lg font-semibold hidden">‚Ç¨280</span>
<span id="popup-center-standard" class="text-gray-500 ml-2 text-sm">Precio est√°ndar</span>
</div>
</div>
</div>
</div>

<!-- Option 2: Pay Online Once (Discount) -->
<div class="border-2 border-gray-200 dark:border-gray-700 hover:border-primary rounded-xl p-6 cursor-pointer transition-all" onclick="selectPaymentOption(2)">
<div class="flex items-start">
<span class="material-icons text-purple-600 text-3xl mr-4">flash_on</span>
<div class="flex-1">
<div class="flex items-center mb-1">
<h4 class="font-bold text-lg text-gray-800 dark:text-white">Pagar online ahora</h4>
<span class="ml-2 bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded">20‚Ç¨ DESCUENTO</span>
</div>
<p class="text-gray-600 dark:text-gray-300 text-sm mb-2">Pago √∫nico con descuento inmediato</p>
<div class="flex items-baseline">
<span id="popup-online-price" class="text-3xl font-bold text-purple-600">‚Ç¨170</span>
<span id="popup-online-original" class="text-red-500 line-through ml-2 text-lg font-semibold">‚Ç¨190</span>
<span class="text-green-600 ml-2 text-sm font-semibold">Ahorras ‚Ç¨20</span>
</div>
<button class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
<span class="material-icons mr-2">payment</span>
Pagar ‚Ç¨<span id="popup-online-btn-price">170</span> ahora
</button>
</div>
</div>
</div>

<!-- Option 3: Pay in 3 Installments -->
<div class="border-2 border-gray-200 dark:border-gray-700 hover:border-primary rounded-xl p-6 cursor-pointer transition-all" onclick="selectPaymentOption(3)">
<div class="flex items-start">
<span class="material-icons text-blue-600 text-3xl mr-4">calendar_today</span>
<div class="flex-1">
<h4 class="font-bold text-lg text-gray-800 dark:text-white mb-1">Pagar en 3 cuotas mensuales</h4>
<p class="text-gray-600 dark:text-gray-300 text-sm mb-2">Facilita el pago dividi√©ndolo en 3 meses</p>
<div class="flex items-baseline mb-2">
<span class="text-2xl font-bold text-blue-600">3 √ó</span>
<span id="popup-monthly-price" class="text-3xl font-bold text-blue-600 ml-2">‚Ç¨65</span>
<span class="text-gray-500 ml-2 text-sm">/mes</span>
</div>
<p class="text-gray-500 text-xs mb-4">Total: ‚Ç¨<span id="popup-monthly-total">195</span></p>
<button class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
<span class="material-icons mr-2">schedule</span>
Pagar en 3 cuotas
</button>
</div>
</div>
</div>
</div>

<!-- Close Button -->
<div class="mt-6 text-center">
<button onclick="closePaymentPopup()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 font-medium">
Cerrar y continuar con pago en centro
</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

.animate-scaleIn {
  animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
</style>

</section>

<!-- About Section -->
<section class="py-16 sm:py-24 bg-white dark:bg-gray-900" id="about">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center">
<!-- About Video - Left on Desktop, Top on Mobile -->
<div class="order-1 lg:order-1 flex justify-center">
<div class="relative rounded-2xl overflow-hidden shadow-2xl aspect-[9/16] w-full max-w-sm group cursor-pointer" onclick="toggleVideoAudio(this)">
<video
  class="w-full h-full object-cover"
  autoplay
  muted
  loop
  playsinline
  poster="assets/cigarettes.png"
>
  <source src="assets/about-video.mp4" type="video/mp4">
  Tu navegador no soporta el elemento de v√≠deo.
</video>
<!-- Audio Toggle Button -->
<div class="absolute bottom-4 right-4 bg-black/70 backdrop-blur-sm rounded-full p-3 transition-all duration-300 hover:bg-black/90 hover:scale-110">
  <span class="material-icons text-white text-2xl audio-icon">volume_off</span>
</div>
<!-- Tap to unmute hint -->
<div class="absolute inset-0 bg-black/30 backdrop-blur-[1px] flex items-center justify-center transition-opacity duration-300 opacity-100 group-hover:opacity-0 pointer-events-none audio-hint">
  <div class="bg-white/90 dark:bg-gray-900/90 px-6 py-3 rounded-full shadow-lg">
    <div class="flex items-center gap-2">
      <span class="material-icons text-primary">volume_up</span>
      <p class="text-sm font-medium text-gray-800 dark:text-gray-200">Toca para activar audio</p>
    </div>
  </div>
</div>
</div>
</div>

<!-- About Content - Right on Desktop, Bottom on Mobile -->
<div class="order-2 lg:order-2">
<div class="max-w-xl lg:max-w-none">
<h2 class="text-3xl sm:text-4xl font-bold text-text-light dark:text-text-dark mb-4">
<span class="text-primary">Sobre</span> LaserOstop
</h2>
<div class="h-1 w-20 bg-primary rounded mb-6"></div>
<div class="prose prose-lg dark:prose-invert max-w-none">
<p class="text-gray-700 dark:text-gray-300 leading-relaxed text-lg">
LaserOstop ofrece una terapia l√°ser <strong class="text-primary">segura, indolora y altamente eficaz</strong> para ayudar a las personas a dejar de fumar en una sola sesi√≥n. Utilizando tecnolog√≠a avanzada de <strong>fotobiomodulaci√≥n</strong>, este m√©todo estimula puntos espec√≠ficos de la oreja con l√°ser de baja intensidad para combatir la dependencia f√≠sica a la nicotina, <strong>sin efectos secundarios, sin aumento de peso y sin s√≠ntomas de abstinencia.</strong>
</p>
<p class="text-gray-700 dark:text-gray-300 leading-relaxed text-lg mt-4">
Con m√°s de <strong class="text-primary">500,000 personas asistidas</strong> en todo el mundo, LaserOstop proporciona una soluci√≥n cient√≠fica, no invasiva, y respaldada por resultados reales para quienes desean superar la adicci√≥n y llevar una vida m√°s saludable y libre de tabaco.
</p>
</div>
<!-- Stats -->
<div class="grid grid-cols-2 gap-6 mt-8">
<div class="text-center p-4 bg-primary/10 rounded-xl">
<div class="text-3xl font-bold text-primary mb-1">500K+</div>
<div class="text-sm text-gray-600 dark:text-gray-400">Personas asistidas</div>
</div>
<div class="text-center p-4 bg-primary/10 rounded-xl">
<div class="text-3xl font-bold text-primary mb-1">1 sesi√≥n</div>
<div class="text-sm text-gray-600 dark:text-gray-400">Para dejar de fumar</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>

<section class="bg-gray-50 dark:bg-gray-900/50 py-16 sm:py-24">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<h2 class="text-3xl font-bold text-center mb-10 text-text-light dark:text-text-dark">Nuestros centros cerca de usted</h2>
<div id="spain-map-container" class="rounded-lg overflow-hidden shadow-xl">
<div id="spain-map"></div>
</div>
</div>
</section>

<!-- Google Reviews Section - Infinite Scroll Carousel -->
<section id="testimonials" class="bg-white dark:bg-gray-800 py-16 sm:py-24 overflow-hidden">
<div class="max-w-7xl mx-auto">
<!-- Section Header -->
<div class="text-center mb-12 px-4 sm:px-6 lg:px-8">
<h2 class="text-3xl sm:text-4xl font-bold text-text-light dark:text-text-dark mb-4">Lo que dicen nuestros clientes</h2>
<p class="text-lg text-gray-600 dark:text-gray-400 mb-6">M√°s de 1,000 personas han dejado de fumar con LaserOstop</p>

<!-- Google Rating Aggregate -->
<div class="flex items-center justify-center gap-3 mb-2">
<img src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_92x30dp.png" alt="Google" class="h-6 opacity-80">
<div class="flex items-baseline gap-2">
<span class="text-4xl font-bold text-primary">4.8</span>
<div class="flex text-yellow-400 text-2xl">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
</div>
</div>
<p class="text-gray-500 dark:text-gray-400 text-sm">(1,234 rese√±as verificadas)</p>
</div>

<!-- Carousel Row 1 - Scrolls Left -->
<div class="carousel-container carousel-row-1 mb-6">
<div class="carousel-track">
<!-- Original 6 reviews -->
<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Mauricio+M&background=22A9AF&color=fff&size=48" alt="Mauricio M." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Mauricio M.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 6 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Despu√©s de 42 a√±os fumando logr√© dejarlo gracias a Nabila. El tratamiento fue c√≥modo, sin ansiedad y realmente efectivo.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Raul+L&background=843ed4&color=fff&size=48" alt="Raul L." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Raul L.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 1 semana</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Muy contento con el tratamiento de Nabila. Dej√© de fumar de un d√≠a para otro y me siento completamente renovado.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Alexandre+M&background=f59e0b&color=fff&size=48" alt="Alexandre M." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Alexandre M.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 2 d√≠as</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Tras varios intentos fallidos prob√© el l√°ser y funcion√≥ de inmediato. Cero ansiedad y sin ganas de fumar. Excelente atenci√≥n.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Victoria+G&background=10b981&color=fff&size=48" alt="Victoria G." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Victoria G.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 4 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Fui con mi marido para el tratamiento y ha sido un √©xito. En dos semanas sin fumar, ambos muy satisfechos con el resultado.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Cristina+B&background=ef4444&color=fff&size=48" alt="Cristina B." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Cristina B.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 2 semanas</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Estoy encantada con el m√©todo. Fui sin expectativas y en dos semanas dej√© de fumar. Trato profesional y humano.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Nuria+M&background=6366f1&color=fff&size=48" alt="Nuria M." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Nuria M.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 4 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Nabila me explic√≥ todo con claridad. La sesi√≥n fue relajante, sin dolor, y desde entonces no he vuelto a tener ganas de fumar.
</p>
</article>

<!-- Duplicate for seamless loop -->
<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Mauricio+M&background=22A9AF&color=fff&size=48" alt="Mauricio M." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Mauricio M.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 6 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Despu√©s de 42 a√±os fumando logr√© dejarlo gracias a Nabila. El tratamiento fue c√≥modo, sin ansiedad y realmente efectivo.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Raul+L&background=843ed4&color=fff&size=48" alt="Raul L." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Raul L.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 1 semana</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Muy contento con el tratamiento de Nabila. Dej√© de fumar de un d√≠a para otro y me siento completamente renovado.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Alexandre+M&background=f59e0b&color=fff&size=48" alt="Alexandre M." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Alexandre M.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 2 d√≠as</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Tras varios intentos fallidos prob√© el l√°ser y funcion√≥ de inmediato. Cero ansiedad y sin ganas de fumar. Excelente atenci√≥n.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Victoria+G&background=10b981&color=fff&size=48" alt="Victoria G." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Victoria G.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 4 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Fui con mi marido para el tratamiento y ha sido un √©xito. En dos semanas sin fumar, ambos muy satisfechos con el resultado.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Cristina+B&background=ef4444&color=fff&size=48" alt="Cristina B." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Cristina B.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 2 semanas</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Estoy encantada con el m√©todo. Fui sin expectativas y en dos semanas dej√© de fumar. Trato profesional y humano.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Nuria+M&background=6366f1&color=fff&size=48" alt="Nuria M." class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Nuria M.</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 4 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Nabila me explic√≥ todo con claridad. La sesi√≥n fue relajante, sin dolor, y desde entonces no he vuelto a tener ganas de fumar.
</p>
</article>
</div>
</div>

<!-- Carousel Row 2 - Scrolls Right -->
<div class="carousel-container carousel-row-2">
<div class="carousel-track">
<!-- Different 6 reviews -->
<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Maya+Rodriguez&background=8b5cf6&color=fff&size=48" alt="Maya Rodriguez" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Maya Rodriguez</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 8 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Fum√© desde los 14 a√±os y con L√°ser Stop logr√© dejarlo despu√©s de m√°s de 40 a√±os fumando. El m√©todo redujo mi ansiedad y Nabila fue muy cercana.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Paito+Luque&background=ec4899&color=fff&size=48" alt="Paito Luque" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Paito Luque</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 6 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
La sesi√≥n fue relajante y sin dolor. Llevo once d√≠as sin fumar, duermo mejor y me siento m√°s tranquila. Recomiendo L√°ser Stop al cien por cien.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Alexi+Vela&background=14b8a6&color=fff&size=48" alt="Alexi Vela Pinargote" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Alexi Vela Pinargote</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 7 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Atenci√≥n impecable y trato muy amable. Ocho d√≠as sin fumar y sin ansiedad. El procedimiento fue claro y sin molestias. Lo recomiendo con confianza.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Mireia+Gubern&background=f97316&color=fff&size=48" alt="Mireia Gubern" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Mireia Gubern</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 2 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Muy buena experiencia y totalmente recomendable. Seis meses sin fumar despu√©s de muchos a√±os. Gracias a L√°ser Stop Barcelona por su ayuda.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Ana+Fuente&background=06b6d4&color=fff&size=48" alt="Ana Fuente" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Ana Fuente</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 7 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Sigo sin fumar y mi ansiedad ha desaparecido. Hab√≠a probado de todo sin √©xito, pero este m√©todo realmente funciona. Solo hay que querer hacerlo.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Dori+Pascual&background=a855f7&color=fff&size=48" alt="Dori Pascual" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Dori Pascual</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 4 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Me costaba creer en el m√©todo, pero funciona. Tres semanas sin fumar y me siento feliz. Gracias Nabila por tu profesionalidad y apoyo.
</p>
</article>

<!-- Duplicate for seamless loop -->
<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Maya+Rodriguez&background=8b5cf6&color=fff&size=48" alt="Maya Rodriguez" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Maya Rodriguez</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 8 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Fum√© desde los 14 a√±os y con L√°ser Stop logr√© dejarlo despu√©s de m√°s de 40 a√±os fumando. El m√©todo redujo mi ansiedad y Nabila fue muy cercana.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Paito+Luque&background=ec4899&color=fff&size=48" alt="Paito Luque" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Paito Luque</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 6 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
La sesi√≥n fue relajante y sin dolor. Llevo once d√≠as sin fumar, duermo mejor y me siento m√°s tranquila. Recomiendo L√°ser Stop al cien por cien.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Alexi+Vela&background=14b8a6&color=fff&size=48" alt="Alexi Vela Pinargote" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Alexi Vela Pinargote</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 7 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Atenci√≥n impecable y trato muy amable. Ocho d√≠as sin fumar y sin ansiedad. El procedimiento fue claro y sin molestias. Lo recomiendo con confianza.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Mireia+Gubern&background=f97316&color=fff&size=48" alt="Mireia Gubern" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Mireia Gubern</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 2 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Muy buena experiencia y totalmente recomendable. Seis meses sin fumar despu√©s de muchos a√±os. Gracias a L√°ser Stop Barcelona por su ayuda.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Ana+Fuente&background=06b6d4&color=fff&size=48" alt="Ana Fuente" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Ana Fuente</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 7 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Sigo sin fumar y mi ansiedad ha desaparecido. Hab√≠a probado de todo sin √©xito, pero este m√©todo realmente funciona. Solo hay que querer hacerlo.
</p>
</article>

<article class="review-card-carousel bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-xl transition-shadow">
<div class="flex items-start gap-4 mb-4">
<img src="https://ui-avatars.com/api/?name=Dori+Pascual&background=a855f7&color=fff&size=48" alt="Dori Pascual" class="w-12 h-12 rounded-full flex-shrink-0">
<div class="flex-1 min-w-0">
<h3 class="font-semibold text-text-light dark:text-text-dark">Dori Pascual</h3>
<div class="flex items-center gap-2 mt-1">
<div class="flex text-yellow-400 text-sm">
<span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span><span>‚òÖ</span>
</div>
<span class="text-xs text-gray-500 dark:text-gray-400">Hace 4 meses</span>
</div>
</div>
</div>
<p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
Me costaba creer en el m√©todo, pero funciona. Tres semanas sin fumar y me siento feliz. Gracias Nabila por tu profesionalidad y apoyo.
</p>
</article>
</div>
</div>

</div>
</section>

</main>

<!-- WhatsApp Floating Button -->
<a href="https://wa.me/34689560130" target="_blank" rel="noopener noreferrer" class="fixed bottom-6 right-6 z-50 bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-2xl transition-all duration-300 transform hover:scale-110 flex items-center justify-center group" aria-label="Contactar por WhatsApp">
  <!-- WhatsApp Icon (SVG) -->
  <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
  </svg>
  <!-- Tooltip on hover -->
  <span class="absolute right-full mr-3 bg-gray-800 text-white text-sm font-medium px-3 py-2 rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
    ¬øNecesitas ayuda? Chatea con nosotros
  </span>
</a>

</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // Centers data with real GPS coordinates
    // Only 8 centers available in Smart Agenda (removed: Alicante, Barcelona Gr√†cia, Terrassa)
    const centers = {
      'barcelona-sants': {
        lat: 41.3784, lng: 2.1366,
        name: 'LaserOstop Barcelona Sants',
        address: 'Carrer de Galileu, 65, Sants-Montju√Øc, 08028, Barcelona',
        hours: '08:00 - 18:00',
        phone: '+34 689 560 130'
      },
      'madrid-atocha': {
        lat: 40.3940, lng: -3.6835,
        name: 'LaserOstop Madrid Atocha',
        address: 'Calle Canarias 26, Atocha, 28045, Madrid',
        hours: '10:00 - 19:00',
        phone: '+34 613 255 948'
      },
      'madrid-chamartin': {
        lat: 40.4640, lng: -3.6783,
        name: 'LaserOstop Madrid Chamart√≠n',
        address: 'Calle de Oruro, 9, Chamart√≠n, 28016, Madrid',
        hours: '09:00 - 16:00',
        phone: '+34 919 305 313'
      },
      'majadahonda': {
        lat: 40.4732, lng: -3.8714,
        name: 'LaserOstop Majadahonda',
        address: 'Calle del Dr Calero, 19, Centro comercial Tutti, 28220, Majadahonda',
        hours: '09:00 - 16:00',
        phone: '+34 919 305 313'
      },
      'san-sebastian': {
        lat: 40.5485, lng: -3.6295,
        name: 'LaserOstop San Sebasti√°n de los Reyes',
        address: 'Avenida de Murcia, 5, 28702, San Sebasti√°n de los Reyes',
        hours: '09:00 - 16:00',
        phone: '+34 919 305 313'
      },
      'torrejon': {
        lat: 40.4578, lng: -3.4763,
        name: 'LaserOstop Torrej√≥n de Ardoz',
        address: 'Calle pesquera, 10, 28850, Torrej√≥n de Ardoz',
        hours: '09:00 - 16:00',
        phone: '+34 919 305 313'
      },
      'valencia': {
        lat: 39.4699, lng: -0.3763,
        name: 'LaserOstop Valencia',
        address: 'Calle San Vicente M√°rtir 85 planta 7, 46007, Valencia',
        hours: '09:00 - 18:00',
        phone: '+34 689 560 130'
      },
      'sevilla': {
        lat: 37.3891, lng: -5.9845,
        name: 'LaserOstop Sevilla',
        address: 'Avenida Edouardo Dato 85, 41005, Sevilla',
        hours: '09:00 - 19:00',
        phone: '+34 689 560 130'
      }
    };

    let map;

    // Initialize Leaflet map
    function initializeMap() {
      // Create map centered on Spain
      map = L.map('spain-map').setView([40.4168, -3.7038], 6);

      // Add OpenStreetMap tiles (free, no API key needed)
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        minZoom: 5
      }).addTo(map);

      // Custom marker icon
      const customIcon = L.divIcon({
        className: 'custom-marker',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      });

      // Add markers for each center
      Object.keys(centers).forEach(centerId => {
        const center = centers[centerId];

        const marker = L.marker([center.lat, center.lng], { icon: customIcon })
          .addTo(map);

        // Create popup content
        const popupContent = `
          <div style="min-width: 200px;">
            <h3 style="font-size: 16px; margin-bottom: 8px;">${center.name}</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 4px;">
              <span style="display: inline-block; width: 18px;">üìç</span> ${center.address}
            </p>
            <p style="font-size: 13px; color: #666; margin-bottom: 4px;">
              <span style="display: inline-block; width: 18px;">‚è∞</span> ${center.hours}
            </p>
            <p style="font-size: 13px; color: #666; margin-bottom: 8px;">
              <span style="display: inline-block; width: 18px;">üìû</span> ${center.phone}
            </p>
            <button onclick="selectCenter('${centerId}')"
                    style="background: #22A9AF; color: white; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; width: 100%;">
              Seleccionar este centro
            </button>
          </div>
        `;

        marker.bindPopup(popupContent);

        // Open popup on marker click
        marker.on('click', function() {
          map.setView([center.lat, center.lng], 12);
        });
      });
    }

    // Select center function
    function selectCenter(centerId) {
      const select = document.getElementById('center-select');
      select.value = centerId;
      select.dispatchEvent(new Event('change'));

      // Close any open popups
      map.closePopup();

      // Scroll to booking form
      document.getElementById('booking').scrollIntoView({ behavior: 'smooth' });
    }

    // Validation and confirmation function
    async function showConfirmation(event) {
      // Prevent default if called from button
      if (event) event.preventDefault();

      // Get form inputs
      const fullName = document.getElementById('full-name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();

      // Validation errors array
      const errors = [];

      // Validate center selection
      if (!bookingState.selectedCenter) {
        errors.push('Por favor, seleccione un centro');
      }

      // Validate booking type selection
      if (!bookingState.selectedAppointmentType) {
        errors.push('Por favor, seleccione el tipo de sesi√≥n');
      }

      // Validate date selection
      if (!bookingState.selectedDate) {
        errors.push('Por favor, seleccione una fecha');
      }

      // Validate time selection
      if (!bookingState.selectedTime) {
        errors.push('Por favor, seleccione una hora');
      }

      // Validate full name
      if (!fullName || fullName.length < 3) {
        errors.push('Por favor, ingrese su nombre completo');
      }

      // Validate email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        errors.push('Por favor, ingrese un correo electr√≥nico v√°lido');
      }

      // Validate phone
      const phoneRegex = /^[+]?[\d\s()-]{9,}$/;
      if (!phone || !phoneRegex.test(phone)) {
        errors.push('Por favor, ingrese un n√∫mero de tel√©fono v√°lido');
      }

      // Show errors or proceed
      if (errors.length > 0) {
        alert('Por favor, complete todos los campos requeridos:\n\n' + errors.join('\n'));
        return;
      }

      // Store user data in booking state
      bookingState.fullName = fullName;
      bookingState.email = email;
      bookingState.phone = phone;

      console.log('Final booking data:', bookingState);

      // Get button reference
      const confirmBtn = event?.target || document.querySelector('button[onclick*="showConfirmation"]');

      // Submit booking to Smart Agenda API
      try {
        // Show loading state
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="material-icons animate-spin mr-2">sync</span> Procesando...';

        const result = await submitBooking();

        console.log('Booking created successfully:', result);

        // Update confirmation message with actual data
        const centerName = bookingState.smartAgendaCenters.find(c => c.id === bookingState.selectedCenter)?.name || 'nuestro centro';
        const dateStr = `${bookingState.selectedDate.getDate()} de ${monthNames[bookingState.selectedDate.getMonth()]} de ${bookingState.selectedDate.getFullYear()}`;

        document.querySelector('#confirmation-message p:last-child').innerHTML =
          `Estaremos encantados de recibirle en el centro <strong>${centerName}</strong> el <strong>${dateStr} a las ${bookingState.selectedTime}</strong>.`;

        // Show confirmation and scroll to center it on screen
        document.getElementById('booking-form').classList.add('hidden');
        document.getElementById('confirmation-message').classList.remove('hidden');

        // Scroll confirmation message to center of viewport
        setTimeout(() => {
          document.getElementById('confirmation-message').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }, 100);

        // Show payment options popup after 2 seconds
        setTimeout(() => {
          console.log('üîî Attempting to show payment popup...');
          console.log('üìã Booking state:', bookingState);
          console.log('üéØ Selected appointment type ID:', bookingState.selectedAppointmentType);
          showPaymentPopup();
        }, 2000);

      } catch (error) {
        console.error('Booking error:', error);
        alert('Error al crear la reserva: ' + error.message + '\n\nPor favor, int√©ntelo de nuevo o cont√°ctenos directamente.');

        // Restore button
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="material-icons mr-2">event_available</span> Confirmar la cita';
        }
      }
    }

    /**
     * Show payment options popup
     */
    function showPaymentPopup() {
      console.log('üí≥ showPaymentPopup() called');

      // Get selected appointment type to determine pricing
      const selectedType = bookingState.appointmentTypes.find(t => t.id === bookingState.selectedAppointmentType);

      console.log('üîç Looking for appointment type with ID:', bookingState.selectedAppointmentType);
      console.log('üìö Available appointment types:', bookingState.appointmentTypes);
      console.log('‚úÖ Found appointment type:', selectedType);

      if (!selectedType) {
        console.warn('‚ùå No appointment type found for payment popup');
        return;
      }

      // Prevent payment popup for free Rechute sessions
      if (selectedType.kind === 'rechute' || selectedType.price === 0) {
        console.log('‚ö†Ô∏è Rechute session (‚Ç¨0) - no payment required, skipping popup');
        return;
      }

      console.log('‚úÖ Appointment type is valid, proceeding with popup...');

      // Calculate prices based on appointment type using PRICE_TABLE
      let centerPrice, onlinePrice, monthlyPrice, monthlyTotal;

      // Get pricing from PRICE_TABLE using the 'kind' field for accurate mapping
      const priceData = PRICE_TABLE[selectedType.kind];

      if (!priceData) {
        console.error('No price data found for appointment type:', selectedType.kind);
        return;
      }

      centerPrice = priceData.center;
      onlinePrice = priceData.online;
      monthlyPrice = priceData.plan ? priceData.plan[0] : 0;
      monthlyTotal = priceData.plan ? priceData.plan.reduce((sum, val) => sum + val, 0) : 0;

      // Update popup prices
      document.getElementById('popup-center-price').textContent = `‚Ç¨${centerPrice}`;

      // Show old price for center if available (e.g., sugar addiction: ‚Ç¨280 ‚Üí ‚Ç¨200)
      const centerOldElement = document.getElementById('popup-center-old');
      const centerStandardElement = document.getElementById('popup-center-standard');
      if (priceData.centerOld) {
        centerOldElement.textContent = `‚Ç¨${priceData.centerOld}`;
        centerOldElement.classList.remove('hidden');
        centerStandardElement.classList.add('hidden');
      } else {
        centerOldElement.classList.add('hidden');
        centerStandardElement.classList.remove('hidden');
      }

      document.getElementById('popup-online-price').textContent = `‚Ç¨${onlinePrice}`;
      document.getElementById('popup-online-original').textContent = `‚Ç¨${centerPrice}`; // Strikethrough shows original center price
      document.getElementById('popup-online-btn-price').textContent = onlinePrice;
      document.getElementById('popup-monthly-price').textContent = `‚Ç¨${monthlyPrice}`;
      document.getElementById('popup-monthly-total').textContent = monthlyTotal;

      // Store prices in popup for payment selection
      window.paymentPopupData = {
        centerPrice,
        onlinePrice,
        monthlyPrice,
        monthlyTotal,
        appointmentType: selectedType
      };

      // Show popup (fixed overlay - no scroll issues)
      const popupElement = document.getElementById('payment-popup');
      console.log('üé® Payment popup element:', popupElement);
      popupElement.classList.remove('hidden');
      console.log('‚úÖ Payment popup should now be visible!');
    }

    /**
     * Close payment popup
     */
    function closePaymentPopup() {
      document.getElementById('payment-popup').classList.add('hidden');
    }

    /**
     * Show promotional popup on page load
     */
    function showPromoPopup() {
      const promoPopup = document.getElementById('promo-popup');

      // Check if user has already seen the popup in this session
      if (sessionStorage.getItem('promoPopupSeen')) {
        return;
      }

      // Show popup after a short delay for better UX
      setTimeout(() => {
        promoPopup.classList.remove('hidden');
        // Mark as seen for this session
        sessionStorage.setItem('promoPopupSeen', 'true');
      }, 2000);
    }

    /**
     * Close promotional popup
     */
    function closePromoPopup() {
      document.getElementById('promo-popup').classList.add('hidden');
    }

    /**
     * Close promotional popup and scroll to booking section
     */
    function closePromoAndScroll() {
      // Close the popup
      closePromoPopup();

      // Scroll to booking section
      const bookingSection = document.getElementById('booking');
      if (bookingSection) {
        bookingSection.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }

    /**
     * Get Stripe payment links based on center and appointment type
     * Now uses the 'kind' field for more reliable mapping
     */
    function getStripeLinks(centerId, appointmentTypeId) {
      // Get the appointment type object to access 'kind' field
      const types = APPOINTMENT_TYPES[String(centerId)] || [];
      const appointmentType = types.find(t => t.id === String(appointmentTypeId));

      if (!appointmentType) {
        console.error('Appointment type not found:', appointmentTypeId);
        return { onetime: '#', monthly: '#' };
      }

      // Rechute has no payment - return null
      if (appointmentType.kind === 'rechute') {
        return null;
      }

      // Get company
      const company = getCompany(centerId);

      // Stripe Payment Links Configuration
      const stripeLinks = {
        company1: {
          // Company 1: Madrid Chamart√≠n, Torrej√≥n, Majadahonda, San Sebasti√°n
          solo_cig: {
            onetime: 'https://buy.stripe.com/9B628q23B9si9Pv7mtawo00',  // ‚Ç¨170
            monthly: 'https://buy.stripe.com/4gM7sKeQn0VMd1H4ahawo06'   // 3√ó‚Ç¨60 (UPDATED)
          },
          duo_cig: {
            onetime: 'https://buy.stripe.com/28E9AS0ZxfQGd1H4ahawo01',   // ‚Ç¨320
            monthly: 'https://buy.stripe.com/9B64gyeQn7kabXD9uBawo07'    // 3√ó‚Ç¨105 (UPDATED)
          },
          solo_drugs: {
            onetime: 'https://buy.stripe.com/00w8wOgYvbAq6Dj36dawo02', // ‚Ç¨230
            monthly: 'https://buy.stripe.com/dRmfZggYvdIyf9P0Y5awo08'  // 3√ó‚Ç¨80 (UPDATED)
          },
          solo_sugar: {
            onetime: 'https://buy.stripe.com/4gM5kCaA7dIyaTz9uBawo09', // ‚Ç¨180
            monthly: 'https://buy.stripe.com/8x214maA7fQG7Hn36dawo0a'  // 3√ó‚Ç¨60
          }
        },
        company2: {
          // Company 2: Valencia, Barcelona Sants, Sevilla, Madrid Atocha
          solo_cig: {
            onetime: 'https://buy.stripe.com/8x25kD2JTcsdgsPdZ6dby08',  // ‚Ç¨170
            monthly: 'https://buy.stripe.com/14AeVd4S1ak55Obf3adby0e'   // 3√ó‚Ç¨60 (UPDATED)
          },
          duo_cig: {
            onetime: 'https://buy.stripe.com/8x2fZh3NX4ZL2BZ6wEdby09',   // ‚Ç¨320
            monthly: 'https://buy.stripe.com/7sYcN5dox3VH1xV08gdby0f'    // 3√ó‚Ç¨105 (UPDATED)
          },
          solo_drugs: {
            onetime: 'https://buy.stripe.com/cNi14nesB2RD4K78EMdby0a', // ‚Ç¨230
            monthly: 'https://buy.stripe.com/28E7sL3NX8bXdgDaMUdby0g'  // 3√ó‚Ç¨80 (UPDATED)
          },
          solo_sugar: {
            onetime: 'https://buy.stripe.com/5kQ14n7090Jv3G39IQdby0h', // ‚Ç¨180
            monthly: 'https://buy.stripe.com/9B6bJ198h3VH0tR8EMdby0i'  // 3√ó‚Ç¨60
          }
        }
      };

      // Get links for this company and kind
      const companyLinks = stripeLinks[company];
      return companyLinks[appointmentType.kind] || { onetime: '#', monthly: '#' };
    }

    /**
     * Select payment option
     */
    function selectPaymentOption(option) {
      const data = window.paymentPopupData;

      if (!data) {
        console.error('Payment popup data not available');
        return;
      }

      // Get appointment type details
      const types = APPOINTMENT_TYPES[String(bookingState.selectedCenter)] || [];
      const appointmentType = types.find(t => t.id === String(data.appointmentType.id));

      if (!appointmentType) {
        console.error('Appointment type not found');
        return;
      }

      if (option === 1) {
        // Pay at center
        closePaymentPopup();
      } else if (option === 2) {
        // Pay online once - redirect to Stripe
        const stripeLinks = getStripeLinks(bookingState.selectedCenter, data.appointmentType.id);

        if (!stripeLinks) {
          // Rechute - no payment needed
          alert('Reservas de reca√≠da no requieren pago. Contin√∫e con la reserva.');
          closePaymentPopup();
          return;
        }

        console.log('Opening Stripe one-time payment:', stripeLinks.onetime);
        console.log('Center:', bookingState.selectedCenter, 'Type:', appointmentType.kind);

        // Open Stripe payment link in new tab
        window.open(stripeLinks.onetime, '_blank');

        // Close popup
        closePaymentPopup();
      } else if (option === 3) {
        // Pay in 3 installments - redirect to Stripe subscription
        const stripeLinks = getStripeLinks(bookingState.selectedCenter, data.appointmentType.id);

        if (!stripeLinks) {
          // Rechute - no payment needed
          alert('Reservas de reca√≠da no requieren pago. Contin√∫e con la reserva.');
          closePaymentPopup();
          return;
        }

        console.log('Opening Stripe monthly payment:', stripeLinks.monthly);
        console.log('Center:', bookingState.selectedCenter, 'Type:', appointmentType.kind);

        // Open Stripe subscription link in new tab
        window.open(stripeLinks.monthly, '_blank');

        // Close popup
        closePaymentPopup();
      }
    }

    // ========== CALENDAR AND BOOKING LOGIC ==========

    // API Configuration - points to Render backend
    const API_BASE_URL = 'https://laserostop-backend.onrender.com/api';

    // Booking state
    let bookingState = {
      selectedCenter: null,
      selectedDate: null,
      selectedTime: null,
      currentMonth: new Date(),
      availableSlots: {}, // Will be populated from Smart Agenda API
      smartAgendaCenters: [], // Centers from Smart Agenda
      appointmentTypes: [], // Appointment types for selected center
      autoSelected: false // Track if slot was auto-selected
    };

    // Month names in Spanish
    const monthNames = [
      'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];

    // Day names in Spanish
    const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

    // ========== HARDCODED APPOINTMENT TYPES (Bypass Smart Agenda API sync issue) ==========

    /**
     * Static appointment types - Source of truth for UI
     * Note: This bypasses the Smart Agenda API /pdo_type_rdv endpoint which has sync issues
     * Availability and booking still use live API
     */
    // PROD APPOINTMENT TYPES - Filtered to show only original 4 types (matching TEST/DEV)
    // Source: https://www.smartagenda.fr/pro/laserostop-esh (PROD environment)
    // Showing: Solo 190‚Ç¨, Duo 170‚Ç¨, Cannabis 190‚Ç¨, Reca√≠da (same as TEST had)
    // Mapping: Valencia=10, Barcelona=43, Sevilla=44, Chamartin=48, Torrejon=49, Atocha=50, Majadahonda=51, San Sebastian=52
    const APPOINTMENT_TYPES = {
      '10': [ // Valencia - 5 types (added sugar)
        { id: '1',  kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 190, deposit: 0, centerId: '10' },
        { id: '9',  kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 170, deposit: 0, centerId: '10' },
        { id: '18', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 250, deposit: 0, centerId: '10' },
        { id: '3',  kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '10' },
        { id: '98', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 200, deposit: 0, centerId: '10' }
      ],
      '43': [ // Barcelona - 5 types (added sugar)
        { id: '20', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 190, deposit: 0, centerId: '43' },
        { id: '21', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 170, deposit: 0, centerId: '43' },
        { id: '23', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 250, deposit: 0, centerId: '43' },
        { id: '22', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '43' },
        { id: '91', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 200, deposit: 0, centerId: '43' }
      ],
      '44': [ // Sevilla - 5 types (added sugar)
        { id: '32', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 190, deposit: 0, centerId: '44' },
        { id: '34', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 170, deposit: 0, centerId: '44' },
        { id: '37', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 250, deposit: 0, centerId: '44' },
        { id: '35', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '44' },
        { id: '96', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 200, deposit: 0, centerId: '44' }
      ],
      '49': [ // Torrej√≥n - 5 types (added sugar)
        { id: '53', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 190, deposit: 0, centerId: '49' },
        { id: '56', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 170, deposit: 0, centerId: '49' },
        { id: '59', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 250, deposit: 0, centerId: '49' },
        { id: '57', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '49' },
        { id: '97', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 200, deposit: 0, centerId: '49' }
      ],
      '48': [ // Madrid Chamart√≠n - 5 types (added sugar)
        { id: '44', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 190, deposit: 0, centerId: '48' },
        { id: '46', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 170, deposit: 0, centerId: '48' },
        { id: '49', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 250, deposit: 0, centerId: '48' },
        { id: '47', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '48' },
        { id: '93', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 200, deposit: 0, centerId: '48' }
      ],
      '50': [ // Madrid Atocha - 5 types (added sugar)
        { id: '63', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 190, deposit: 0, centerId: '50' },
        { id: '65', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 170, deposit: 0, centerId: '50' },
        { id: '68', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 250, deposit: 0, centerId: '50' },
        { id: '66', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '50' },
        { id: '92', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 200, deposit: 0, centerId: '50' }
      ],
      '52': [ // San Sebasti√°n - 5 types (added sugar)
        { id: '81', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 190, deposit: 0, centerId: '52' },
        { id: '83', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 170, deposit: 0, centerId: '52' },
        { id: '86', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 250, deposit: 0, centerId: '52' },
        { id: '84', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '52' },
        { id: '95', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 200, deposit: 0, centerId: '52' }
      ],
      '51': [ // Majadahonda - 5 types (added sugar)
        { id: '72', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 190, deposit: 0, centerId: '51' },
        { id: '74', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 170, deposit: 0, centerId: '51' },
        { id: '77', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 250, deposit: 0, centerId: '51' },
        { id: '75', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '51' },
        { id: '94', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 200, deposit: 0, centerId: '51' }
      ]
    };

    /**
     * Price table - Single source of truth for payment UI
     */
    const PRICE_TABLE = {
      solo_cig:   { centerOld: 250, center: 190, online: 170, plan: [60, 60, 60] },
      duo_cig:    { centerOld: 400, center: 340, online: 320, plan: [105, 105, 105] },
      solo_drugs: { centerOld: 300, center: 250, online: 230, plan: [80, 80, 80] },
      rechute:    { center: 0 },
      solo_sugar: { centerOld: 280, center: 200, online: 180, plan: [60, 60, 60] }
    };

    /**
     * Company routing - determines which Stripe account to use
     * FIXED: Using correct pdo_agenda IDs
     */
    const COMPANY1_CENTERS = new Set(['48', '49', '51', '52']); // Madrid Chamart√≠n, Torrej√≥n, Majadahonda, San Sebasti√°n
    const COMPANY2_CENTERS = new Set(['10', '43', '44', '50']);  // Valencia, Barcelona Sants, Sevilla, Madrid Atocha

    function getCompany(centerId) {
      return COMPANY1_CENTERS.has(String(centerId)) ? 'company1' : 'company2';
    }

    // ========== API FUNCTIONS ==========

    /**
     * Load centers from Smart Agenda API with retry logic
     * Handles Render.com cold starts and network timeouts
     */
    async function loadCentersFromAPI(retries = 3) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          console.log(`Loading centers from Smart Agenda... (attempt ${attempt}/${retries})`);

          // Add 60-second timeout to handle Render cold starts
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 seconds

          const response = await fetch(`${API_BASE_URL}/centers`, {
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const centers = await response.json();

          // Validate response
          if (!centers || centers.length === 0) {
            throw new Error('Empty centers response from API');
          }

          bookingState.smartAgendaCenters = centers;
          console.log('‚úÖ Loaded', centers.length, 'centers from Smart Agenda');

          // Populate the center dropdown
          populateCenterDropdown(centers);

          return centers;

        } catch (error) {
          console.error(`‚ùå Attempt ${attempt} failed:`, error.message);

          // If not the last attempt, retry with exponential backoff
          if (attempt < retries) {
            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000); // 1s, 2s, 4s max
            console.log(`‚è≥ Retrying in ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          } else {
            // Final attempt failed - show error to user
            console.error('‚ùå All retry attempts failed');
            alert('Error al cargar los centros. Por favor, recargue la p√°gina.');
            return [];
          }
        }
      }
    }

    /**
     * Populate center dropdown with API data - Grouped by city
     */
    function populateCenterDropdown(centers) {
      const select = document.getElementById('center-select');

      // Clear existing options
      select.innerHTML = '<option value="">Seleccione su ciudad y centro...</option>';

      // Define city groups with their centers
      const cityGroups = {
        'Madrid': [
          { id: '50', name: 'Madrid ‚Äì Atocha' },
          { id: '48', name: 'Madrid ‚Äì Chamart√≠n' },
          { id: '51', name: 'Madrid ‚Äì Majadahonda' },
          { id: '49', name: 'Madrid ‚Äì Torrej√≥n de Ardoz' }
        ],
        'Barcelona': [
          { id: '43', name: 'Barcelona' }
        ],
        'San Sebasti√°n': [
          { id: '52', name: 'San Sebasti√°n' }
        ],
        'Sevilla': [
          { id: '44', name: 'Sevilla' }
        ],
        'Valencia': [
          { id: '10', name: 'Valencia' }
        ]
      };

      // Create optgroups for each city
      Object.entries(cityGroups).forEach(([city, cityCenters]) => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = city;

        cityCenters.forEach(center => {
          // Check if this center exists in the API data
          const centerExists = centers.find(c => c.id === center.id);
          if (centerExists) {
            const option = document.createElement('option');
            option.value = center.id;
            option.textContent = center.name;
            optgroup.appendChild(option);
          }
        });

        // Only add optgroup if it has at least one center
        if (optgroup.children.length > 0) {
          select.appendChild(optgroup);
        }
      });
    }

    /**
     * Load appointment types for selected center
     * NOTE: Using hardcoded data instead of API due to Smart Agenda sync issues
     */
    async function loadAppointmentTypes(centerId) {
      try {
        console.log('Loading appointment types for center:', centerId);

        // Use hardcoded data instead of API
        const types = APPOINTMENT_TYPES[centerId] || [];
        bookingState.appointmentTypes = types;

        console.log('Loaded', types.length, 'appointment types (from static data)');

        // Warn if no appointment types available
        if (types.length === 0) {
          console.warn('‚ö†Ô∏è No appointment types available for this center');
          const centerName = bookingState.smartAgendaCenters.find(c => c.id === centerId)?.name;
          alert(`‚ö†Ô∏è Atenci√≥n:\n\nEl centro "${centerName}" no tiene citas disponibles a trav√©s de este formulario.\n\nPor favor:\n- Seleccione otro centro\n- O contacte directamente con el centro.`);
        }

        // Auto-select the first type if available
        if (types.length > 0) {
          bookingState.selectedAppointmentType = types[0].id;
        }

        return types;
      } catch (error) {
        console.error('Error loading appointment types:', error);
        return [];
      }
    }

    /**
     * Load availability for selected date range
     * FIXED: Now uses correct Smart Agenda service endpoint
     */
    async function loadAvailability(startDate, endDate) {
      if (!bookingState.selectedCenter || !bookingState.selectedAppointmentType) {
        console.log('Center or appointment type not selected');
        return {};
      }

      try {
        console.log('Loading availability from', formatDateForAPI(startDate), 'to', formatDateForAPI(endDate));

        const params = new URLSearchParams({
          centerId: bookingState.selectedCenter,  // Center ID (pdo_groupe)
          typeId: bookingState.selectedAppointmentType,
          startDate: formatDateForAPI(startDate),
          endDate: formatDateForAPI(endDate)
        });

        const response = await fetch(`${API_BASE_URL}/availability?${params.toString()}`);

        if (!response.ok) {
          if (response.status === 404) {
            console.warn('‚ö†Ô∏è No availability found - Time slots may not be opened in Smart Agenda dashboard');
            bookingState.availableSlots = {};
            return {};
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const availability = await response.json();
        console.log('‚úÖ Availability data loaded:', availability.length, 'days');

        bookingState.availableSlots = processAvailabilityData(availability);

        return bookingState.availableSlots;
      } catch (error) {
        console.error('‚ùå Error loading availability:', error);
        bookingState.availableSlots = {};
        return {};
      }
    }

    /**
     * Process availability data from API into time slots format
     * Smart Agenda format: Array of {dj: 'YYYY-MM-DD', det: [{idp: 'HH:MM', ...}, ...]}
     */
    function processAvailabilityData(apiData) {
      const slots = {};

      if (!Array.isArray(apiData)) {
        console.warn('Invalid availability data format');
        return slots;
      }

      // Process each day
      apiData.forEach(day => {
        const dateKey = day.dj; // Date in YYYY-MM-DD format
        if (!dateKey || !day.det || !Array.isArray(day.det)) {
          return;
        }

        // Create slots object for this date
        slots[dateKey] = {};

        // Process each time slot
        day.det.forEach(slot => {
          // FIXED: Smart Agenda uses 'idp' field, not 'hd'
          if (slot.idp) {
            const time = slot.idp; // Already in 'HH:MM' format
            slots[dateKey][time] = true;
          }
        });
      });

      console.log('Processed availability slots:', Object.keys(slots).length, 'days');

      // Apply slot filtering to create scarcity perception
      return applySlotFiltering(slots);
    }

    // ========== SLOT FILTERING SYSTEM ==========
    // Strategy: Show limited slots per day to create urgency and distribute bookings evenly
    // Different users see different slots based on fingerprint + date hash

    /**
     * Slot filtering configuration
     */
    const SLOT_FILTER_CONFIG = {
      enabled: true,              // Master toggle
      maxSlotsPerDay: 4,         // Maximum slots to show per day
      minSpacingMinutes: 60,     // Minimum minutes between displayed slots
      showAllIfFewer: 4          // If total slots <= this, show all
    };

    /**
     * Generate anonymous user fingerprint for consistent slot selection
     * Uses browser characteristics (no personal data)
     */
    function getUserFingerprint() {
      // Try to get cached fingerprint first
      let fingerprint = sessionStorage.getItem('userFingerprint');

      if (!fingerprint) {
        // Create fingerprint from browser metadata
        const components = [
          navigator.userAgent,
          navigator.language,
          screen.width + 'x' + screen.height,
          screen.colorDepth,
          new Date().getTimezoneOffset(),
          navigator.hardwareConcurrency || 0,
          navigator.platform
        ];

        // Simple hash function
        let hash = 0;
        const str = components.join('|');
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32-bit integer
        }

        fingerprint = Math.abs(hash).toString(36);
        sessionStorage.setItem('userFingerprint', fingerprint);
      }

      return fingerprint;
    }

    /**
     * Seeded random number generator for deterministic shuffling
     * Same seed always produces same sequence
     */
    function seededRandom(seed) {
      let value = seed;
      return function() {
        value = (value * 9301 + 49297) % 233280;
        return value / 233280;
      };
    }

    /**
     * Shuffle array using seeded random (deterministic)
     */
    function seededShuffle(array, seed) {
      const shuffled = [...array];
      const random = seededRandom(seed);

      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }

      return shuffled;
    }

    /**
     * Convert time string (HH:MM) to minutes since midnight
     */
    function timeToMinutes(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    /**
     * Simple string hash function
     */
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash);
    }

    /**
     * Filter slots for a single date to show limited selection
     */
    function filterSlotsForDate(times, date, userFingerprint) {
      if (!SLOT_FILTER_CONFIG.enabled) {
        return times; // Filtering disabled, return all
      }

      if (times.length <= SLOT_FILTER_CONFIG.showAllIfFewer) {
        return times; // Show all if few slots available
      }

      // Generate deterministic seed from fingerprint + date
      const seed = simpleHash(userFingerprint + date);

      // Shuffle slots deterministically
      const shuffled = seededShuffle(times, seed);

      // Select slots with minimum spacing
      const selected = [];

      for (const time of shuffled) {
        if (selected.length >= SLOT_FILTER_CONFIG.maxSlotsPerDay) {
          break;
        }

        // Check if time has minimum spacing from all selected slots
        const timeMinutes = timeToMinutes(time);
        const hasMinimumSpacing = selected.every(selectedTime => {
          const selectedMinutes = timeToMinutes(selectedTime);
          return Math.abs(timeMinutes - selectedMinutes) >= SLOT_FILTER_CONFIG.minSpacingMinutes;
        });

        if (hasMinimumSpacing || selected.length === 0) {
          selected.push(time);
        }
      }

      // Return in chronological order
      return selected.sort();
    }

    /**
     * Apply slot filtering to all dates
     */
    function applySlotFiltering(allSlots) {
      if (!SLOT_FILTER_CONFIG.enabled) {
        return allSlots; // Return unfiltered if disabled
      }

      const fingerprint = getUserFingerprint();
      const filteredSlots = {};

      // Process each date
      for (const dateKey in allSlots) {
        const times = Object.keys(allSlots[dateKey]).sort();
        const filteredTimes = filterSlotsForDate(times, dateKey, fingerprint);

        // Rebuild slots object with filtered times
        filteredSlots[dateKey] = {};
        filteredTimes.forEach(time => {
          filteredSlots[dateKey][time] = true;
        });

        console.log(`üìä Date ${dateKey}: ${times.length} slots ‚Üí ${filteredTimes.length} shown`);
      }

      console.log('‚úÖ Slot filtering applied - User fingerprint:', fingerprint.substring(0, 8) + '...');
      return filteredSlots;
    }

    /**
     * Format date for API (YYYY-MM-DD)
     */
    function formatDateForAPI(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * Format datetime for API (YYYY-MM-DD HH:MM:SS)
     */
    function formatDateTimeForAPI(date, time) {
      return `${formatDateForAPI(date)} ${time}:00`;
    }

    /**
     * Submit booking to Smart Agenda
     */
    async function submitBooking() {
      try {
        console.log('Submitting booking to Smart Agenda...');

        // Calculate end time (assuming 30 min appointment)
        const startDateTime = formatDateTimeForAPI(bookingState.selectedDate, bookingState.selectedTime);
        const endTime = bookingState.selectedTime.split(':');
        const endHour = parseInt(endTime[0]);
        let endMin = parseInt(endTime[1]) + 30;
        let finalEndHour = endHour;

        // Handle minute overflow
        if (endMin >= 60) {
          finalEndHour = endHour + 1;
          endMin = endMin - 60;
        }

        const endDateTime = formatDateTimeForAPI(
          bookingState.selectedDate,
          `${String(finalEndHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`
        );

        // Use appointment type from loaded types
        let typeId = bookingState.selectedAppointmentType;

        // If no appointment type is selected, try to use the first available one
        if (!typeId && bookingState.appointmentTypes && bookingState.appointmentTypes.length > 0) {
          typeId = bookingState.appointmentTypes[0].id;
          console.log('Auto-selected first appointment type:', typeId);
        }

        // If still no appointment type, this center doesn't have any configured
        if (!typeId) {
          throw new Error('Este centro no tiene tipos de cita configurados. Por favor, seleccione otro centro o use el enlace de reserva directo del centro.');
        }

        // Detect URL source for tracking
        const urlPath = window.location.pathname;
        const urlSlug = urlPath.split('/').filter(p => p)[0];
        const source = urlSlug || 'direct';

        const bookingData = {
          fullName: bookingState.fullName,
          email: bookingState.email,
          phone: bookingState.phone,
          centerId: bookingState.selectedCenter,
          typeId: typeId,
          startTime: startDateTime,
          endTime: endDateTime,
          source: source // Track where booking came from
        };

        console.log('Booking data:', bookingData);

        const response = await fetch(`${API_BASE_URL}/booking`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(bookingData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Backend error response:', errorData);
          throw new Error(errorData.details || errorData.message || errorData.error || 'Booking failed');
        }

        const result = await response.json();
        console.log('‚úÖ Booking successful:', result);

        return result;
      } catch (error) {
        console.error('‚ùå Error submitting booking:', error);
        throw error;
      }
    }

    // Sample time slots (fallback for when API doesn't return data)
    const sampleTimeSlots = {
      '09:00': true,
      '09:30': true,
      '10:00': true,
      '10:30': false, // unavailable
      '11:00': true,
      '11:30': true,
      '12:00': false, // unavailable
      '14:00': true,
      '14:30': true,
      '15:00': true,
      '15:30': true,
      '16:00': true,
      '16:30': false, // unavailable
      '17:00': true,
      '17:30': true,
      '18:00': true
    };

    // Generate calendar for current month
    function generateCalendar() {
      const year = bookingState.currentMonth.getFullYear();
      const month = bookingState.currentMonth.getMonth();

      // Update month display
      document.getElementById('current-month').textContent =
        `${monthNames[month]} ${year}`;

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();

      // Get day of week for first day (0 = Sunday, adjust to Monday = 0)
      let startDay = firstDay.getDay() - 1;
      if (startDay === -1) startDay = 6; // Sunday becomes 6

      // Get today's date for comparison
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const calendarGrid = document.getElementById('calendar-grid');
      calendarGrid.innerHTML = '';

      // Add empty cells for days before month starts
      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'text-gray-400 text-sm';
        calendarGrid.appendChild(emptyCell);
      }

      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayCell = document.createElement('div');

        const isPast = date < today;
        const isSunday = date.getDay() === 0; // Sunday = 0 (centers closed)
        const isSelected = bookingState.selectedDate &&
          date.toDateString() === bookingState.selectedDate.toDateString();
        const isToday = date.toDateString() === today.toDateString();

        // Base classes
        let classes = 'text-sm py-2 rounded-full transition-all';

        if (isPast || isSunday) {
          // Past dates or Sundays - disabled (centers closed on Sundays)
          classes += ' text-gray-400 cursor-not-allowed';
        } else if (isSelected) {
          // Selected date
          classes += ' bg-primary text-white cursor-pointer font-semibold transform scale-110';
        } else if (isToday) {
          // Today
          classes += ' bg-primary/20 border-2 border-primary text-primary cursor-pointer font-semibold hover:bg-primary/30';
        } else {
          // Future dates - selectable
          classes += ' hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer';
        }

        dayCell.className = classes;
        dayCell.textContent = day;

        // Add click handler for future dates (excluding Sundays)
        if (!isPast && !isSunday) {
          dayCell.onclick = () => selectDate(date);
        }

        calendarGrid.appendChild(dayCell);
      }
    }

    // Select a date
    function selectDate(date) {
      bookingState.selectedDate = date;
      bookingState.selectedTime = null; // Reset time selection

      generateCalendar(); // Refresh calendar to show selection
      generateTimeSlots(); // Show available time slots
      updateStepIndicators(); // Update visual indicators

      // Auto-scroll to time slots section for better UX - DISABLED
      // setTimeout(() => {
      //   document.getElementById('time-slots-section').scrollIntoView({
      //     behavior: 'smooth',
      //     block: 'start'
      //   });
      // }, 100);
    }

    // Generate time slots for selected date
    function generateTimeSlots() {
      const timeSlotsContainer = document.getElementById('time-slots');
      const dateInfo = document.getElementById('selected-date-info');

      if (!bookingState.selectedDate) {
        timeSlotsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-4">Seleccione una fecha para ver los horarios disponibles</p>';
        dateInfo.textContent = '';
        return;
      }

      // Show selected date
      const dayName = dayNames[bookingState.selectedDate.getDay()];
      const day = bookingState.selectedDate.getDate();
      const month = monthNames[bookingState.selectedDate.getMonth()];
      const year = bookingState.selectedDate.getFullYear();
      dateInfo.textContent = `Horarios para ${dayName}, ${day} de ${month} de ${year}`;

      // Get available slots for selected date
      const dateKey = formatDateForAPI(bookingState.selectedDate);
      const daySlots = bookingState.availableSlots[dateKey] || {};

      // Generate time slot buttons
      timeSlotsContainer.innerHTML = '';

      // If no slots available for this date, show message
      if (Object.keys(daySlots).length === 0) {
        timeSlotsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-4">‚ö†Ô∏è No hay horarios disponibles para esta fecha. Por favor, seleccione otra fecha o contacte al centro.</p>';
        return;
      }

      // Sort times and generate buttons
      const times = Object.keys(daySlots).sort();
      times.forEach(time => {
        const available = daySlots[time];
        const button = document.createElement('button');

        const isSelected = bookingState.selectedTime === time;

        if (isSelected) {
          button.className = 'py-2 px-3 bg-primary text-white rounded-full border border-primary font-semibold';
        } else if (available) {
          button.className = 'py-2 px-3 border border-border-light dark:border-border-dark rounded-full hover:border-primary hover:text-primary transition';
          button.onclick = () => selectTime(time);
        } else {
          button.className = 'py-2 px-3 border border-border-light dark:border-border-dark rounded-full text-gray-400 cursor-not-allowed opacity-50';
          button.disabled = true;
        }

        button.textContent = time;
        timeSlotsContainer.appendChild(button);
      });
    }

    // Select a time slot
    function selectTime(time) {
      bookingState.selectedTime = time;
      generateTimeSlots(); // Refresh to show selection
      updateStepIndicators(); // Update visual indicators

      // Auto-scroll to user info form for better UX - DISABLED
      // setTimeout(() => {
      //   document.getElementById('step-3').scrollIntoView({
      //     behavior: 'smooth',
      //     block: 'start'
      //   });
      // }, 100);

      console.log('Booking state:', bookingState);
      // This will be used later for Smart Agenda API call
    }

    /**
     * Auto-select the soonest available date and time slot
     * Called after availability data is loaded
     */
    function autoSelectSoonestSlot() {
      // Check if we have availability data
      if (!bookingState.availableSlots || Object.keys(bookingState.availableSlots).length === 0) {
        console.log('No availability data to auto-select');
        return;
      }

      // Get all dates sorted chronologically
      const availableDates = Object.keys(bookingState.availableSlots)
        .sort() // Already in YYYY-MM-DD format, sorts correctly
        .map(dateStr => new Date(dateStr));

      if (availableDates.length === 0) {
        console.log('No available dates found');
        return;
      }

      // Find the first future date (not in the past)
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const soonestDate = availableDates.find(date => date >= today);

      if (!soonestDate) {
        console.log('No future dates available');
        return;
      }

      // Get time slots for this date
      const dateKey = formatDateForAPI(soonestDate);
      const daySlots = bookingState.availableSlots[dateKey] || {};
      const availableTimes = Object.keys(daySlots).sort(); // Sort times: 09:00, 10:00, etc.

      if (availableTimes.length === 0) {
        console.log('No time slots available for soonest date');
        return;
      }

      const earliestTime = availableTimes[0];

      // Auto-select the date and time
      console.log(`‚ú® Auto-selecting: ${dateKey} at ${earliestTime}`);

      bookingState.selectedDate = soonestDate;
      bookingState.selectedTime = earliestTime;
      bookingState.autoSelected = true; // Flag to show it was auto-selected

      // Update calendar month to show the selected date's month
      bookingState.currentMonth = new Date(soonestDate.getFullYear(), soonestDate.getMonth(), 1);

      // Update UI
      generateCalendar(); // Refresh calendar with selection
      generateTimeSlots(); // Show time slots with selection
      updateStepIndicators();

      // Show notification to user
      showAutoSelectNotification(soonestDate, earliestTime);

      // Scroll to time slots so user sees the selection - DISABLED
      // setTimeout(() => {
      //   document.getElementById('time-slots-section').scrollIntoView({
      //     behavior: 'smooth',
      //     block: 'start'
      //   });
      // }, 500);
    }

    /**
     * Show notification that a slot was auto-selected
     */
    function showAutoSelectNotification(date, time) {
      const dayName = dayNames[date.getDay()];
      const day = date.getDate();
      const month = monthNames[date.getMonth()];

      const notification = document.createElement('div');
      notification.className = 'bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4 rounded mb-4 animate-fade-in';
      notification.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="material-icons text-green-600 text-xl">check_circle</span>
          <div>
            <p class="font-semibold text-green-800 dark:text-green-200">
              ‚ú® Preseleccionado para ti
            </p>
            <p class="text-sm text-green-700 dark:text-green-300 mt-1">
              ${dayName}, ${day} de ${month} a las ${time}
              <span class="text-xs block mt-1 opacity-75">Puedes cambiar la fecha y hora si lo deseas</span>
            </p>
          </div>
        </div>
      `;

      // Insert before calendar
      const step2 = document.getElementById('step-2');
      const calendarDiv = step2.querySelector('.bg-gray-50');
      if (calendarDiv && calendarDiv.parentElement) {
        calendarDiv.parentElement.insertBefore(notification, calendarDiv);

        // Auto-remove after 10 seconds
        setTimeout(() => {
          notification.style.transition = 'opacity 0.5s';
          notification.style.opacity = '0';
          setTimeout(() => notification.remove(), 500);
        }, 10000);
      }
    }

    // Navigate to previous month
    document.getElementById('prev-month').addEventListener('click', () => {
      bookingState.currentMonth.setMonth(bookingState.currentMonth.getMonth() - 1);

      // Load availability for new month
      if (bookingState.selectedCenter && bookingState.selectedAppointmentType) {
        // Start from tomorrow to avoid timezone issues with Smart Agenda
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const firstOfMonth = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth(), 1);
        const startDate = firstOfMonth < tomorrow ? tomorrow : firstOfMonth;

        // End date: last day of current month OR 30 days from start (whichever is later)
        const lastDayOfMonth = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth() + 1, 0);
        const thirtyDaysOut = new Date(startDate);
        thirtyDaysOut.setDate(startDate.getDate() + 30);
        const endDate = lastDayOfMonth > startDate ? lastDayOfMonth : thirtyDaysOut;

        loadAvailability(startDate, endDate).then(() => {
          generateCalendar();
        });
      } else {
        generateCalendar();
      }
    });

    // Navigate to next month
    document.getElementById('next-month').addEventListener('click', () => {
      bookingState.currentMonth.setMonth(bookingState.currentMonth.getMonth() + 1);

      // Load availability for new month
      if (bookingState.selectedCenter && bookingState.selectedAppointmentType) {
        // Start from tomorrow to avoid timezone issues with Smart Agenda
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const firstOfMonth = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth(), 1);
        const startDate = firstOfMonth < tomorrow ? tomorrow : firstOfMonth;

        // End date: last day of current month OR 30 days from start (whichever is later)
        const lastDayOfMonth = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth() + 1, 0);
        const thirtyDaysOut = new Date(startDate);
        thirtyDaysOut.setDate(startDate.getDate() + 30);
        const endDate = lastDayOfMonth > startDate ? lastDayOfMonth : thirtyDaysOut;

        loadAvailability(startDate, endDate).then(() => {
          generateCalendar();
        });
      } else {
        generateCalendar();
      }
    });

    // Update booking state when center is selected
    document.getElementById('center-select').addEventListener('change', async (e) => {
      bookingState.selectedCenter = e.target.value;
      console.log('Selected center:', bookingState.selectedCenter);

      // Show visual feedback
      updateStepIndicators();

      // Reset selection
      bookingState.selectedDate = null;
      bookingState.selectedTime = null;
      bookingState.selectedAppointmentType = null;

      if (bookingState.selectedCenter) {
        // Load appointment types for this center
        await loadAppointmentTypes(bookingState.selectedCenter);

        // Show booking type selector and populate it
        populateBookingTypeDropdown(bookingState.appointmentTypes);

        // Load availability for current month
        const startDate = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth(), 1);
        const endDate = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth() + 1, 0);
        await loadAvailability(startDate, endDate);
      } else {
        // Hide booking type selector if no center selected
        document.getElementById('step-1b').classList.add('hidden');
        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('step-3').classList.add('hidden');
        document.getElementById('step-4').classList.add('hidden');
      }

      generateCalendar();
      generateTimeSlots();
    });

    /**
     * Strip HTML tags from text
     */
    function stripHTML(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || '';
    }

    // Populate booking type dropdown
    function populateBookingTypeDropdown(types) {
      const select = document.getElementById('booking-type-select');
      const step1b = document.getElementById('step-1b');

      // Clear existing options except the first one
      select.innerHTML = '<option value="">Seleccione el tipo de sesi√≥n...</option>';

      if (types && types.length > 0) {
        // Show ALL appointment types (no filtering)
        // Types will auto-hide if deleted from Smart Agenda backend
        const centerPaymentTypes = types;

        if (centerPaymentTypes.length === 0) {
          console.warn('No appointment types available');
          step1b.classList.add('hidden');
          return;
        }

        // Add types to dropdown
        centerPaymentTypes.forEach(type => {
          const option = document.createElement('option');
          option.value = type.id;
          option.textContent = type.name;
          option.dataset.price = type.price !== undefined ? type.price : '190';  // Handle 0 correctly
          option.dataset.duration = type.duration || '30';

          // Strip HTML from description
          const cleanDescription = stripHTML(type.description || '').trim();
          option.dataset.description = cleanDescription || 'Pago en el centro';

          select.appendChild(option);
        });

        // Show the booking type section
        step1b.classList.remove('hidden');

        // ‚úÖ AUTO-SELECT FIRST APPOINTMENT TYPE
        // Automatically select the first type and trigger change event
        // This loads availability and shows calendar without requiring manual selection
        if (centerPaymentTypes.length > 0) {
          select.value = centerPaymentTypes[0].id;
          select.dispatchEvent(new Event('change'));
          console.log('‚úÖ Auto-selected first appointment type:', centerPaymentTypes[0].name);
        }
      } else {
        // Hide the booking type section if no types available
        step1b.classList.add('hidden');
      }
    }

    // Handle booking type selection
    document.getElementById('booking-type-select').addEventListener('change', (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      bookingState.selectedAppointmentType = e.target.value;

      const infoBox = document.getElementById('booking-type-info');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const step4 = document.getElementById('step-4');

      if (bookingState.selectedAppointmentType) {
        // Show type details
        const duration = selectedOption.dataset.duration || '30';
        const price = selectedOption.dataset.price || '190';
        const description = selectedOption.dataset.description || '-';

        document.getElementById('type-duration').textContent = `${duration} minutos`;
        document.getElementById('type-price').textContent = `‚Ç¨${price}`;
        document.getElementById('type-description').textContent = description;

        // Check if this is a Rechute (free) session
        const typeName = selectedOption.textContent.toLowerCase();
        const isRechute = price === '0' || typeName.includes('rechute') || typeName.includes('reca√≠da');

        // Remove any existing disclaimer
        const existingDisclaimer = infoBox.querySelector('.rechute-disclaimer');
        if (existingDisclaimer) {
          existingDisclaimer.remove();
        }

        // Add Rechute disclaimer if applicable
        if (isRechute) {
          const disclaimer = document.createElement('div');
          disclaimer.className = 'rechute-disclaimer mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 rounded';
          disclaimer.innerHTML = `
            <div class="flex items-start gap-3">
              <span class="material-icons text-yellow-600 text-xl">warning</span>
              <div>
                <p class="font-semibold text-yellow-800 dark:text-yellow-200">‚ö†Ô∏è Sesi√≥n de Reca√≠da</p>
                <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">
                  Su elegibilidad ser√° verificada para confirmar que ya complet√≥ una sesi√≥n previa con LaserOstop.
                </p>
              </div>
            </div>
          `;
          infoBox.appendChild(disclaimer);

          // Store flag to prevent payment popup later
          bookingState.isRechuteSession = true;
        } else {
          bookingState.isRechuteSession = false;
        }

        infoBox.classList.remove('hidden');

        // Show next steps
        step2.classList.remove('hidden');
        step3.classList.remove('hidden');
        step4.classList.remove('hidden');

        // Update step indicators
        updateStepIndicators();

        // Load availability for next 3 months when appointment type is selected
        // Start from tomorrow to avoid timezone issues with Smart Agenda
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const startDate = new Date(tomorrow);

        // End date: 3 months from tomorrow (90 days)
        const threeMonthsOut = new Date(startDate);
        threeMonthsOut.setDate(startDate.getDate() + 90);
        const endDate = threeMonthsOut;

        console.log(`üìÖ Loading availability for 3 months: ${formatDateForAPI(startDate)} to ${formatDateForAPI(endDate)}`);

        loadAvailability(startDate, endDate).then(() => {
          generateCalendar(); // Refresh calendar with availability data
          autoSelectSoonestSlot(); // Auto-select the soonest available slot across all 3 months
        });

        // Auto-scroll to calendar section for better UX - DISABLED
        // setTimeout(() => {
        //   document.getElementById('step-2').scrollIntoView({
        //     behavior: 'smooth',
        //     block: 'start'
        //   });
        // }, 300);

        console.log('Selected appointment type:', bookingState.selectedAppointmentType);
      } else {
        // Hide type details and next steps
        infoBox.classList.add('hidden');
        step2.classList.add('hidden');
        step3.classList.add('hidden');
        step4.classList.add('hidden');
      }
    });

    // Update step completion indicators
    function updateStepIndicators() {
      const step1 = document.querySelector('#step-1 h2');
      const step1b = document.querySelector('#step-1b h2');
      const step2 = document.querySelector('#step-2 h2');
      const step3 = document.querySelector('#step-3 h2');

      // Step 1: Center selected
      if (bookingState.selectedCenter) {
        if (!step1.querySelector('.material-icons.text-green-500')) {
          step1.innerHTML = '<span class="text-primary mr-3">1.</span>Elija su centro <span class="material-icons text-green-500 align-middle ml-2">check_circle</span>';
        }
      } else {
        step1.innerHTML = '<span class="text-primary mr-3">1.</span>Elija su centro';
      }

      // Step 1b (2): Booking type selected
      if (step1b) {
        if (bookingState.selectedAppointmentType) {
          if (!step1b.querySelector('.material-icons.text-green-500')) {
            step1b.innerHTML = '<span class="text-primary mr-3">2.</span>Tipo de sesi√≥n <span class="material-icons text-green-500 align-middle ml-2">check_circle</span>';
          }
        } else {
          step1b.innerHTML = '<span class="text-primary mr-3">2.</span>Tipo de sesi√≥n';
        }
      }

      // Step 2 (now 3): Date and time selected
      if (step2) {
        if (bookingState.selectedDate && bookingState.selectedTime) {
          if (!step2.querySelector('.material-icons.text-green-500')) {
            step2.innerHTML = '<span class="text-primary mr-3">3.</span>Elija una fecha y una hora <span class="material-icons text-green-500 align-middle ml-2">check_circle</span>';
          }
        } else {
          step2.innerHTML = '<span class="text-primary mr-3">3.</span>Elija una fecha y una hora';
        }
      }
    }

    // Initialize calendar on load
    function initializeCalendar() {
      generateCalendar();
      generateTimeSlots();
    }

    // URL slug to center ID mapping (PROD pdo_agenda IDs)
    const CENTER_URL_MAPPING = {
      'barcelona-sants': '43',       // Barcelona Sants
      'barcelona': '43',             // Barcelona (alias)
      'valencia': '10',              // Valencia
      'madrid-atocha': '50',         // Madrid Atocha
      'madrid-chamartin': '48',      // Madrid Chamart√≠n
      'sevilla': '44',               // Sevilla
      'majadahonda': '51',           // Majadahonda
      'san-sebastian': '52',         // San Sebasti√°n de Los Reyes
      'torrejon': '49'               // Torrej√≥n de Ardoz
    };

    /**
     * Detect center from URL path
     */
    function getCenterFromURL() {
      const path = window.location.pathname;
      const segments = path.split('/').filter(p => p);

      // For /laserostop_espagna/valencia -> segments = ['laserostop_espagna', 'valencia']
      // We want the second segment (index 1)
      const slug = segments.length > 1 ? segments[1] : null;

      const centerId = slug ? CENTER_URL_MAPPING[slug] : null;

      if (centerId) {
        console.log('üìç Detected center from URL:', slug, '‚Üí Center ID:', centerId);
      } else if (slug) {
        console.log('üìç URL slug detected but not in mapping:', slug);
      }

      return centerId || null;
    }

    /**
     * Auto-select center if URL contains center slug
     */
    async function autoSelectCenterFromURL() {
      const centerId = getCenterFromURL();

      if (centerId) {
        // Wait for centers to be loaded
        if (bookingState.smartAgendaCenters.length === 0) {
          console.log('‚è≥ Waiting for centers to load before auto-selecting...');
          return centerId; // Return for later use
        }

        // Check if this center exists
        const centerExists = bookingState.smartAgendaCenters.find(c => c.id === centerId);

        if (centerExists) {
          console.log('‚úÖ Auto-selecting center:', centerExists.name);

          // Set the dropdown value
          const select = document.getElementById('center-select');
          select.value = centerId;

          // Trigger the change event to load appointment types
          select.dispatchEvent(new Event('change'));

          // Scroll to booking section
          setTimeout(() => {
            document.getElementById('booking').scrollIntoView({ behavior: 'smooth' });
          }, 500);
        } else {
          console.warn('‚ö†Ô∏è Center ID from URL not found in Smart Agenda:', centerId);
        }
      }
    }

    // Initialize everything on load
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('LaserOstop Booking System - Initializing...');

      // Initialize map
      initializeMap();

      // Initialize calendar
      initializeCalendar();

      // Load centers from Smart Agenda API
      await loadCentersFromAPI();

      // Auto-select center from URL if present
      await autoSelectCenterFromURL();

      // Show promotional popup after initialization
      // showPromoPopup(); // Disabled for now

      console.log('Initialization complete!');
    });

    // ========== TOUCH-RESPONSIVE CAROUSEL (MOBILE ONLY) ==========

    /**
     * Add touch controls for review carousels on mobile
     * Row 1 and Row 2 move in opposite directions at same speed
     */
    document.addEventListener('DOMContentLoaded', function() {
      // Only enable on touch devices (mobile/tablet)
      if (!('ontouchstart' in window)) {
        console.log('Touch carousel disabled - not a touch device');
        return;
      }

      const row1Track = document.querySelector('.carousel-row-1 .carousel-track');
      const row2Track = document.querySelector('.carousel-row-2 .carousel-track');
      const row1Container = document.querySelector('.carousel-row-1');
      const row2Container = document.querySelector('.carousel-row-2');

      if (!row1Track || !row2Track || !row1Container || !row2Container) {
        console.log('Touch carousel disabled - elements not found');
        return;
      }

      let touchStartX = 0;
      let touchStartY = 0;
      let row1StartTranslate = 0;
      let row2StartTranslate = 0;
      let isTouching = false;

      function getTranslateX(element) {
        const style = window.getComputedStyle(element);
        const matrix = new DOMMatrixReadOnly(style.transform);
        return matrix.m41;
      }

      function handleTouchStart(e) {
        isTouching = true;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;

        // Pause animations
        row1Track.style.animationPlayState = 'paused';
        row2Track.style.animationPlayState = 'paused';

        // Get current positions
        row1StartTranslate = getTranslateX(row1Track);
        row2StartTranslate = getTranslateX(row2Track);

        console.log('Touch start at', touchStartX);
      }

      function handleTouchMove(e) {
        if (!isTouching) return;

        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;
        const deltaX = touchX - touchStartX;
        const deltaY = touchY - touchStartY;

        // Only handle horizontal swipes (prevent vertical scroll interference)
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
          e.preventDefault();

          // Row 1 moves with finger
          // Row 2 moves opposite direction
          row1Track.style.transform = `translateX(${row1StartTranslate + deltaX}px)`;
          row2Track.style.transform = `translateX(${row2StartTranslate - deltaX}px)`;
        }
      }

      function handleTouchEnd() {
        if (!isTouching) return;
        isTouching = false;

        console.log('Touch end');

        // Resume animations after brief delay
        setTimeout(() => {
          row1Track.style.animationPlayState = 'running';
          row2Track.style.animationPlayState = 'running';
        }, 300);
      }

      // Add event listeners to both carousel containers
      [row1Container, row2Container].forEach(container => {
        container.addEventListener('touchstart', handleTouchStart, { passive: true });
        container.addEventListener('touchmove', handleTouchMove, { passive: false });
        container.addEventListener('touchend', handleTouchEnd, { passive: true });
        container.addEventListener('touchcancel', handleTouchEnd, { passive: true });
      });

      console.log('‚úÖ Touch carousel controls initialized');
    });

    // ========== HERO CTA BUTTON SCROLL ==========

    /**
     * Smooth scroll to booking section when hero CTA button is clicked
     */
    document.addEventListener('DOMContentLoaded', function() {
      const heroCtaBtn = document.getElementById('hero-cta-btn');
      const bookingSection = document.getElementById('booking');

      if (heroCtaBtn && bookingSection) {
        heroCtaBtn.addEventListener('click', function() {
          bookingSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        });
        console.log('‚úÖ Hero CTA button scroll initialized');
      }
    });

    // Video audio toggle function
    function toggleVideoAudio(container) {
      const video = container.querySelector('video');
      const icon = container.querySelector('.audio-icon');
      const hint = container.querySelector('.audio-hint');

      if (video.muted) {
        video.muted = false;
        icon.textContent = 'volume_up';
        if (hint) {
          hint.style.opacity = '0';
          setTimeout(() => hint.style.display = 'none', 300);
        }
      } else {
        video.muted = true;
        icon.textContent = 'volume_off';
      }
    }

    // Navigation - Mobile Menu Toggle
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      const mobileMenuIcon = mobileMenuButton.querySelector('.material-icons');

      // Toggle mobile menu
      mobileMenuButton.addEventListener('click', function() {
        mobileMenu.classList.toggle('hidden');
        // Toggle icon between menu and close
        if (mobileMenu.classList.contains('hidden')) {
          mobileMenuIcon.textContent = 'menu';
        } else {
          mobileMenuIcon.textContent = 'close';
        }
      });

      // Close mobile menu when clicking a link
      const mobileLinks = document.querySelectorAll('.mobile-link');
      mobileLinks.forEach(link => {
        link.addEventListener('click', function() {
          mobileMenu.classList.add('hidden');
          mobileMenuIcon.textContent = 'menu';
        });
      });

      // Smooth scroll for all navigation links
      const smoothScrollLinks = document.querySelectorAll('.smooth-scroll');
      smoothScrollLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const targetId = this.getAttribute('href');
          const targetSection = document.querySelector(targetId);

          if (targetSection) {
            const navbarHeight = document.getElementById('navbar').offsetHeight;
            const targetPosition = targetSection.offsetTop - navbarHeight;

            window.scrollTo({
              top: targetPosition,
              behavior: 'smooth'
            });
          }
        });
      });

      // Add scroll effect to navbar (shrink on scroll)
      let lastScroll = 0;
      window.addEventListener('scroll', function() {
        const navbar = document.getElementById('navbar');
        const currentScroll = window.pageYOffset;

        if (currentScroll > 100) {
          navbar.classList.add('shadow-lg');
        } else {
          navbar.classList.remove('shadow-lg');
        }

        lastScroll = currentScroll;
      });
    });
  </script>

</body>
</html>
<!-- Force rebuild at Fri Oct 17 09:03:49 CET 2025 -->
