<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>LaserOstop Barcelona - Dejar de fumar en una sola sesi√≥n</title>
<link rel="stylesheet" href="tailwind-generated.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    :root {
      --teal-primary: #22A9AF;
      --orange-cta: #F28B27;
      --text-dark: #1a1a1a;
      --text-gray: #666666;
      --bg-white: #ffffff;
      --star-yellow: #FFD93D;
    }

    .material-icons {
      vertical-align: middle;
    }

    /* Override primary color to teal for this page */
    .text-teal-primary { color: var(--teal-primary); }
    .bg-teal-primary { background-color: var(--teal-primary); }
    .border-teal-primary { border-color: var(--teal-primary); }
    .text-orange-cta { color: var(--orange-cta); }
    .bg-orange-cta { background-color: var(--orange-cta); }

    /* Map container */
    #spain-map-container {
      position: relative;
      width: 100%;
      height: 600px;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    #spain-map {
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* Custom marker styles */
    .custom-marker {
      background-color: var(--teal-primary);
      width: 30px;
      height: 30px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 3px solid white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .custom-marker::after {
      content: '';
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: white;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* Leaflet popup customization */
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .leaflet-popup-content {
      margin: 16px;
      font-family: 'Poppins', sans-serif;
    }

    .leaflet-popup-content h3 {
      color: var(--teal-primary);
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* Payment popup responsive width */
    @media (min-width: 768px) {
      #payment-popup > div {
        width: 840px !important;
      }
    }

    /* WhatsApp button positioning - above mobile CTA bar */
    @media (max-width: 767px) {
      .whatsapp-btn {
        bottom: 5rem !important;
      }
    }

    /* City-grouped dropdown styling */
    #center-select {
      background-color: var(--teal-primary);
      color: white;
      font-weight: 500;
    }

    #center-select optgroup {
      font-weight: 700;
      font-size: 0.95em;
      color: var(--teal-primary);
      font-style: normal;
      padding: 8px 0 4px 0;
      background-color: white;
    }

    #center-select option {
      padding-left: 8px;
      font-weight: 400;
      color: #374151;
      background-color: white;
    }

    /* Testimonial card shadow */
    .testimonial-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    /* Star rating */
    .stars {
      color: var(--star-yellow);
    }

    /* Booking form adjustments for teal theme */
    #center-display {
      background-color: var(--teal-primary) !important;
    }

    /* Override focus states for teal */
    input:focus, select:focus {
      border-color: var(--teal-primary) !important;
      ring-color: var(--teal-primary) !important;
    }
  </style>

  <!-- Cookie Consent & Hotjar/Contentsquare Tracking Code -->
  <script>
    // Cookie Consent Management
    window.CookieConsent = {
      init: function() {
        const consent = localStorage.getItem('analyticsConsent');
        if (consent === 'accepted') {
          this.loadHotjar();
        } else if (consent === null) {
          // First visit - show banner
          this.showBanner();
        }
        // If 'rejected', do nothing
      },

      showBanner: function() {
        const banner = document.getElementById('cookie-consent-banner');
        if (banner) {
          banner.classList.remove('hidden');
          banner.classList.add('animate-slide-up');
        }
      },

      accept: function() {
        localStorage.setItem('analyticsConsent', 'accepted');
        this.hideBanner();
        this.loadHotjar();
      },

      reject: function() {
        localStorage.setItem('analyticsConsent', 'rejected');
        this.hideBanner();
      },

      hideBanner: function() {
        const banner = document.getElementById('cookie-consent-banner');
        if (banner) {
          banner.classList.add('opacity-0');
          setTimeout(() => banner.remove(), 300);
        }
      },

      loadHotjar: function() {
        if (window.hj) return; // Already loaded

        // Mask sensitive form fields before loading Hotjar
        this.maskSensitiveFields();

        (function (c, s, q, u, a, r, e) {
            c.hj=c.hj||function(){(c.hj.q=c.hj.q||[]).push(arguments)};
            c._hjSettings = { hjid: a };
            r = s.getElementsByTagName('head')[0];
            e = s.createElement('script');
            e.async = true;
            e.src = q + c._hjSettings.hjid + u;
            r.appendChild(e);
        })(window, document, 'https://static.hj.contentsquare.net/c/csq-', '.js', 6574639);

        console.log('‚úÖ Hotjar loaded with user consent');
      },

      maskSensitiveFields: function() {
        // Add data-hj-suppress attribute to sensitive fields
        // This prevents Hotjar from recording their values
        const sensitiveSelectors = [
          'input[type="email"]',
          'input[type="tel"]',
          'input[name*="email"]',
          'input[name*="phone"]',
          'input[name*="telefono"]',
          'input[id*="email"]',
          'input[id*="phone"]',
          'input[id*="telefono"]',
          '#contact-name',
          '#contact-email',
          '#contact-phone'
        ];

        sensitiveSelectors.forEach(selector => {
          document.querySelectorAll(selector).forEach(field => {
            field.setAttribute('data-hj-suppress', '');
            field.setAttribute('data-cs-mask', ''); // Contentsquare masking
          });
        });

        console.log('üîí Sensitive fields masked for privacy');
      }
    };

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => window.CookieConsent.init());
    } else {
      window.CookieConsent.init();
    }
  </script>

  <style>
    @keyframes slide-up {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .animate-slide-up {
      animation: slide-up 0.4s ease-out;
    }
    #cookie-consent-banner {
      transition: opacity 0.3s ease-out;
    }
  </style>

</head>
<body class="bg-white font-display text-gray-900">

<!-- Cookie Consent Banner -->
<div id="cookie-consent-banner" class="hidden fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t-4 z-[9999]" style="border-color: #22A9AF;">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div class="flex items-start gap-4 flex-1">
        <div class="flex-shrink-0 mt-1">
          <svg class="w-6 h-6" style="color: #22A9AF;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="flex-1">
          <p class="text-sm text-gray-600 leading-relaxed">
            Utilizamos cookies para mejorar su experiencia. <span class="font-medium">No compartimos datos personales.</span>
          </p>
        </div>
      </div>
      <div class="flex flex-row gap-3 w-full sm:w-auto">
        <button onclick="window.CookieConsent.reject()" class="px-5 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
          Rechazar
        </button>
        <button onclick="window.CookieConsent.accept()" class="px-5 py-2 text-sm font-medium text-white rounded-full transition-colors shadow-md" style="background-color: #22A9AF;">
          Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<div class="min-h-screen flex flex-col">

<!-- 1. HEADER - Centered Logo in Blue -->
<header class="bg-white py-6">
  <div class="container mx-auto px-4 text-center">
    <img src="assets/logolaserostop-bleu.svg" alt="LaserOstop" class="h-14 sm:h-16 mx-auto"/>
  </div>
</header>

<main class="flex-grow">

<!-- 2. HERO SECTION - Main Value Proposition -->
<section id="hero" class="bg-white py-12 sm:py-16">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center max-w-4xl">
    <!-- Main Title -->
    <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tight mb-8" style="color: #22A9AF;">
      Reserva tu sesi√≥n para dejar de fumar en una sola sesi√≥n
    </h1>

    <!-- Guarantee Section -->
    <div class="bg-white rounded-2xl p-6 mb-10 max-w-4xl mx-auto" style="border: 2px solid #22A9AF;">
      <!-- Header -->
      <div class="text-center mb-6">
        <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold" style="background-color: #22A9AF; color: #FFFFFF;">
          <span class="material-icons text-base">verified_user</span>
          GARANT√çA DE SATISFACCI√ìN
        </span>
      </div>

      <!-- Benefits Grid -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">

        <!-- Benefit 1: 1 Year Guarantee -->
        <div class="flex md:flex-col items-center md:items-center md:text-center gap-4 md:gap-2 p-4 rounded-xl bg-gray-50">
          <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(34, 169, 175, 0.15);">
            <span class="material-icons text-2xl" style="color: #22A9AF;">shield</span>
          </div>
          <div class="flex-1 md:flex-none">
            <h4 class="font-bold text-gray-900 text-sm md:text-base">1 A√ëO DE GARANT√çA</h4>
            <p class="text-xs md:text-sm text-gray-600">Cobertura total durante 12 meses</p>
          </div>
        </div>

        <!-- Benefit 2: Free Session on Relapse -->
        <div class="flex md:flex-col items-center md:items-center md:text-center gap-4 md:gap-2 p-4 rounded-xl bg-gray-50">
          <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(34, 169, 175, 0.15);">
            <span class="material-icons text-2xl" style="color: #22A9AF;">autorenew</span>
          </div>
          <div class="flex-1 md:flex-none">
            <h4 class="font-bold text-gray-900 text-sm md:text-base">SESI√ìN GRATIS EN RECA√çDA</h4>
            <p class="text-xs md:text-sm text-gray-600">Si vuelves a fumar, te ayudamos gratis</p>
          </div>
        </div>

        <!-- Benefit 3: Money Back Guarantee -->
        <div class="flex md:flex-col items-center md:items-center md:text-center gap-4 md:gap-2 p-4 rounded-xl bg-gray-50">
          <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(34, 169, 175, 0.15);">
            <span class="material-icons text-2xl" style="color: #22A9AF;">payments</span>
          </div>
          <div class="flex-1 md:flex-none">
            <h4 class="font-bold text-gray-900 text-sm md:text-base">REEMBOLSO GARANTIZADO</h4>
            <p class="text-xs md:text-sm text-gray-600">Si la 2¬™ sesi√≥n no funciona, te devolvemos el dinero</p>
          </div>
        </div>

      </div>
    </div>

    <!-- 3. CTA PRICING BLOCK - Orange Button -->
    <div class="text-center w-full">
      <a href="#booking" class="smooth-scroll inline-block text-xl sm:text-2xl font-bold text-white shadow-lg" style="background-color: #F28B27; text-align: center; letter-spacing: 0.5px; border-radius: 50px; padding: 24px 40px; max-width: 90%;">
        Precio especial 149 ‚Ç¨
      </a>
    </div>
  </div>
</section>

<!-- 4. TESTIMONIALS SECTION - Satisfecho o reembolsado -->
<section id="testimonials" class="bg-gray-50 py-12 sm:py-16">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Title -->
    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-10" style="color: #22A9AF;">
      Satisfecho o reembolsado
    </h2>

    <!-- Testimonial Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto">

      <!-- Testimonial 1: Jos√© -->
      <article class="testimonial-card">
        <div class="flex items-center gap-4 mb-4">
          <img src="https://ui-avatars.com/api/?name=Jose&background=1F6FEB&color=fff&size=56&rounded=true" alt="Jos√©" class="w-14 h-14 rounded-full">
          <div>
            <h3 class="font-bold text-gray-900">Jos√©</h3>
            <div class="stars text-lg">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          </div>
        </div>
        <p class="text-gray-600 text-sm leading-relaxed">
          "Dej√© de fumar en una sola sesi√≥n despu√©s de 30 a√±os. Incre√≠ble. Lo recomiendo a todo el mundo que quiera dejar este vicio de una vez por todas."
        </p>
      </article>

      <!-- Testimonial 2: Carmen -->
      <article class="testimonial-card">
        <div class="flex items-center gap-4 mb-4">
          <img src="https://ui-avatars.com/api/?name=Carmen&background=F28B27&color=fff&size=56&rounded=true" alt="Carmen" class="w-14 h-14 rounded-full">
          <div>
            <h3 class="font-bold text-gray-900">Carmen</h3>
            <div class="stars text-lg">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          </div>
        </div>
        <p class="text-gray-600 text-sm leading-relaxed">
          "Llevo 8 meses sin fumar y sin ansiedad. No he engordado ni un gramo. El tratamiento me cambi√≥ la vida. Gracias LaserOstop."
        </p>
      </article>

      <!-- Testimonial 3: Antonio -->
      <article class="testimonial-card">
        <div class="flex items-center gap-4 mb-4">
          <img src="https://ui-avatars.com/api/?name=Antonio&background=22A9AF&color=fff&size=56&rounded=true" alt="Antonio" class="w-14 h-14 rounded-full">
          <div>
            <h3 class="font-bold text-gray-900">Antonio</h3>
            <div class="stars text-lg">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          </div>
        </div>
        <p class="text-gray-600 text-sm leading-relaxed">
          "Fumaba desde hace 40 a√±os. No cre√≠a que esto funcionar√≠a pero me equivoqu√©. Una sesi√≥n y se acab√≥. Sin nervios, sin ganas de fumar."
        </p>
      </article>

    </div>
  </div>
</section>

<!-- 5. METHODOLOGY SECTION - Two Columns -->
<section id="methodology" class="bg-white py-12 sm:py-16">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-16 items-center max-w-6xl mx-auto">

      <!-- Left: Text Content -->
      <div class="order-2 lg:order-1">
        <h2 class="text-2xl sm:text-3xl font-bold mb-6" style="color: #22A9AF;">
          Nuestra metodolog√≠a
        </h2>
        <div class="space-y-4 text-gray-600 leading-relaxed">
          <p>
            El l√°ser estimula la producci√≥n de <strong class="text-gray-800">endorfinas</strong>, las hormonas naturales del bienestar, que ayudan a reducir el deseo de fumar.
          </p>
          <p>
            Este m√©todo <strong class="text-gray-800">elimina la ansiedad</strong> asociada al abandono del tabaco y reduce significativamente los s√≠ntomas de abstinencia.
          </p>
          <p>
            La sesi√≥n act√∫a directamente sobre la <strong class="text-gray-800">dependencia f√≠sica a la nicotina</strong>, permitiendo que puedas dejar de fumar sin sufrimiento.
          </p>
        </div>
      </div>

      <!-- Right: Image -->
      <div class="order-1 lg:order-2 flex justify-center">
        <div class="relative rounded-2xl overflow-hidden shadow-xl max-w-md">
          <img src="../laserostop_espagna/assets/laser-ear-treatment.jpg" alt="Tratamiento l√°ser en oreja" class="w-full h-auto" onerror="this.src='https://images.unsplash.com/photo-1576091160550-2173dba999ef?w=500&h=600&fit=crop'; this.onerror=null;">
        </div>
      </div>

    </div>
  </div>
</section>

<!-- 6. BOOKING SECTION - Complete Booking Form -->
<section class="py-16 sm:py-24" id="booking">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden" style="border: 3px solid #22A9AF;">
<div class="p-8 sm:p-12">
<div id="booking-form">

<!-- CTA Banner -->
<div class="mb-8 bg-gradient-to-r from-[#22A9AF]/10 via-[#22A9AF]/5 to-transparent rounded-lg p-6" style="border-left: 4px solid #22A9AF;">
  <div class="flex items-start gap-4">
    <div class="flex-shrink-0">
      <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(34, 169, 175, 0.2);">
        <span class="material-icons text-2xl" style="color: #22A9AF;">campaign</span>
      </div>
    </div>
    <div class="flex-1">
      <h3 class="text-lg font-bold text-gray-800 mb-2">
        ¬°Reserve su cita hoy y deje de fumar en una sola sesi√≥n!
      </h3>
      <p class="text-sm text-gray-600">
        M√°s de 500,000 personas han dejado de fumar con LaserOstop.
        <span class="font-semibold" style="color: #22A9AF;">Plazas limitadas disponibles</span> - Reserve ahora.
      </p>
    </div>
  </div>
</div>

<div class="mb-8" id="step-1">
<h2 class="text-2xl font-semibold mb-4 text-gray-800"><span style="color: #22A9AF;" class="mr-3">1.</span>Su centro</h2>
<div class="relative">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-white">place</span>
<div id="center-display" class="w-full pl-12 pr-4 py-3 border-0 rounded-full text-white font-medium" style="background-color: #22A9AF;">
  Barcelona
</div>
<select id="center-select" class="hidden">
<option value="43" selected>Barcelona</option>
</select>
</div>
</div>
<div class="mb-8 hidden" id="step-1b">
<h2 class="text-2xl font-semibold mb-4 text-gray-800"><span style="color: #22A9AF;" class="mr-3">2.</span>Tipo de sesi√≥n</h2>
<div class="relative">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">healing</span>
<select id="booking-type-select" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-full bg-transparent focus:ring-[#22A9AF] focus:border-[#22A9AF] transition">
<option value="">Seleccione el tipo de sesi√≥n...</option>
</select>
</div>
<!-- Info box for selected type -->
<div id="booking-type-info" class="hidden mt-4 p-4 bg-[#22A9AF]/10 border border-[#22A9AF]/30 rounded-lg">
<div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
<div class="flex items-center">
<span class="material-icons mr-2 text-lg" style="color: #22A9AF;">schedule</span>
<div>
<p class="text-gray-500 text-xs">Duraci√≥n</p>
<p id="type-duration" class="font-semibold text-gray-800">-</p>
</div>
</div>
<div class="flex items-center">
<span class="material-icons mr-2 text-lg" style="color: #22A9AF;">euro</span>
<div>
<p class="text-gray-500 text-xs">Precio</p>
<p id="type-price" class="font-semibold text-gray-800">-</p>
</div>
</div>
<div class="flex items-center">
<span class="material-icons mr-2 text-lg" style="color: #22A9AF;">info</span>
<div>
<p class="text-gray-500 text-xs">Descripci√≥n</p>
<p id="type-description" class="font-semibold text-gray-800 text-xs">-</p>
</div>
</div>
</div>
</div>
</div>
<div class="mb-8 hidden" id="step-2">
<h2 class="text-2xl font-semibold mb-4 text-gray-800"><span style="color: #22A9AF;" class="mr-3">3.</span>Elija una fecha y una hora</h2>
<div class="bg-gray-50 p-6 rounded-lg">
<div class="flex justify-between items-center mb-4">
<button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition"><span class="material-icons">chevron_left</span></button>
<h3 id="current-month" class="text-lg font-semibold"></h3>
<button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition"><span class="material-icons">chevron_right</span></button>
</div>
<div class="grid grid-cols-7 gap-2 text-center mb-2">
<div class="text-gray-500 text-sm font-medium">Lu</div>
<div class="text-gray-500 text-sm font-medium">Ma</div>
<div class="text-gray-500 text-sm font-medium">Mi</div>
<div class="text-gray-500 text-sm font-medium">Ju</div>
<div class="text-gray-500 text-sm font-medium">Vi</div>
<div class="text-gray-500 text-sm font-medium">Sa</div>
<div class="text-gray-500 text-sm font-medium">Do</div>
</div>
<div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center">
<!-- Calendar days will be generated here -->
</div>
<div class="mt-6" id="time-slots-section">
<h4 class="font-semibold mb-3 text-gray-800">Horarios disponibles</h4>
<div id="selected-date-info" class="text-sm text-gray-600 mb-3"></div>
<div id="time-slots" class="grid grid-cols-3 sm:grid-cols-4 gap-2">
<!-- Time slots will be generated here -->
</div>
</div>
</div>
</div>
<div class="mb-8 hidden" id="step-3">
<h2 class="text-2xl font-semibold mb-4 text-gray-800"><span style="color: #22A9AF;" class="mr-3">4.</span>Sus datos</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="relative">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">person</span>
<input id="full-name" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-full bg-transparent focus:ring-[#22A9AF] focus:border-[#22A9AF] transition" placeholder="Nombre completo *" type="text" required/>
</div>
<div class="relative">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">email</span>
<input id="email" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-full bg-transparent focus:ring-[#22A9AF] focus:border-[#22A9AF] transition" placeholder="Correo electr√≥nico *" type="email" required/>
</div>
<div class="relative md:col-span-2">
<span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">phone</span>
<input id="phone" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-full bg-transparent focus:ring-[#22A9AF] focus:border-[#22A9AF] transition" placeholder="N√∫mero de tel√©fono *" type="tel" required/>
</div>
</div>
</div>
<div id="step-4" class="hidden">
<button type="button" class="w-full text-white py-4 px-8 rounded-full font-semibold text-lg hover:opacity-90 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #22A9AF;" onclick="showConfirmation(event)">
<span class="material-icons mr-2">event_available</span> Confirmar la cita
</button>
</div>
</div>
<div class="hidden flex items-center justify-center text-center" id="confirmation-message">
<div class="py-12">
<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
<span class="material-icons text-4xl text-green-500">check</span>
</div>
<h2 class="text-3xl font-bold text-gray-800 mb-4">¬°Cita confirmada!</h2>
<p class="text-lg text-gray-600 mb-2">Se ha enviado un correo de confirmaci√≥n a su direcci√≥n.</p>
<p class="text-gray-500">Estaremos encantados de recibirle en el centro <strong>LaserOstop Barcelona</strong> el <strong>15 de Octubre de 2025 a las 11:30</strong>.</p>
</div>
</div>

<!-- Promotional Popup (Modal) -->
<div id="promo-popup" class="hidden fixed inset-0 bg-white/40 dark:bg-black/40 backdrop-blur-md flex items-center justify-center z-[60] p-4 animate-fadeIn">
<div class="relative bg-white dark:bg-gray-900 rounded-lg shadow-2xl overflow-hidden transform transition-all animate-scaleIn" style="border: 3px solid #22A9AF; width: 420px; height: 550px;">
<!-- Close Button (X in corner) - MUST BE FIRST for absolute positioning -->
<button
onclick="closePromoPopup()"
class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center hover:opacity-70 transition-opacity z-10"
aria-label="Cerrar"
style="z-index: 20;">
<span class="material-icons text-gray-600 dark:text-gray-300 text-lg">close</span>
</button>

<!-- Centered Content Wrapper -->
<div class="flex flex-col items-center justify-center" style="height: 100%;">
<!-- Logo at Top -->
<div class="flex justify-center bg-white dark:bg-gray-900" style="padding-bottom: 12px;">
<img src="assets/logolaserostop-bleu.svg" alt="LaserOstop" style="height: 40px;">
</div>

<!-- Content -->
<div style="padding-left: 24px; padding-right: 24px;">
<!-- Big Discount Section -->
<div class="text-center" style="margin-bottom: 24px;">
<p class="text-sm font-medium text-gray-600 dark:text-gray-400" style="margin-bottom: 8px;">OFERTA ESPECIAL</p>
<div class="relative inline-block">
<div class="text-7xl leading-none" style="color: #22A9AF; font-weight: 900;">
30%
</div>
<div class="absolute bg-red-500 text-white text-xs font-bold rounded transform rotate-12" style="top: -8px; right: -48px; padding: 4px 8px;">
AHORRO
</div>
</div>
<p class="text-lg font-semibold text-gray-800 dark:text-white" style="margin-top: 8px;">DE DESCUENTO</p>
</div>

<!-- Sales Highlights -->
<div class="bg-gradient-to-br from-[#22A9AF]/10 via-[#22A9AF]/5 to-transparent rounded-lg border-l-4 border-[#22A9AF]" style="padding: 16px; margin-bottom: 20px;">
<div style="display: flex; flex-direction: column; gap: 8px;">
<div style="display: flex; align-items: center; justify-content: space-between;">
<span class="text-sm font-medium text-gray-700 dark:text-gray-300">Precio normal</span>
<span class="text-sm font-bold line-through" style="color: #EF4444;">hasta 190‚Ç¨</span>
</div>
<div style="display: flex; align-items: center; justify-content: space-between;">
<span class="text-sm font-medium text-gray-700 dark:text-gray-300">Precio con descuento</span>
<span class="text-lg font-bold" style="color: #22A9AF;">desde 99‚Ç¨</span>
</div>
</div>
</div>

<!-- Payment Option Highlight -->
<div class="bg-[#22A9AF]/5 rounded-lg text-center border border-[#22A9AF]/20" style="padding: 16px;">
<p class="text-xs font-semibold text-[#22A9AF] uppercase tracking-wide" style="margin-bottom: 4px;">Facilidades de pago</p>
<p class="text-2xl font-bold text-gray-800 dark:text-white">3 cuotas sin intereses</p>
<p class="text-xs text-gray-600 dark:text-gray-400" style="margin-top: 4px;">Sin comisiones adicionales</p>
</div>

<!-- CTA Button -->
<div class="text-center" style="margin-top: 24px;">
<button onclick="closePromoAndScroll()" class="inline-flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-white font-semibold px-8 py-3 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300" style="width: 100%;">
<span class="material-icons">event_available</span>
<span>Reservar mi cita</span>
</button>
</div>
</div>
</div>
</div>
</div>

<!-- Payment Options Popup (Modal) -->
<div id="payment-popup" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
<div class="bg-white rounded-2xl shadow-2xl w-[420px] md:w-[840px] max-w-[calc(100%-2rem)] max-h-[90vh] overflow-y-auto relative">

<!-- Close Button -->
<button onclick="closePaymentPopup()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 hover:text-gray-700 transition-colors z-10">
<span class="material-icons text-xl">close</span>
</button>

<!-- Content Container - consistent padding -->
<div class="p-6">

<!-- Header -->
<div class="text-center mb-6">
<h2 class="text-xl font-bold text-gray-900 mb-1">¬°Ahorra pagando online!</h2>
<p class="text-sm text-gray-500">Elige tu m√©todo de pago preferido</p>
</div>

<!-- Payment Cards Container -->
<div class="flex flex-col gap-3">

<!-- CARD 1: Online Payment (Recommended) -->
<div class="relative pt-5">
<span class="absolute -top-1 right-4 px-3 py-1 text-xs font-bold text-white rounded-full z-10" style="background-color: #38D9A9;"><span style="color: #FFD93D;">‚≠ê</span> POPULAR</span>
<div class="rounded-xl p-4 cursor-pointer hover:shadow-md transition-all" style="border: 3px solid #14A3A3; background-color: rgba(20, 163, 163, 0.05);" onclick="selectPaymentOption(1)">

<!-- Price Row -->
<div class="flex items-baseline gap-2 mb-3">
<span id="popup-online-price" class="text-2xl font-bold" style="color: #14A3A3;">‚Ç¨99</span>
<span id="popup-online-original" class="text-sm line-through" style="color: #B72222;">‚Ç¨190</span>
<span class="text-xs font-semibold px-1.5 py-0.5 rounded" style="background-color: #FFD93D; color: #000;">Ahorra ‚Ç¨<span id="popup-savings-amount">91</span></span>
</div>

<!-- Benefits -->
<ul class="flex flex-col gap-1.5 mb-4">
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
Confirmaci√≥n inmediata
</li>
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
Pago 100% seguro (SSL)
</li>
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
Reembolso si cancelas 24h antes
</li>
</ul>

<!-- Button -->
<div class="flex justify-center">
<button class="w-full text-white font-semibold py-3 rounded-lg transition-colors flex items-center justify-center gap-2 text-sm" style="background-color: #14A3A3;">
<span class="material-icons text-base">lock</span>
Pagar ‚Ç¨<span id="popup-online-btn-price">99</span> ahora
</button>
</div>
</div>
</div>

<!-- CARD 2: Pay at Center (Blue) -->
<div class="rounded-xl p-4 cursor-pointer hover:shadow-sm transition-all" style="border: 3px solid #2563EB;" onclick="selectPaymentOption(2)">

<!-- Price Row -->
<div class="flex items-baseline gap-2 mb-3">
<span id="popup-center-price" class="text-2xl font-bold" style="color: #2563EB;">‚Ç¨129</span>
<span id="popup-center-old" class="text-sm line-through" style="color: #B72222;">‚Ç¨190</span>
<span class="text-xs font-semibold px-1.5 py-0.5 rounded" style="background-color: #FFD93D; color: #000;">Ahorra ‚Ç¨<span id="popup-center-savings">61</span></span>
</div>

<!-- Benefits -->
<ul class="flex flex-col gap-1.5 mb-4">
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
Pago en efectivo o tarjeta
</li>
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
El d√≠a de tu cita
</li>
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
Sujeto a disponibilidad
</li>
</ul>

<!-- Warning Badge -->
<div class="rounded-lg px-3 py-2 mb-3" style="background-color: #FEF3C7; border: 1px solid #FCD34D;">
<p class="text-xs font-medium text-center" style="color: #B45309;">‚ö†Ô∏è Pagas 30‚Ç¨ m√°s que reservando online</p>
</div>

<!-- Button -->
<div class="flex justify-center">
<button class="w-full text-white font-semibold py-3 rounded-lg transition-colors text-sm" style="background-color: #2563EB;">
Reservar y pagar en centro
</button>
</div>
</div>

<!-- CARD 3: Pay in 3 Installments (Purple) -->
<div class="rounded-xl p-4 cursor-pointer hover:shadow-sm transition-all" style="border: 3px solid #7C3AED;" onclick="selectPaymentOption(3)">

<!-- Price Row -->
<div class="flex items-baseline gap-2 mb-1">
<span class="text-2xl font-bold" style="color: #7C3AED;">3 √ó <span id="popup-monthly-price">‚Ç¨40</span></span>
<span class="text-xs text-gray-400">/mes</span>
<span class="text-xs font-semibold px-1.5 py-0.5 rounded" style="background-color: #FFD93D; color: #000;">Ahorra ‚Ç¨<span id="popup-plan-savings">70</span></span>
</div>
<p class="text-xs text-gray-500 mb-3">Total: ‚Ç¨<span id="popup-monthly-total">120</span> ¬∑ Sin intereses</p>

<!-- Benefits -->
<ul class="flex flex-col gap-1.5 mb-4">
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
Reserva confirmada al instante
</li>
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
Pago flexible mensual
</li>
<li class="flex items-center gap-2 text-sm text-gray-600">
<span class="material-icons text-base" style="color: #29C473;">check_circle</span>
0% intereses, 0% comisiones
</li>
</ul>

<!-- Button -->
<div class="flex justify-center">
<button class="w-full text-white font-semibold py-3 rounded-lg transition-colors flex items-center justify-center gap-2 text-sm" style="background-color: #7C3AED;">
<span class="material-icons text-base">calendar_today</span>
Pagar en 3 cuotas de ‚Ç¨<span id="popup-monthly-btn-price">40</span>
</button>
</div>
</div>

</div>

<!-- Social Proof -->
<div class="mt-4 text-center">
<p class="text-xs text-gray-500">üìà <span class="font-medium">23 personas</span> han reservado en las √∫ltimas 24 horas</p>
</div>

<!-- Footer -->
<div class="mt-4 pt-4 border-t border-gray-100">
<!-- Trust Badges -->
<div class="flex flex-wrap justify-center gap-3 mb-3">
<span class="inline-flex items-center gap-1 text-xs text-gray-500"><span class="material-icons text-green-500 text-sm">lock</span>Pago 100% seguro</span>
<span class="inline-flex items-center gap-1 text-xs text-gray-500"><span class="material-icons text-green-500 text-sm">replay</span>Cancelaci√≥n gratis 24h</span>
<span class="inline-flex items-center gap-1 text-xs text-gray-500"><span class="material-icons text-green-500 text-sm">mail</span>Confirmaci√≥n inmediata</span>
</div>
<p class="text-center">
<button onclick="closePaymentPopup()" class="text-xs text-gray-400 hover:text-gray-600 transition-colors">
Cerrar
</button>
</p>
</div>

</div>
</div>
</div>
</div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

.animate-scaleIn {
  animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
</style>

</section>

<!-- Contact Section -->
<section class="py-12 sm:py-16 pb-24 md:pb-16 bg-white" id="contact">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto text-center">
      <!-- Section Header -->
      <h2 class="text-2xl sm:text-3xl font-bold mb-8" style="color: #22A9AF;">Cont√°ctanos</h2>

      <!-- Contact Links -->
      <div class="flex flex-col sm:flex-row items-center justify-center gap-6 sm:gap-10">

        <!-- Email -->
        <a href="mailto:laserostop.barcelona@gmail.com" class="flex items-center gap-3 text-gray-700 hover:text-[#22A9AF] transition-colors group">
          <div class="w-12 h-12 rounded-full flex items-center justify-center bg-gray-100 group-hover:bg-[#22A9AF]/10 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
          </div>
          <span class="font-medium">laserostop.barcelona@gmail.com</span>
        </a>

        <!-- Phone -->
        <a href="tel:+34689560130" class="flex items-center gap-3 text-gray-700 hover:text-[#22A9AF] transition-colors group">
          <div class="w-12 h-12 rounded-full flex items-center justify-center bg-gray-100 group-hover:bg-[#22A9AF]/10 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
          </div>
          <span class="font-medium">689 560 130</span>
        </a>

        <!-- Facebook -->
        <a href="https://www.facebook.com/laserostop.barcelona/" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 text-gray-700 hover:text-[#1877F2] transition-colors group">
          <div class="w-12 h-12 rounded-full flex items-center justify-center bg-gray-100 group-hover:bg-[#1877F2]/10 transition-colors">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </div>
          <span class="font-medium">Facebook</span>
        </a>

      </div>
    </div>
  </div>
</section>

</main>

<!-- Mobile Fixed Bottom CTA Bar -->
<div class="fixed bottom-0 left-0 right-0 z-40 md:hidden bg-white border-t border-gray-200 shadow-lg px-4 py-3">
<a href="#booking" class="smooth-scroll flex items-center justify-center gap-2 w-full text-white font-semibold py-3 rounded-full shadow-md transition-all duration-300" style="background-color: #F28B27;">
<span>Reservar - 99 ‚Ç¨</span>
</a>
</div>

<!-- WhatsApp Floating Button -->
<a href="https://wa.me/34689560130?text=Hola%2C%20estoy%20interesado%20en%20una%20sesi%C3%B3n%20de%20LaserOstop%20Barcelona%20para%20dejar%20de%20fumar.%20%C2%BFPodr%C3%ADan%20darme%20m%C3%A1s%20informaci%C3%B3n%3F" target="_blank" rel="noopener noreferrer" class="whatsapp-btn fixed bottom-6 right-6 z-50 bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-2xl transition-all duration-300 transform hover:scale-110 flex items-center justify-center group" aria-label="Contactar por WhatsApp">
  <!-- WhatsApp Icon (SVG) -->
  <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
  </svg>
  <!-- Tooltip on hover -->
  <span class="absolute right-full mr-3 bg-gray-800 text-white text-sm font-medium px-3 py-2 rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
    ¬øDudas? Habla con un especialista gratis
  </span>
</a>

<!-- Social Proof Notification -->
<div id="social-proof-notification" class="fixed bottom-6 left-6 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-4 max-w-xs transform -translate-x-full opacity-0 transition-all duration-500 ease-out border border-gray-100 dark:border-gray-700">
  <div class="flex items-start gap-3">
    <div class="flex-shrink-0 w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center">
      <span class="material-icons text-primary text-xl">check_circle</span>
    </div>
    <div class="flex-1 min-w-0">
      <p class="text-sm font-medium text-gray-900 dark:text-white" id="social-proof-name">Mar√≠a G.</p>
      <p class="text-xs text-gray-500 dark:text-gray-400" id="social-proof-message">acaba de reservar una sesi√≥n</p>
      <p class="text-xs text-primary mt-1" id="social-proof-location">Madrid</p>
    </div>
    <button onclick="hideSocialProof()" class="flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
      <span class="material-icons text-lg">close</span>
    </button>
  </div>
</div>

<script>
// Social Proof Notification System
(function() {
  const names = [
    'Mar√≠a G.', 'Carlos R.', 'Ana M.', 'Pedro L.', 'Laura S.',
    'Miguel A.', 'Carmen P.', 'Francisco J.', 'Isabel T.', 'Antonio B.',
    'Elena V.', 'Javier M.', 'Rosa C.', 'Manuel D.', 'Patricia H.'
  ];

  const cities = [
    'Madrid', 'Barcelona', 'Valencia', 'Sevilla', 'San Sebasti√°n de los Reyes',
    'Majadahonda', 'Torrej√≥n de Ardoz'
  ];

  const messages = [
    'acaba de reservar una sesi√≥n',
    'ha reservado su cita',
    'se ha apuntado para dejar de fumar',
    'ha dado el primer paso'
  ];

  const notification = document.getElementById('social-proof-notification');
  const nameEl = document.getElementById('social-proof-name');
  const messageEl = document.getElementById('social-proof-message');
  const locationEl = document.getElementById('social-proof-location');

  function getRandomItem(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function showSocialProof() {
    // Update content with random data
    nameEl.textContent = getRandomItem(names);
    messageEl.textContent = getRandomItem(messages);
    locationEl.textContent = getRandomItem(cities);

    // Show notification
    notification.classList.remove('-translate-x-full', 'opacity-0');
    notification.classList.add('translate-x-0', 'opacity-100');

    // Hide after 7 seconds
    setTimeout(hideSocialProof, 7000);
  }

  window.hideSocialProof = function() {
    notification.classList.add('-translate-x-full', 'opacity-0');
    notification.classList.remove('translate-x-0', 'opacity-100');
  };

  // Show first notification after 10 seconds, then every 1 minute
  setTimeout(showSocialProof, 10000);
  setInterval(showSocialProof, 60000);
})();
</script>

</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // Centers data with real GPS coordinates
    // Only 8 centers available in Smart Agenda (removed: Alicante, Barcelona Gr√†cia, Terrassa)
    const centers = {
      'barcelona-sants': {
        lat: 41.3784, lng: 2.1366,
        name: 'LaserOstop Barcelona Sants',
        address: 'Carrer de Galileu, 65, Sants-Montju√Øc, 08028, Barcelona',
        hours: '08:00 - 18:00',
        phone: '+34 689 560 130'
      },
      'madrid-atocha': {
        lat: 40.3940, lng: -3.6835,
        name: 'LaserOstop Madrid Atocha',
        address: 'Calle Canarias 26, Atocha, 28045, Madrid',
        hours: '10:00 - 19:00',
        phone: '+34 613 255 948'
      },
      'madrid-chamartin': {
        lat: 40.4640, lng: -3.6783,
        name: 'LaserOstop Madrid Chamart√≠n',
        address: 'Calle de Oruro, 9, Chamart√≠n, 28016, Madrid',
        hours: '09:00 - 16:00',
        phone: '+34 919 305 313'
      },
      'majadahonda': {
        lat: 40.4732, lng: -3.8714,
        name: 'LaserOstop Majadahonda',
        address: 'Calle del Dr Calero, 19, Centro comercial Tutti, 28220, Majadahonda',
        hours: '09:00 - 16:00',
        phone: '+34 919 305 313'
      },
      'san-sebastian': {
        lat: 40.5485, lng: -3.6295,
        name: 'LaserOstop San Sebasti√°n de los Reyes',
        address: 'Avenida de Murcia, 5, 28702, San Sebasti√°n de los Reyes',
        hours: '09:00 - 16:00',
        phone: '+34 919 305 313'
      },
      'torrejon': {
        lat: 40.4578, lng: -3.4763,
        name: 'LaserOstop Torrej√≥n de Ardoz',
        address: 'Calle pesquera, 10, 28850, Torrej√≥n de Ardoz',
        hours: '09:00 - 16:00',
        phone: '+34 919 305 313'
      },
      'valencia': {
        lat: 39.4699, lng: -0.3763,
        name: 'LaserOstop Barcelona',
        address: 'Calle San Vicente M√°rtir 85 planta 7, 46007, Valencia',
        hours: '09:00 - 18:00',
        phone: '+34 689 560 130'
      },
      'sevilla': {
        lat: 37.3891, lng: -5.9845,
        name: 'LaserOstop Sevilla',
        address: 'Avenida Edouardo Dato 85, 41005, Sevilla',
        hours: '09:00 - 19:00',
        phone: '+34 689 560 130'
      }
    };

    let map;

    // Initialize Leaflet map
    function initializeMap() {
      // Guard: skip if map container doesn't exist (removed in clone)
      if (!document.getElementById('spain-map')) {
        console.log('Map container not found - skipping map initialization');
        return;
      }
      // Create map centered on Spain
      map = L.map('spain-map').setView([40.4168, -3.7038], 6);

      // Add OpenStreetMap tiles (free, no API key needed)
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        minZoom: 5
      }).addTo(map);

      // Custom marker icon
      const customIcon = L.divIcon({
        className: 'custom-marker',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      });

      // Add markers for each center
      Object.keys(centers).forEach(centerId => {
        const center = centers[centerId];

        const marker = L.marker([center.lat, center.lng], { icon: customIcon })
          .addTo(map);

        // Create popup content
        const popupContent = `
          <div style="min-width: 200px;">
            <h3 style="font-size: 16px; margin-bottom: 8px;">${center.name}</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 4px;">
              <span style="display: inline-block; width: 18px;">üìç</span> ${center.address}
            </p>
            <p style="font-size: 13px; color: #666; margin-bottom: 4px;">
              <span style="display: inline-block; width: 18px;">‚è∞</span> ${center.hours}
            </p>
            <p style="font-size: 13px; color: #666; margin-bottom: 8px;">
              <span style="display: inline-block; width: 18px;">üìû</span> ${center.phone}
            </p>
            <button onclick="selectCenter('${centerId}')"
                    style="background: #22A9AF; color: white; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; width: 100%;">
              Seleccionar este centro
            </button>
          </div>
        `;

        marker.bindPopup(popupContent);

        // Open popup on marker click
        marker.on('click', function() {
          map.setView([center.lat, center.lng], 12);
        });
      });
    }

    // Select center function
    function selectCenter(centerId) {
      const select = document.getElementById('center-select');
      select.value = centerId;
      select.dispatchEvent(new Event('change'));

      // Close any open popups
      map.closePopup();

      // Scroll to booking form
      document.getElementById('booking').scrollIntoView({ behavior: 'smooth' });
    }

    // Validation and confirmation function
    async function showConfirmation(event) {
      // Prevent default if called from button
      if (event) event.preventDefault();

      // Get form inputs
      const fullName = document.getElementById('full-name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();

      // Validation errors array
      const errors = [];

      // Validate center selection
      if (!bookingState.selectedCenter) {
        errors.push('Por favor, seleccione un centro');
      }

      // Validate booking type selection
      if (!bookingState.selectedAppointmentType) {
        errors.push('Por favor, seleccione el tipo de sesi√≥n');
      }

      // Validate date selection
      if (!bookingState.selectedDate) {
        errors.push('Por favor, seleccione una fecha');
      }

      // Validate time selection
      if (!bookingState.selectedTime) {
        errors.push('Por favor, seleccione una hora');
      }

      // Validate full name
      if (!fullName || fullName.length < 3) {
        errors.push('Por favor, ingrese su nombre completo');
      }

      // Validate email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        errors.push('Por favor, ingrese un correo electr√≥nico v√°lido');
      }

      // Validate phone
      const phoneRegex = /^[+]?[\d\s()-]{9,}$/;
      if (!phone || !phoneRegex.test(phone)) {
        errors.push('Por favor, ingrese un n√∫mero de tel√©fono v√°lido');
      }

      // Show errors or proceed
      if (errors.length > 0) {
        alert('Por favor, complete todos los campos requeridos:\n\n' + errors.join('\n'));
        return;
      }

      // Store user data in booking state
      bookingState.fullName = fullName;
      bookingState.email = email;
      bookingState.phone = phone;

      console.log('Final booking data:', bookingState);

      // Get button reference
      const confirmBtn = event?.target || document.querySelector('button[onclick*="showConfirmation"]');

      // Submit booking to Smart Agenda API
      try {
        // Show loading state
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="material-icons animate-spin mr-2">sync</span> Procesando...';

        const result = await submitBooking();

        console.log('Booking created successfully:', result);

        // Update confirmation message with actual data
        const centerName = bookingState.smartAgendaCenters.find(c => c.id === bookingState.selectedCenter)?.name || 'nuestro centro';
        const dateStr = `${bookingState.selectedDate.getDate()} de ${monthNames[bookingState.selectedDate.getMonth()]} de ${bookingState.selectedDate.getFullYear()}`;

        document.querySelector('#confirmation-message p:last-child').innerHTML =
          `Estaremos encantados de recibirle en el centro <strong>${centerName}</strong> el <strong>${dateStr} a las ${bookingState.selectedTime}</strong>.`;

        // Show confirmation and scroll to center it on screen
        document.getElementById('booking-form').classList.add('hidden');
        document.getElementById('confirmation-message').classList.remove('hidden');

        // Scroll confirmation message to center of viewport
        setTimeout(() => {
          document.getElementById('confirmation-message').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }, 100);

        // Show payment options popup after 2 seconds
        setTimeout(() => {
          console.log('üîî Attempting to show payment popup...');
          console.log('üìã Booking state:', bookingState);
          console.log('üéØ Selected appointment type ID:', bookingState.selectedAppointmentType);
          showPaymentPopup();
        }, 2000);

      } catch (error) {
        console.error('Booking error:', error);
        alert('Error al crear la reserva: ' + error.message + '\n\nPor favor, int√©ntelo de nuevo o cont√°ctenos directamente.');

        // Restore button
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="material-icons mr-2">event_available</span> Confirmar la cita';
        }
      }
    }

    /**
     * Show payment options popup
     */
    function showPaymentPopup() {
      console.log('üí≥ showPaymentPopup() called');

      // Get selected appointment type to determine pricing
      const selectedType = bookingState.appointmentTypes.find(t => t.id === bookingState.selectedAppointmentType);

      console.log('üîç Looking for appointment type with ID:', bookingState.selectedAppointmentType);
      console.log('üìö Available appointment types:', bookingState.appointmentTypes);
      console.log('‚úÖ Found appointment type:', selectedType);

      if (!selectedType) {
        console.warn('‚ùå No appointment type found for payment popup');
        return;
      }

      // Prevent payment popup for free Rechute sessions
      if (selectedType.kind === 'rechute' || selectedType.price === 0) {
        console.log('‚ö†Ô∏è Rechute session (‚Ç¨0) - no payment required, skipping popup');
        return;
      }

      console.log('‚úÖ Appointment type is valid, proceeding with popup...');

      // Calculate prices based on appointment type using PRICE_TABLE
      let centerPrice, onlinePrice, monthlyPrice, monthlyTotal;

      // Get pricing from PRICE_TABLE using the 'kind' field for accurate mapping
      const priceData = PRICE_TABLE[selectedType.kind];

      if (!priceData) {
        console.error('No price data found for appointment type:', selectedType.kind);
        return;
      }

      centerPrice = priceData.center;
      onlinePrice = priceData.online;
      const onlineOldPrice = priceData.onlineOld || priceData.centerOld || centerPrice;
      monthlyPrice = priceData.plan ? priceData.plan[0] : 0;
      monthlyTotal = priceData.plan ? priceData.plan.reduce((sum, val) => sum + val, 0) : 0;

      // Calculate savings for all options
      const onlineSavings = onlineOldPrice - onlinePrice;
      const centerSavings = priceData.centerOld ? priceData.centerOld - centerPrice : 0;
      const planSavings = priceData.centerOld ? priceData.centerOld - monthlyTotal : 0;

      // Update popup prices - Online option (Option 1)
      document.getElementById('popup-online-price').textContent = `‚Ç¨${onlinePrice}`;
      document.getElementById('popup-online-original').textContent = `‚Ç¨${onlineOldPrice}`;
      document.getElementById('popup-online-btn-price').textContent = onlinePrice;
      document.getElementById('popup-savings-amount').textContent = onlineSavings;

      // Update center price (Option 2)
      document.getElementById('popup-center-price').textContent = `‚Ç¨${centerPrice}`;
      document.getElementById('popup-center-old').textContent = `‚Ç¨${priceData.centerOld || onlineOldPrice}`;
      document.getElementById('popup-center-savings').textContent = centerSavings;

      // Update monthly prices (Option 3)
      document.getElementById('popup-monthly-price').textContent = `‚Ç¨${monthlyPrice}`;
      document.getElementById('popup-monthly-total').textContent = monthlyTotal;
      document.getElementById('popup-monthly-btn-price').textContent = monthlyPrice;
      document.getElementById('popup-plan-savings').textContent = planSavings;

      // Store prices in popup for payment selection
      window.paymentPopupData = {
        centerPrice,
        onlinePrice,
        monthlyPrice,
        monthlyTotal,
        appointmentType: selectedType
      };

      // Show popup (fixed overlay - no scroll issues)
      const popupElement = document.getElementById('payment-popup');
      console.log('üé® Payment popup element:', popupElement);
      popupElement.classList.remove('hidden');
      console.log('‚úÖ Payment popup should now be visible!');
    }

    /**
     * Close payment popup
     */
    function closePaymentPopup() {
      document.getElementById('payment-popup').classList.add('hidden');
    }

    /**
     * Show promotional popup on page load
     */
    function showPromoPopup() {
      const promoPopup = document.getElementById('promo-popup');

      // Check if user has already seen the popup in this session
      if (sessionStorage.getItem('promoPopupSeen')) {
        return;
      }

      // Show popup after a short delay for better UX
      setTimeout(() => {
        promoPopup.classList.remove('hidden');
        // Mark as seen for this session
        sessionStorage.setItem('promoPopupSeen', 'true');
      }, 2000);
    }

    /**
     * Close promotional popup
     */
    function closePromoPopup() {
      document.getElementById('promo-popup').classList.add('hidden');
    }

    /**
     * Close promotional popup and scroll to booking section
     */
    function closePromoAndScroll() {
      // Close the popup
      closePromoPopup();

      // Scroll to booking section
      const bookingSection = document.getElementById('booking');
      if (bookingSection) {
        bookingSection.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }

    /**
     * Get Stripe payment links based on center and appointment type
     * Now uses the 'kind' field for more reliable mapping
     */
    function getStripeLinks(centerId, appointmentTypeId) {
      // Get the appointment type object to access 'kind' field
      const types = APPOINTMENT_TYPES[String(centerId)] || [];
      const appointmentType = types.find(t => t.id === String(appointmentTypeId));

      if (!appointmentType) {
        console.error('Appointment type not found:', appointmentTypeId);
        return { onetime: '#', monthly: '#' };
      }

      // Rechute has no payment - return null
      if (appointmentType.kind === 'rechute') {
        return null;
      }

      // Get company
      const company = getCompany(centerId);

      // Stripe Payment Links Configuration - UPDATED Nov 2025
      const stripeLinks = {
        company1: {
          // Company 1: Madrid Chamart√≠n, Torrej√≥n, Majadahonda, San Sebasti√°n
          solo_cig: {
            onetime: 'https://buy.stripe.com/5kQdR85fNfQG9PvbCJawo0b',  // ‚Ç¨149
            monthly: 'https://buy.stripe.com/dRm6oGbEb1ZQ8LreOVawo0f'   // 3√ó‚Ç¨60
          },
          duo_cig: {
            onetime: 'https://buy.stripe.com/28E9AS0ZxfQGd1H4ahawo01',   // ‚Ç¨320
            monthly: 'https://buy.stripe.com/9B64gyeQn7kabXD9uBawo07'    // 3√ó‚Ç¨105
          },
          solo_drugs: {
            onetime: 'https://buy.stripe.com/9B6bJ09w3bAq9Pv36dawo0d', // ‚Ç¨189
            monthly: 'https://buy.stripe.com/fZu00i0Zx47Ye5L9uBawo0e'  // 3√ó‚Ç¨70
          },
          solo_sugar: {
            onetime: 'https://buy.stripe.com/4gM5kCaA7dIyaTz9uBawo09', // ‚Ç¨180
            monthly: 'https://buy.stripe.com/8x214maA7fQG7Hn36dawo0a'  // 3√ó‚Ç¨60
          }
        },
        company2: {
          // Company 2: Valencia, Barcelona Sants, Sevilla, Madrid Atocha
          solo_cig: {
            onetime: 'https://buy.stripe.com/4gM8wPbgpcsdfoL5sAdby0j',  // ‚Ç¨149
            monthly: 'https://buy.stripe.com/dRm9ATckt4ZLdgDf3adby0n'   // 3√ó‚Ç¨60
          },
          duo_cig: {
            onetime: 'https://buy.stripe.com/8x2fZh3NX4ZL2BZ6wEdby09',   // ‚Ç¨320
            monthly: 'https://buy.stripe.com/7sYcN5dox3VH1xV08gdby0f'    // 3√ó‚Ç¨105
          },
          solo_drugs: {
            onetime: 'https://buy.stripe.com/28E28rcktfEpb8vf3adby0l', // ‚Ç¨189
            monthly: 'https://buy.stripe.com/bJe4gz98h2RD0tR3ksdby0m'  // 3√ó‚Ç¨70
          },
          solo_sugar: {
            onetime: 'https://buy.stripe.com/5kQ14n7090Jv3G39IQdby0h', // ‚Ç¨180
            monthly: 'https://buy.stripe.com/9B6bJ198h3VH0tR8EMdby0i'  // 3√ó‚Ç¨60
          }
        }
      };

      // Get links for this company and kind
      const companyLinks = stripeLinks[company];
      return companyLinks[appointmentType.kind] || { onetime: '#', monthly: '#' };
    }

    /**
     * Select payment option
     */
    function selectPaymentOption(option) {
      const data = window.paymentPopupData;

      if (!data) {
        console.error('Payment popup data not available');
        return;
      }

      // Get appointment type details
      const types = APPOINTMENT_TYPES[String(bookingState.selectedCenter)] || [];
      const appointmentType = types.find(t => t.id === String(data.appointmentType.id));

      if (!appointmentType) {
        console.error('Appointment type not found');
        return;
      }

      if (option === 1) {
        // Pay online once - redirect to Stripe (NOW OPTION 1 - RECOMMENDED)
        const stripeLinks = getStripeLinks(bookingState.selectedCenter, data.appointmentType.id);

        if (!stripeLinks) {
          // Rechute - no payment needed
          alert('Reservas de reca√≠da no requieren pago. Contin√∫e con la reserva.');
          closePaymentPopup();
          return;
        }

        console.log('Opening Stripe one-time payment:', stripeLinks.onetime);
        console.log('Center:', bookingState.selectedCenter, 'Type:', appointmentType.kind);

        // Open Stripe payment link in new tab
        window.open(stripeLinks.onetime, '_blank');

        // Close popup
        closePaymentPopup();
      } else if (option === 2) {
        // Pay at center (NOW OPTION 2)
        closePaymentPopup();
      } else if (option === 3) {
        // Pay in 3 installments - redirect to Stripe subscription
        const stripeLinks = getStripeLinks(bookingState.selectedCenter, data.appointmentType.id);

        if (!stripeLinks) {
          // Rechute - no payment needed
          alert('Reservas de reca√≠da no requieren pago. Contin√∫e con la reserva.');
          closePaymentPopup();
          return;
        }

        console.log('Opening Stripe monthly payment:', stripeLinks.monthly);
        console.log('Center:', bookingState.selectedCenter, 'Type:', appointmentType.kind);

        // Open Stripe subscription link in new tab
        window.open(stripeLinks.monthly, '_blank');

        // Close popup
        closePaymentPopup();
      }
    }

    // ========== CALENDAR AND BOOKING LOGIC ==========

    // API Configuration - points to Render backend
    const API_BASE_URL = 'https://laserostop-backend.onrender.com/api';

    // Booking state
    let bookingState = {
      selectedCenter: null,
      selectedDate: null,
      selectedTime: null,
      currentMonth: new Date(),
      availableSlots: {}, // Will be populated from Smart Agenda API
      smartAgendaCenters: [], // Centers from Smart Agenda
      appointmentTypes: [], // Appointment types for selected center
      autoSelected: false // Track if slot was auto-selected
    };

    // Month names in Spanish
    const monthNames = [
      'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];

    // Day names in Spanish
    const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

    // ========== HARDCODED APPOINTMENT TYPES (Bypass Smart Agenda API sync issue) ==========

    /**
     * Static appointment types - Source of truth for UI
     * Note: This bypasses the Smart Agenda API /pdo_type_rdv endpoint which has sync issues
     * Availability and booking still use live API
     */
    // PROD APPOINTMENT TYPES - Filtered to show only original 4 types (matching TEST/DEV)
    // Source: https://www.smartagenda.fr/pro/laserostop-esh (PROD environment)
    // STANDARD ONLINE PRICES: Solo 149‚Ç¨, Duo 269‚Ç¨, Cannabis 189‚Ç¨, Sugar 180‚Ç¨
    // Mapping: Valencia=10, Barcelona=43, Sevilla=44, Chamartin=48, Torrejon=49, Atocha=50, Majadahonda=51, San Sebastian=52
    const APPOINTMENT_TYPES = {
      '10': [ // Valencia - 5 types (added sugar)
        { id: '1',  kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 149, deposit: 0, centerId: '10' },
        { id: '9',  kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 269, deposit: 0, centerId: '10' },
        { id: '18', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 189, deposit: 0, centerId: '10' },
        { id: '3',  kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '10' },
        { id: '98', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 180, deposit: 0, centerId: '10' }
      ],
      '43': [ // Barcelona - 5 types (added sugar)
        { id: '20', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 149, deposit: 0, centerId: '43' },
        { id: '21', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 269, deposit: 0, centerId: '43' },
        { id: '23', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 189, deposit: 0, centerId: '43' },
        { id: '22', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '43' },
        { id: '91', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 180, deposit: 0, centerId: '43' }
      ],
      '44': [ // Sevilla - 5 types (added sugar)
        { id: '32', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 149, deposit: 0, centerId: '44' },
        { id: '34', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 269, deposit: 0, centerId: '44' },
        { id: '37', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 189, deposit: 0, centerId: '44' },
        { id: '35', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '44' },
        { id: '96', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 180, deposit: 0, centerId: '44' }
      ],
      '49': [ // Torrej√≥n - 5 types (added sugar)
        { id: '53', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 149, deposit: 0, centerId: '49' },
        { id: '56', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 269, deposit: 0, centerId: '49' },
        { id: '59', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 189, deposit: 0, centerId: '49' },
        { id: '57', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '49' },
        { id: '97', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 180, deposit: 0, centerId: '49' }
      ],
      '48': [ // Madrid Chamart√≠n - 5 types (added sugar)
        { id: '44', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 149, deposit: 0, centerId: '48' },
        { id: '46', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 269, deposit: 0, centerId: '48' },
        { id: '49', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 189, deposit: 0, centerId: '48' },
        { id: '47', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '48' },
        { id: '93', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 180, deposit: 0, centerId: '48' }
      ],
      '50': [ // Madrid Atocha - 5 types (added sugar)
        { id: '63', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 149, deposit: 0, centerId: '50' },
        { id: '65', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 269, deposit: 0, centerId: '50' },
        { id: '68', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 189, deposit: 0, centerId: '50' },
        { id: '66', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '50' },
        { id: '92', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 180, deposit: 0, centerId: '50' }
      ],
      '52': [ // San Sebasti√°n - 5 types (added sugar)
        { id: '81', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 149, deposit: 0, centerId: '52' },
        { id: '83', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 269, deposit: 0, centerId: '52' },
        { id: '86', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 189, deposit: 0, centerId: '52' },
        { id: '84', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '52' },
        { id: '95', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 180, deposit: 0, centerId: '52' }
      ],
      '51': [ // Majadahonda - 5 types (added sugar)
        { id: '72', kind: 'solo_cig',     name: 'Solo ‚Äì Dejar de fumar (1h)', duration: 60, price: 149, deposit: 0, centerId: '51' },
        { id: '74', kind: 'duo_cig',      name: 'Duo ‚Äì Dejar de fumar (1h30)', duration: 90, price: 269, deposit: 0, centerId: '51' },
        { id: '77', kind: 'solo_drugs',   name: 'Adicci√≥n al cannabis (1h)', duration: 60, price: 189, deposit: 0, centerId: '51' },
        { id: '75', kind: 'rechute',      name: 'En caso de reca√≠da (30mn)', duration: 30, price: 0, deposit: 0, centerId: '51' },
        { id: '94', kind: 'solo_sugar',   name: 'Adicci√≥n al az√∫car (1h)', duration: 60, price: 180, deposit: 0, centerId: '51' }
      ]
    };

    /**
     * Price table - Single source of truth for payment UI
     */
    const PRICE_TABLE = {
      solo_cig:   { centerOld: 190, center: 190, onlineOld: 190, online: 149, plan: [60, 60, 60] },
      duo_cig:    { centerOld: 380, center: 340, onlineOld: 380, online: 269, plan: [90, 90, 90] },
      solo_drugs: { centerOld: 300, center: 250, onlineOld: 300, online: 189, plan: [70, 70, 70] },
      rechute:    { center: 0 },
      solo_sugar: { centerOld: 280, center: 200, onlineOld: 280, online: 180, plan: [60, 60, 60] }
    };

    /**
     * Company routing - determines which Stripe account to use
     * FIXED: Using correct pdo_agenda IDs
     */
    const COMPANY1_CENTERS = new Set(['48', '49', '51', '52']); // Madrid Chamart√≠n, Torrej√≥n, Majadahonda, San Sebasti√°n
    const COMPANY2_CENTERS = new Set(['10', '43', '44', '50']);  // Valencia, Barcelona Sants, Sevilla, Madrid Atocha

    function getCompany(centerId) {
      return COMPANY1_CENTERS.has(String(centerId)) ? 'company1' : 'company2';
    }

    // ========== API FUNCTIONS ==========

    /**
     * Load centers from Smart Agenda API with retry logic
     * Handles Render.com cold starts and network timeouts
     */
    async function loadCentersFromAPI(retries = 3) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          console.log(`Loading centers from Smart Agenda... (attempt ${attempt}/${retries})`);

          // Add 60-second timeout to handle Render cold starts
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 seconds

          const response = await fetch(`${API_BASE_URL}/centers`, {
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const centers = await response.json();

          // Validate response
          if (!centers || centers.length === 0) {
            throw new Error('Empty centers response from API');
          }

          bookingState.smartAgendaCenters = centers;
          console.log('‚úÖ Loaded', centers.length, 'centers from Smart Agenda');

          // Populate the center dropdown
          populateCenterDropdown(centers);

          return centers;

        } catch (error) {
          console.error(`‚ùå Attempt ${attempt} failed:`, error.message);

          // If not the last attempt, retry with exponential backoff
          if (attempt < retries) {
            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000); // 1s, 2s, 4s max
            console.log(`‚è≥ Retrying in ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          } else {
            // Final attempt failed - show error to user
            console.error('‚ùå All retry attempts failed');
            alert('Error al cargar los centros. Por favor, recargue la p√°gina.');
            return [];
          }
        }
      }
    }

    /**
     * Populate center dropdown with API data - Grouped by city
     */
    function populateCenterDropdown(centers) {
      const select = document.getElementById('center-select');

      // Clear existing options
      select.innerHTML = '<option value="">Seleccione su ciudad y centro...</option>';

      // Define city groups with their centers
      const cityGroups = {
        'Madrid': [
          { id: '50', name: 'Madrid ‚Äì Atocha' },
          { id: '48', name: 'Madrid ‚Äì Chamart√≠n' },
          { id: '51', name: 'Madrid ‚Äì Majadahonda' },
          { id: '49', name: 'Madrid ‚Äì Torrej√≥n de Ardoz' }
        ],
        'Barcelona': [
          { id: '43', name: 'Barcelona' }
        ],
        'San Sebasti√°n': [
          { id: '52', name: 'San Sebasti√°n' }
        ],
        'Sevilla': [
          { id: '44', name: 'Sevilla' }
        ],
        'Valencia': [
          { id: '10', name: 'Valencia' }
        ]
      };

      // Create optgroups for each city
      Object.entries(cityGroups).forEach(([city, cityCenters]) => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = city;

        cityCenters.forEach(center => {
          // Check if this center exists in the API data
          const centerExists = centers.find(c => c.id === center.id);
          if (centerExists) {
            const option = document.createElement('option');
            option.value = center.id;
            option.textContent = center.name;
            optgroup.appendChild(option);
          }
        });

        // Only add optgroup if it has at least one center
        if (optgroup.children.length > 0) {
          select.appendChild(optgroup);
        }
      });
    }

    /**
     * Load appointment types for selected center
     * NOTE: Using hardcoded data instead of API due to Smart Agenda sync issues
     */
    async function loadAppointmentTypes(centerId) {
      try {
        console.log('Loading appointment types for center:', centerId);

        // Use hardcoded data instead of API
        const types = APPOINTMENT_TYPES[centerId] || [];
        bookingState.appointmentTypes = types;

        console.log('Loaded', types.length, 'appointment types (from static data)');

        // Warn if no appointment types available
        if (types.length === 0) {
          console.warn('‚ö†Ô∏è No appointment types available for this center');
          const centerName = bookingState.smartAgendaCenters.find(c => c.id === centerId)?.name;
          alert(`‚ö†Ô∏è Atenci√≥n:\n\nEl centro "${centerName}" no tiene citas disponibles a trav√©s de este formulario.\n\nPor favor:\n- Seleccione otro centro\n- O contacte directamente con el centro.`);
        }

        // Auto-select the first type if available
        if (types.length > 0) {
          bookingState.selectedAppointmentType = types[0].id;
        }

        return types;
      } catch (error) {
        console.error('Error loading appointment types:', error);
        return [];
      }
    }

    /**
     * Load availability for selected date range
     * FIXED: Now uses correct Smart Agenda service endpoint
     */
    async function loadAvailability(startDate, endDate) {
      if (!bookingState.selectedCenter || !bookingState.selectedAppointmentType) {
        console.log('Center or appointment type not selected');
        return {};
      }

      try {
        console.log('Loading availability from', formatDateForAPI(startDate), 'to', formatDateForAPI(endDate));

        const params = new URLSearchParams({
          centerId: bookingState.selectedCenter,  // Center ID (pdo_groupe)
          typeId: bookingState.selectedAppointmentType,
          startDate: formatDateForAPI(startDate),
          endDate: formatDateForAPI(endDate)
        });

        const response = await fetch(`${API_BASE_URL}/availability?${params.toString()}`);

        if (!response.ok) {
          if (response.status === 404) {
            console.warn('‚ö†Ô∏è No availability found - Time slots may not be opened in Smart Agenda dashboard');
            bookingState.availableSlots = {};
            return {};
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const availability = await response.json();
        console.log('‚úÖ Availability data loaded:', availability.length, 'days');

        bookingState.availableSlots = processAvailabilityData(availability);

        return bookingState.availableSlots;
      } catch (error) {
        console.error('‚ùå Error loading availability:', error);
        bookingState.availableSlots = {};
        return {};
      }
    }

    /**
     * Process availability data from API into time slots format
     * Smart Agenda format: Array of {dj: 'YYYY-MM-DD', det: [{idp: 'HH:MM', ...}, ...]}
     */
    function processAvailabilityData(apiData) {
      const slots = {};

      if (!Array.isArray(apiData)) {
        console.warn('Invalid availability data format');
        return slots;
      }

      // Process each day
      apiData.forEach(day => {
        const dateKey = day.dj; // Date in YYYY-MM-DD format
        if (!dateKey || !day.det || !Array.isArray(day.det)) {
          return;
        }

        // Create slots object for this date
        slots[dateKey] = {};

        // Process each time slot
        day.det.forEach(slot => {
          // FIXED: Smart Agenda uses 'idp' field, not 'hd'
          if (slot.idp) {
            const time = slot.idp; // Already in 'HH:MM' format
            slots[dateKey][time] = true;
          }
        });
      });

      console.log('Processed availability slots:', Object.keys(slots).length, 'days');

      // Apply slot filtering to create scarcity perception
      return applySlotFiltering(slots);
    }

    // ========== SLOT FILTERING SYSTEM ==========
    // Strategy: Show limited slots per day to create urgency and distribute bookings evenly
    // Different users see different slots based on fingerprint + date hash

    /**
     * Slot filtering configuration
     */
    const SLOT_FILTER_CONFIG = {
      enabled: true,              // Master toggle
      maxSlotsPerDay: 4,         // Maximum slots to show per day
      minSpacingMinutes: 60,     // Minimum minutes between displayed slots
      showAllIfFewer: 4          // If total slots <= this, show all
    };

    /**
     * Generate anonymous user fingerprint for consistent slot selection
     * Uses browser characteristics (no personal data)
     */
    function getUserFingerprint() {
      // Try to get cached fingerprint first
      let fingerprint = sessionStorage.getItem('userFingerprint');

      if (!fingerprint) {
        // Create fingerprint from browser metadata
        const components = [
          navigator.userAgent,
          navigator.language,
          screen.width + 'x' + screen.height,
          screen.colorDepth,
          new Date().getTimezoneOffset(),
          navigator.hardwareConcurrency || 0,
          navigator.platform
        ];

        // Simple hash function
        let hash = 0;
        const str = components.join('|');
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32-bit integer
        }

        fingerprint = Math.abs(hash).toString(36);
        sessionStorage.setItem('userFingerprint', fingerprint);
      }

      return fingerprint;
    }

    /**
     * Seeded random number generator for deterministic shuffling
     * Same seed always produces same sequence
     */
    function seededRandom(seed) {
      let value = seed;
      return function() {
        value = (value * 9301 + 49297) % 233280;
        return value / 233280;
      };
    }

    /**
     * Shuffle array using seeded random (deterministic)
     */
    function seededShuffle(array, seed) {
      const shuffled = [...array];
      const random = seededRandom(seed);

      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }

      return shuffled;
    }

    /**
     * Convert time string (HH:MM) to minutes since midnight
     */
    function timeToMinutes(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    /**
     * Simple string hash function
     */
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash);
    }

    /**
     * Filter slots for a single date to show limited selection
     */
    function filterSlotsForDate(times, date, userFingerprint) {
      if (!SLOT_FILTER_CONFIG.enabled) {
        return times; // Filtering disabled, return all
      }

      if (times.length <= SLOT_FILTER_CONFIG.showAllIfFewer) {
        return times; // Show all if few slots available
      }

      // Generate deterministic seed from fingerprint + date
      const seed = simpleHash(userFingerprint + date);

      // Shuffle slots deterministically
      const shuffled = seededShuffle(times, seed);

      // Select slots with minimum spacing
      const selected = [];

      for (const time of shuffled) {
        if (selected.length >= SLOT_FILTER_CONFIG.maxSlotsPerDay) {
          break;
        }

        // Check if time has minimum spacing from all selected slots
        const timeMinutes = timeToMinutes(time);
        const hasMinimumSpacing = selected.every(selectedTime => {
          const selectedMinutes = timeToMinutes(selectedTime);
          return Math.abs(timeMinutes - selectedMinutes) >= SLOT_FILTER_CONFIG.minSpacingMinutes;
        });

        if (hasMinimumSpacing || selected.length === 0) {
          selected.push(time);
        }
      }

      // Return in chronological order
      return selected.sort();
    }

    /**
     * Apply slot filtering to all dates
     */
    function applySlotFiltering(allSlots) {
      if (!SLOT_FILTER_CONFIG.enabled) {
        return allSlots; // Return unfiltered if disabled
      }

      const fingerprint = getUserFingerprint();
      const filteredSlots = {};

      // Process each date
      for (const dateKey in allSlots) {
        const times = Object.keys(allSlots[dateKey]).sort();
        const filteredTimes = filterSlotsForDate(times, dateKey, fingerprint);

        // Rebuild slots object with filtered times
        filteredSlots[dateKey] = {};
        filteredTimes.forEach(time => {
          filteredSlots[dateKey][time] = true;
        });

        console.log(`üìä Date ${dateKey}: ${times.length} slots ‚Üí ${filteredTimes.length} shown`);
      }

      console.log('‚úÖ Slot filtering applied - User fingerprint:', fingerprint.substring(0, 8) + '...');
      return filteredSlots;
    }

    /**
     * Format date for API (YYYY-MM-DD)
     */
    function formatDateForAPI(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * Format datetime for API (YYYY-MM-DD HH:MM:SS)
     */
    function formatDateTimeForAPI(date, time) {
      return `${formatDateForAPI(date)} ${time}:00`;
    }

    /**
     * Submit booking to Smart Agenda
     */
    async function submitBooking() {
      try {
        console.log('Submitting booking to Smart Agenda...');

        // Calculate end time (assuming 30 min appointment)
        const startDateTime = formatDateTimeForAPI(bookingState.selectedDate, bookingState.selectedTime);
        const endTime = bookingState.selectedTime.split(':');
        const endHour = parseInt(endTime[0]);
        let endMin = parseInt(endTime[1]) + 30;
        let finalEndHour = endHour;

        // Handle minute overflow
        if (endMin >= 60) {
          finalEndHour = endHour + 1;
          endMin = endMin - 60;
        }

        const endDateTime = formatDateTimeForAPI(
          bookingState.selectedDate,
          `${String(finalEndHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`
        );

        // Use appointment type from loaded types
        let typeId = bookingState.selectedAppointmentType;

        // If no appointment type is selected, try to use the first available one
        if (!typeId && bookingState.appointmentTypes && bookingState.appointmentTypes.length > 0) {
          typeId = bookingState.appointmentTypes[0].id;
          console.log('Auto-selected first appointment type:', typeId);
        }

        // If still no appointment type, this center doesn't have any configured
        if (!typeId) {
          throw new Error('Este centro no tiene tipos de cita configurados. Por favor, seleccione otro centro o use el enlace de reserva directo del centro.');
        }

        // Detect URL source for tracking
        const urlPath = window.location.pathname;
        const urlSlug = urlPath.split('/').filter(p => p)[0];
        const source = urlSlug || 'direct';

        const bookingData = {
          fullName: bookingState.fullName,
          email: bookingState.email,
          phone: bookingState.phone,
          centerId: bookingState.selectedCenter,
          typeId: typeId,
          startTime: startDateTime,
          endTime: endDateTime,
          source: source // Track where booking came from
        };

        console.log('Booking data:', bookingData);

        const response = await fetch(`${API_BASE_URL}/booking`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(bookingData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Backend error response:', errorData);
          throw new Error(errorData.details || errorData.message || errorData.error || 'Booking failed');
        }

        const result = await response.json();
        console.log('‚úÖ Booking successful:', result);

        return result;
      } catch (error) {
        console.error('‚ùå Error submitting booking:', error);
        throw error;
      }
    }

    // Sample time slots (fallback for when API doesn't return data)
    const sampleTimeSlots = {
      '09:00': true,
      '09:30': true,
      '10:00': true,
      '10:30': false, // unavailable
      '11:00': true,
      '11:30': true,
      '12:00': false, // unavailable
      '14:00': true,
      '14:30': true,
      '15:00': true,
      '15:30': true,
      '16:00': true,
      '16:30': false, // unavailable
      '17:00': true,
      '17:30': true,
      '18:00': true
    };

    // Generate calendar for current month
    function generateCalendar() {
      const year = bookingState.currentMonth.getFullYear();
      const month = bookingState.currentMonth.getMonth();

      // Update month display
      document.getElementById('current-month').textContent =
        `${monthNames[month]} ${year}`;

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();

      // Get day of week for first day (0 = Sunday, adjust to Monday = 0)
      let startDay = firstDay.getDay() - 1;
      if (startDay === -1) startDay = 6; // Sunday becomes 6

      // Get today's date for comparison
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const calendarGrid = document.getElementById('calendar-grid');
      calendarGrid.innerHTML = '';

      // Add empty cells for days before month starts
      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'text-gray-400 text-sm';
        calendarGrid.appendChild(emptyCell);
      }

      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayCell = document.createElement('div');

        const isPast = date < today;
        const isSunday = date.getDay() === 0; // Sunday = 0 (centers closed)
        const isSelected = bookingState.selectedDate &&
          date.toDateString() === bookingState.selectedDate.toDateString();
        const isToday = date.toDateString() === today.toDateString();

        // Base classes
        let classes = 'text-sm py-2 rounded-full transition-all';

        if (isPast || isSunday) {
          // Past dates or Sundays - disabled (centers closed on Sundays)
          classes += ' text-gray-400 cursor-not-allowed';
        } else if (isSelected) {
          // Selected date
          classes += ' bg-primary text-white cursor-pointer font-semibold transform scale-110';
        } else if (isToday) {
          // Today
          classes += ' bg-primary/20 border-2 border-primary text-primary cursor-pointer font-semibold hover:bg-primary/30';
        } else {
          // Future dates - selectable
          classes += ' hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer';
        }

        dayCell.className = classes;
        dayCell.textContent = day;

        // Add click handler for future dates (excluding Sundays)
        if (!isPast && !isSunday) {
          dayCell.onclick = () => selectDate(date);
        }

        calendarGrid.appendChild(dayCell);
      }
    }

    // Select a date
    function selectDate(date) {
      bookingState.selectedDate = date;
      bookingState.selectedTime = null; // Reset time selection

      generateCalendar(); // Refresh calendar to show selection
      generateTimeSlots(); // Show available time slots
      updateStepIndicators(); // Update visual indicators

      // Auto-scroll to time slots section for better UX - DISABLED
      // setTimeout(() => {
      //   document.getElementById('time-slots-section').scrollIntoView({
      //     behavior: 'smooth',
      //     block: 'start'
      //   });
      // }, 100);
    }

    // Generate time slots for selected date
    function generateTimeSlots() {
      const timeSlotsContainer = document.getElementById('time-slots');
      const dateInfo = document.getElementById('selected-date-info');

      if (!bookingState.selectedDate) {
        timeSlotsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-4">Seleccione una fecha para ver los horarios disponibles</p>';
        dateInfo.textContent = '';
        return;
      }

      // Show selected date
      const dayName = dayNames[bookingState.selectedDate.getDay()];
      const day = bookingState.selectedDate.getDate();
      const month = monthNames[bookingState.selectedDate.getMonth()];
      const year = bookingState.selectedDate.getFullYear();
      dateInfo.textContent = `Horarios para ${dayName}, ${day} de ${month} de ${year}`;

      // Get available slots for selected date
      const dateKey = formatDateForAPI(bookingState.selectedDate);
      const daySlots = bookingState.availableSlots[dateKey] || {};

      // Generate time slot buttons
      timeSlotsContainer.innerHTML = '';

      // If no slots available for this date, show message
      if (Object.keys(daySlots).length === 0) {
        timeSlotsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-4">‚ö†Ô∏è No hay horarios disponibles para esta fecha. Por favor, seleccione otra fecha o contacte al centro.</p>';
        return;
      }

      // Sort times and generate buttons
      const times = Object.keys(daySlots).sort();
      times.forEach(time => {
        const available = daySlots[time];
        const button = document.createElement('button');

        const isSelected = bookingState.selectedTime === time;

        if (isSelected) {
          button.className = 'py-2 px-3 bg-primary text-white rounded-full border border-primary font-semibold';
        } else if (available) {
          button.className = 'py-2 px-3 border border-border-light dark:border-border-dark rounded-full hover:border-primary hover:text-primary transition';
          button.onclick = () => selectTime(time);
        } else {
          button.className = 'py-2 px-3 border border-border-light dark:border-border-dark rounded-full text-gray-400 cursor-not-allowed opacity-50';
          button.disabled = true;
        }

        button.textContent = time;
        timeSlotsContainer.appendChild(button);
      });
    }

    // Select a time slot
    function selectTime(time) {
      bookingState.selectedTime = time;
      generateTimeSlots(); // Refresh to show selection
      updateStepIndicators(); // Update visual indicators

      // Auto-scroll to user info form for better UX - DISABLED
      // setTimeout(() => {
      //   document.getElementById('step-3').scrollIntoView({
      //     behavior: 'smooth',
      //     block: 'start'
      //   });
      // }, 100);

      console.log('Booking state:', bookingState);
      // This will be used later for Smart Agenda API call
    }

    /**
     * Auto-select the soonest available date and time slot
     * Called after availability data is loaded
     */
    function autoSelectSoonestSlot() {
      // Check if we have availability data
      if (!bookingState.availableSlots || Object.keys(bookingState.availableSlots).length === 0) {
        console.log('No availability data to auto-select');
        return;
      }

      // Get all dates sorted chronologically
      const availableDates = Object.keys(bookingState.availableSlots)
        .sort() // Already in YYYY-MM-DD format, sorts correctly
        .map(dateStr => new Date(dateStr));

      if (availableDates.length === 0) {
        console.log('No available dates found');
        return;
      }

      // Find the first future date (not in the past)
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const soonestDate = availableDates.find(date => date >= today);

      if (!soonestDate) {
        console.log('No future dates available');
        return;
      }

      // Get time slots for this date
      const dateKey = formatDateForAPI(soonestDate);
      const daySlots = bookingState.availableSlots[dateKey] || {};
      const availableTimes = Object.keys(daySlots).sort(); // Sort times: 09:00, 10:00, etc.

      if (availableTimes.length === 0) {
        console.log('No time slots available for soonest date');
        return;
      }

      const earliestTime = availableTimes[0];

      // Auto-select the date and time
      console.log(`‚ú® Auto-selecting: ${dateKey} at ${earliestTime}`);

      bookingState.selectedDate = soonestDate;
      bookingState.selectedTime = earliestTime;
      bookingState.autoSelected = true; // Flag to show it was auto-selected

      // Update calendar month to show the selected date's month
      bookingState.currentMonth = new Date(soonestDate.getFullYear(), soonestDate.getMonth(), 1);

      // Update UI
      generateCalendar(); // Refresh calendar with selection
      generateTimeSlots(); // Show time slots with selection
      updateStepIndicators();

      // Show notification to user
      showAutoSelectNotification(soonestDate, earliestTime);

      // Scroll to time slots so user sees the selection - DISABLED
      // setTimeout(() => {
      //   document.getElementById('time-slots-section').scrollIntoView({
      //     behavior: 'smooth',
      //     block: 'start'
      //   });
      // }, 500);
    }

    /**
     * Show notification that a slot was auto-selected
     */
    function showAutoSelectNotification(date, time) {
      const dayName = dayNames[date.getDay()];
      const day = date.getDate();
      const month = monthNames[date.getMonth()];

      const notification = document.createElement('div');
      notification.className = 'bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4 rounded mb-4 animate-fade-in';
      notification.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="material-icons text-green-600 text-xl">check_circle</span>
          <div>
            <p class="font-semibold text-green-800 dark:text-green-200">
              ‚ú® Preseleccionado para ti
            </p>
            <p class="text-sm text-green-700 dark:text-green-300 mt-1">
              ${dayName}, ${day} de ${month} a las ${time}
              <span class="text-xs block mt-1 opacity-75">Puedes cambiar la fecha y hora si lo deseas</span>
            </p>
          </div>
        </div>
      `;

      // Insert before calendar
      const step2 = document.getElementById('step-2');
      const calendarDiv = step2.querySelector('.bg-gray-50');
      if (calendarDiv && calendarDiv.parentElement) {
        calendarDiv.parentElement.insertBefore(notification, calendarDiv);

        // Auto-remove after 10 seconds
        setTimeout(() => {
          notification.style.transition = 'opacity 0.5s';
          notification.style.opacity = '0';
          setTimeout(() => notification.remove(), 500);
        }, 10000);
      }
    }

    // Navigate to previous month
    document.getElementById('prev-month').addEventListener('click', () => {
      bookingState.currentMonth.setMonth(bookingState.currentMonth.getMonth() - 1);

      // Load availability for new month
      if (bookingState.selectedCenter && bookingState.selectedAppointmentType) {
        // Start from tomorrow to avoid timezone issues with Smart Agenda
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const firstOfMonth = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth(), 1);
        const startDate = firstOfMonth < tomorrow ? tomorrow : firstOfMonth;

        // End date: last day of current month OR 30 days from start (whichever is later)
        const lastDayOfMonth = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth() + 1, 0);
        const thirtyDaysOut = new Date(startDate);
        thirtyDaysOut.setDate(startDate.getDate() + 30);
        const endDate = lastDayOfMonth > startDate ? lastDayOfMonth : thirtyDaysOut;

        loadAvailability(startDate, endDate).then(() => {
          generateCalendar();
        });
      } else {
        generateCalendar();
      }
    });

    // Navigate to next month
    document.getElementById('next-month').addEventListener('click', () => {
      bookingState.currentMonth.setMonth(bookingState.currentMonth.getMonth() + 1);

      // Load availability for new month
      if (bookingState.selectedCenter && bookingState.selectedAppointmentType) {
        // Start from tomorrow to avoid timezone issues with Smart Agenda
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const firstOfMonth = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth(), 1);
        const startDate = firstOfMonth < tomorrow ? tomorrow : firstOfMonth;

        // End date: last day of current month OR 30 days from start (whichever is later)
        const lastDayOfMonth = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth() + 1, 0);
        const thirtyDaysOut = new Date(startDate);
        thirtyDaysOut.setDate(startDate.getDate() + 30);
        const endDate = lastDayOfMonth > startDate ? lastDayOfMonth : thirtyDaysOut;

        loadAvailability(startDate, endDate).then(() => {
          generateCalendar();
        });
      } else {
        generateCalendar();
      }
    });

    // Update booking state when center is selected
    document.getElementById('center-select').addEventListener('change', async (e) => {
      bookingState.selectedCenter = e.target.value;
      console.log('Selected center:', bookingState.selectedCenter);

      // Show visual feedback
      updateStepIndicators();

      // Reset selection
      bookingState.selectedDate = null;
      bookingState.selectedTime = null;
      bookingState.selectedAppointmentType = null;

      if (bookingState.selectedCenter) {
        // Load appointment types for this center
        await loadAppointmentTypes(bookingState.selectedCenter);

        // Show booking type selector and populate it
        populateBookingTypeDropdown(bookingState.appointmentTypes);

        // Load availability for current month
        const startDate = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth(), 1);
        const endDate = new Date(bookingState.currentMonth.getFullYear(), bookingState.currentMonth.getMonth() + 1, 0);
        await loadAvailability(startDate, endDate);
      } else {
        // Hide booking type selector if no center selected
        document.getElementById('step-1b').classList.add('hidden');
        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('step-3').classList.add('hidden');
        document.getElementById('step-4').classList.add('hidden');
      }

      generateCalendar();
      generateTimeSlots();
    });

    /**
     * Strip HTML tags from text
     */
    function stripHTML(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || '';
    }

    // Populate booking type dropdown
    function populateBookingTypeDropdown(types) {
      const select = document.getElementById('booking-type-select');
      const step1b = document.getElementById('step-1b');

      // Clear existing options except the first one
      select.innerHTML = '<option value="">Seleccione el tipo de sesi√≥n...</option>';

      if (types && types.length > 0) {
        // Show ALL appointment types (no filtering)
        // Types will auto-hide if deleted from Smart Agenda backend
        const centerPaymentTypes = types;

        if (centerPaymentTypes.length === 0) {
          console.warn('No appointment types available');
          step1b.classList.add('hidden');
          return;
        }

        // Add types to dropdown
        centerPaymentTypes.forEach(type => {
          const option = document.createElement('option');
          option.value = type.id;
          option.textContent = type.name;
          option.dataset.price = type.price !== undefined ? type.price : '190';  // Handle 0 correctly
          option.dataset.duration = type.duration || '30';

          // Strip HTML from description
          const cleanDescription = stripHTML(type.description || '').trim();
          option.dataset.description = cleanDescription || 'Pago en el centro';

          select.appendChild(option);
        });

        // Show the booking type section
        step1b.classList.remove('hidden');

        // ‚úÖ AUTO-SELECT FIRST APPOINTMENT TYPE
        // Automatically select the first type and trigger change event
        // This loads availability and shows calendar without requiring manual selection
        if (centerPaymentTypes.length > 0) {
          select.value = centerPaymentTypes[0].id;
          select.dispatchEvent(new Event('change'));
          console.log('‚úÖ Auto-selected first appointment type:', centerPaymentTypes[0].name);
        }
      } else {
        // Hide the booking type section if no types available
        step1b.classList.add('hidden');
      }
    }

    // Handle booking type selection
    document.getElementById('booking-type-select').addEventListener('change', (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      bookingState.selectedAppointmentType = e.target.value;

      const infoBox = document.getElementById('booking-type-info');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const step4 = document.getElementById('step-4');

      if (bookingState.selectedAppointmentType) {
        // Show type details
        const duration = selectedOption.dataset.duration || '30';
        const price = selectedOption.dataset.price || '190';
        const description = selectedOption.dataset.description || '-';

        document.getElementById('type-duration').textContent = `${duration} minutos`;
        document.getElementById('type-price').textContent = `‚Ç¨${price}`;
        document.getElementById('type-description').textContent = description;

        // Check if this is a Rechute (free) session
        const typeName = selectedOption.textContent.toLowerCase();
        const isRechute = price === '0' || typeName.includes('rechute') || typeName.includes('reca√≠da');

        // Remove any existing disclaimer
        const existingDisclaimer = infoBox.querySelector('.rechute-disclaimer');
        if (existingDisclaimer) {
          existingDisclaimer.remove();
        }

        // Add Rechute disclaimer if applicable
        if (isRechute) {
          const disclaimer = document.createElement('div');
          disclaimer.className = 'rechute-disclaimer mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 rounded';
          disclaimer.innerHTML = `
            <div class="flex items-start gap-3">
              <span class="material-icons text-yellow-600 text-xl">warning</span>
              <div>
                <p class="font-semibold text-yellow-800 dark:text-yellow-200">‚ö†Ô∏è Sesi√≥n de Reca√≠da</p>
                <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">
                  Su elegibilidad ser√° verificada para confirmar que ya complet√≥ una sesi√≥n previa con LaserOstop.
                </p>
              </div>
            </div>
          `;
          infoBox.appendChild(disclaimer);

          // Store flag to prevent payment popup later
          bookingState.isRechuteSession = true;
        } else {
          bookingState.isRechuteSession = false;
        }

        infoBox.classList.remove('hidden');

        // Show next steps
        step2.classList.remove('hidden');
        step3.classList.remove('hidden');
        step4.classList.remove('hidden');

        // Update step indicators
        updateStepIndicators();

        // Load availability for next 3 months when appointment type is selected
        // Start from tomorrow to avoid timezone issues with Smart Agenda
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const startDate = new Date(tomorrow);

        // End date: 3 months from tomorrow (90 days)
        const threeMonthsOut = new Date(startDate);
        threeMonthsOut.setDate(startDate.getDate() + 90);
        const endDate = threeMonthsOut;

        console.log(`üìÖ Loading availability for 3 months: ${formatDateForAPI(startDate)} to ${formatDateForAPI(endDate)}`);

        loadAvailability(startDate, endDate).then(() => {
          generateCalendar(); // Refresh calendar with availability data
          autoSelectSoonestSlot(); // Auto-select the soonest available slot across all 3 months
        });

        // Auto-scroll to calendar section for better UX - DISABLED
        // setTimeout(() => {
        //   document.getElementById('step-2').scrollIntoView({
        //     behavior: 'smooth',
        //     block: 'start'
        //   });
        // }, 300);

        console.log('Selected appointment type:', bookingState.selectedAppointmentType);
      } else {
        // Hide type details and next steps
        infoBox.classList.add('hidden');
        step2.classList.add('hidden');
        step3.classList.add('hidden');
        step4.classList.add('hidden');
      }
    });

    // Update step completion indicators
    function updateStepIndicators() {
      const step1 = document.querySelector('#step-1 h2');
      const step1b = document.querySelector('#step-1b h2');
      const step2 = document.querySelector('#step-2 h2');
      const step3 = document.querySelector('#step-3 h2');

      // Step 1: Center selected
      if (bookingState.selectedCenter) {
        if (!step1.querySelector('.material-icons.text-green-500')) {
          step1.innerHTML = '<span class="text-primary mr-3">1.</span>Elija su centro <span class="material-icons text-green-500 align-middle ml-2">check_circle</span>';
        }
      } else {
        step1.innerHTML = '<span class="text-primary mr-3">1.</span>Elija su centro';
      }

      // Step 1b (2): Booking type selected
      if (step1b) {
        if (bookingState.selectedAppointmentType) {
          if (!step1b.querySelector('.material-icons.text-green-500')) {
            step1b.innerHTML = '<span class="text-primary mr-3">2.</span>Tipo de sesi√≥n <span class="material-icons text-green-500 align-middle ml-2">check_circle</span>';
          }
        } else {
          step1b.innerHTML = '<span class="text-primary mr-3">2.</span>Tipo de sesi√≥n';
        }
      }

      // Step 2 (now 3): Date and time selected
      if (step2) {
        if (bookingState.selectedDate && bookingState.selectedTime) {
          if (!step2.querySelector('.material-icons.text-green-500')) {
            step2.innerHTML = '<span class="text-primary mr-3">3.</span>Elija una fecha y una hora <span class="material-icons text-green-500 align-middle ml-2">check_circle</span>';
          }
        } else {
          step2.innerHTML = '<span class="text-primary mr-3">3.</span>Elija una fecha y una hora';
        }
      }
    }

    // Initialize calendar on load
    function initializeCalendar() {
      generateCalendar();
      generateTimeSlots();
    }

    // URL slug to center ID mapping (PROD pdo_agenda IDs)
    const CENTER_URL_MAPPING = {
      'barcelona-sants': '43',       // Barcelona Sants
      'barcelona': '43',             // Barcelona (alias)
      'valencia': '10',              // Valencia
      'madrid-atocha': '50',         // Madrid Atocha
      'madrid-chamartin': '48',      // Madrid Chamart√≠n
      'sevilla': '44',               // Sevilla
      'majadahonda': '51',           // Majadahonda
      'san-sebastian': '52',         // San Sebasti√°n de Los Reyes
      'torrejon': '49'               // Torrej√≥n de Ardoz
    };

    /**
     * Detect center from URL path
     */
    function getCenterFromURL() {
      const path = window.location.pathname;
      const segments = path.split('/').filter(p => p);

      // For /laserostop_espagna/valencia -> segments = ['laserostop_espagna', 'valencia']
      // We want the second segment (index 1)
      const slug = segments.length > 1 ? segments[1] : null;

      const centerId = slug ? CENTER_URL_MAPPING[slug] : null;

      if (centerId) {
        console.log('üìç Detected center from URL:', slug, '‚Üí Center ID:', centerId);
      } else if (slug) {
        console.log('üìç URL slug detected but not in mapping:', slug);
      }

      return centerId || null;
    }

    /**
     * Auto-select center if URL contains center slug
     */
    async function autoSelectCenterFromURL() {
      const centerId = getCenterFromURL();

      if (centerId) {
        // Wait for centers to be loaded
        if (bookingState.smartAgendaCenters.length === 0) {
          console.log('‚è≥ Waiting for centers to load before auto-selecting...');
          return centerId; // Return for later use
        }

        // Check if this center exists
        const centerExists = bookingState.smartAgendaCenters.find(c => c.id === centerId);

        if (centerExists) {
          console.log('‚úÖ Auto-selecting center:', centerExists.name);

          // Set the dropdown value
          const select = document.getElementById('center-select');
          select.value = centerId;

          // Trigger the change event to load appointment types
          select.dispatchEvent(new Event('change'));

          // Scroll to booking section
          setTimeout(() => {
            document.getElementById('booking').scrollIntoView({ behavior: 'smooth' });
          }, 500);
        } else {
          console.warn('‚ö†Ô∏è Center ID from URL not found in Smart Agenda:', centerId);
        }
      }
    }

    // Initialize everything on load
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('LaserOstop Barcelona - Initializing...');

      // Initialize map
      initializeMap();

      // Initialize calendar
      initializeCalendar();

      // Load centers from Smart Agenda API
      await loadCentersFromAPI();

      // Auto-select Valencia center by triggering the hidden dropdown change event
      // This triggers the full flow: load types -> populate dropdown -> auto-select first type
      const centerSelect = document.getElementById('center-select');
      centerSelect.value = '43'; // Barcelona center ID
      centerSelect.dispatchEvent(new Event('change'));
      console.log('üìç Auto-selected center: Barcelona (ID: 43)');

      // Show promotional popup after initialization
      // showPromoPopup(); // Disabled for now

      console.log('Initialization complete!');
    });

    // ========== TOUCH-RESPONSIVE CAROUSEL (MOBILE ONLY) ==========

    /**
     * Add touch controls for review carousels on mobile
     * Row 1 and Row 2 move in opposite directions at same speed
     */
    document.addEventListener('DOMContentLoaded', function() {
      // Only enable on touch devices (mobile/tablet)
      if (!('ontouchstart' in window)) {
        console.log('Touch carousel disabled - not a touch device');
        return;
      }

      const row1Track = document.querySelector('.carousel-row-1 .carousel-track');
      const row2Track = document.querySelector('.carousel-row-2 .carousel-track');
      const row1Container = document.querySelector('.carousel-row-1');
      const row2Container = document.querySelector('.carousel-row-2');

      if (!row1Track || !row2Track || !row1Container || !row2Container) {
        console.log('Touch carousel disabled - elements not found');
        return;
      }

      let touchStartX = 0;
      let touchStartY = 0;
      let row1StartTranslate = 0;
      let row2StartTranslate = 0;
      let isTouching = false;

      function getTranslateX(element) {
        const style = window.getComputedStyle(element);
        const matrix = new DOMMatrixReadOnly(style.transform);
        return matrix.m41;
      }

      function handleTouchStart(e) {
        isTouching = true;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;

        // Pause animations
        row1Track.style.animationPlayState = 'paused';
        row2Track.style.animationPlayState = 'paused';

        // Get current positions
        row1StartTranslate = getTranslateX(row1Track);
        row2StartTranslate = getTranslateX(row2Track);

        console.log('Touch start at', touchStartX);
      }

      function handleTouchMove(e) {
        if (!isTouching) return;

        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;
        const deltaX = touchX - touchStartX;
        const deltaY = touchY - touchStartY;

        // Only handle horizontal swipes (prevent vertical scroll interference)
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
          e.preventDefault();

          // Row 1 moves with finger
          // Row 2 moves opposite direction
          row1Track.style.transform = `translateX(${row1StartTranslate + deltaX}px)`;
          row2Track.style.transform = `translateX(${row2StartTranslate - deltaX}px)`;
        }
      }

      function handleTouchEnd() {
        if (!isTouching) return;
        isTouching = false;

        console.log('Touch end');

        // Resume animations after brief delay
        setTimeout(() => {
          row1Track.style.animationPlayState = 'running';
          row2Track.style.animationPlayState = 'running';
        }, 300);
      }

      // Add event listeners to both carousel containers
      [row1Container, row2Container].forEach(container => {
        container.addEventListener('touchstart', handleTouchStart, { passive: true });
        container.addEventListener('touchmove', handleTouchMove, { passive: false });
        container.addEventListener('touchend', handleTouchEnd, { passive: true });
        container.addEventListener('touchcancel', handleTouchEnd, { passive: true });
      });

      console.log('‚úÖ Touch carousel controls initialized');
    });

    // ========== HERO CTA BUTTON SCROLL ==========

    /**
     * Smooth scroll to booking section when hero CTA button is clicked
     */
    document.addEventListener('DOMContentLoaded', function() {
      const heroCtaBtn = document.getElementById('hero-cta-btn');
      const bookingSection = document.getElementById('booking');

      if (heroCtaBtn && bookingSection) {
        heroCtaBtn.addEventListener('click', function() {
          bookingSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        });
        console.log('‚úÖ Hero CTA button scroll initialized');
      }
    });

    // Video audio toggle function
    function toggleVideoAudio(container) {
      const video = container.querySelector('video');
      const icon = container.querySelector('.audio-icon');
      const hint = container.querySelector('.audio-hint');

      if (video.muted) {
        video.muted = false;
        icon.textContent = 'volume_up';
        if (hint) {
          hint.style.opacity = '0';
          setTimeout(() => hint.style.display = 'none', 300);
        }
      } else {
        video.muted = true;
        icon.textContent = 'volume_off';
      }
    }

    // Navigation - Mobile Menu Toggle
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      const mobileMenuIcon = mobileMenuButton.querySelector('.material-icons');

      // Toggle mobile menu
      mobileMenuButton.addEventListener('click', function() {
        mobileMenu.classList.toggle('hidden');
        // Toggle icon between menu and close
        if (mobileMenu.classList.contains('hidden')) {
          mobileMenuIcon.textContent = 'menu';
        } else {
          mobileMenuIcon.textContent = 'close';
        }
      });

      // Close mobile menu when clicking a link
      const mobileLinks = document.querySelectorAll('.mobile-link');
      mobileLinks.forEach(link => {
        link.addEventListener('click', function() {
          mobileMenu.classList.add('hidden');
          mobileMenuIcon.textContent = 'menu';
        });
      });

      // Smooth scroll for all navigation links
      const smoothScrollLinks = document.querySelectorAll('.smooth-scroll');
      smoothScrollLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const targetId = this.getAttribute('href');
          const targetSection = document.querySelector(targetId);

          if (targetSection) {
            const navbarHeight = document.getElementById('navbar').offsetHeight;
            const targetPosition = targetSection.offsetTop - navbarHeight;

            window.scrollTo({
              top: targetPosition,
              behavior: 'smooth'
            });
          }
        });
      });

      // Add scroll effect to navbar (shrink on scroll)
      let lastScroll = 0;
      window.addEventListener('scroll', function() {
        const navbar = document.getElementById('navbar');
        const currentScroll = window.pageYOffset;

        if (currentScroll > 100) {
          navbar.classList.add('shadow-lg');
        } else {
          navbar.classList.remove('shadow-lg');
        }

        lastScroll = currentScroll;
      });
    });
  </script>

</body>
</html>
<!-- Force rebuild at Fri Oct 17 09:03:49 CET 2025 -->
